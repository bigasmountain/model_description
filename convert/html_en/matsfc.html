<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>MIROC-DOC matsfc</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="github-markdown.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->

<link rel="stylesheet" href="github.css">
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    menuSettings: {locale: "ja"},
    extensions: ["tex2jax.js", "MathMenu.js", "MathZoom.js"],
    TeX: {
      extensions: ["AMSmath.js", "AMSsymbols.js", "noErrors.js", "noUndefined.js"],
      noErrors: {disabled: true},
      noUndefined: {disabled: true}
    },
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [["$","$"] ],
      displayMath: [["$$","$$"]],
      processEscapes: true
    }
  });
</script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script>
</head>
<body>
<header id="title-block-header">
<h1 class="title">MIROC-DOC matsfc</h1>
</header>
<h1 id="boundary-value-submodel-matbnd">Boundary Value Submodel MATBND</h1>
<h2 id="set-of-vegetation-shape-parameters.">Set of vegetation shape parameters.</h2>
<p>The leaf area index (LAI) and vegetation height are set as vegetation shape parameters.</p>
<p>The LAI reads the seasonally varying horizontal distributions, and the top and bottom canopy heights are determined by land use type as external parameters. If there is snowfall, the LAI considers only the vegetation above the snow depth and corrects the geometry parameters.</p>
<p><span class="math display">$$
 h = \max( h_0 - D_{Sn}, 0 ) \\
 h_B = \max( h_{B0} - D_{Sn}, 0 ) \\
 LAI = LAI_0 \frac{h-h_B}{h_0-h_{B0}}
$$</span></p>
<p>Here, <span class="math inline"><em>h</em></span> is the height at the top of the canopy (vegetation height), <span class="math inline"><em>h</em><sub><em>B</em></sub></span> is the height at the bottom of the canopy (dead height), <span class="math inline"><em>L</em><em>A</em><em>I</em></span> is the leaf area index, and <span class="math inline"><em>h</em><sub>0</sub></span>, <span class="math inline"><em>h</em><sub><em>B</em>0</sub></span>, and <span class="math inline"><em>L</em><em>A</em><em>I</em><sub>0</sub></span> are the values without snow, respectively. <span class="math inline"><em>D</em><sub><em>S</em><em>n</em></sub></span> is the snow cover depth. It is assumed that the LAI is uniformly distributed vertically between the top and bottom edges of the canopy.</p>
<p>Afterwards, the average of snow-free and snow-covered surfaces weighted by the snow area ratio (<span class="math inline"><em>A</em><sub><em>S</em><em>n</em></sub></span>) is calculated, but since the snow-free surface and the snow-covered surface are calculated separately, <span class="math inline"><em>A</em><sub><em>S</em><em>n</em></sub></span> requires either <span class="math inline">0</span> (snow-free surface) or <span class="math inline">1</span> (snow-covered surface). Note that it contains either of the values of the (surface), and mixing of values does not occur here (there are several similar locations later).</p>
<h2 id="calculating-radiant-parameters.">Calculating radiant parameters.</h2>
<p>Calculation of radiative parameters (albedo, vegetation permeability, etc.).</p>
<h3 id="calculation-of-surface-forest-floor-albedo">Calculation of surface (forest floor) albedo</h3>
<p>The horizontal distribution of the ground (forest floor) albedo <span class="math inline"><em>α</em><sub>0(<em>b</em>)</sub>  (<em>b</em> = 1, 2)</span> is read as an external parameter. <span class="math inline"><em>b</em> = 1, 2</span> represent the visible and near-infrared wavelengths, respectively. The <span class="math inline"><em>α</em><sub>0(3)</sub></span> value of the infrared surface albedo (<span class="math inline"><em>α</em><sub>0(3)</sub></span>) is set to a fixed value (horizontal distribution may be prepared).</p>
<p>The dependence of the incident angle of albedo on ice and snow cover is considered as a function of the angle of incidence as follows</p>
<p><span class="math display"><em>α</em><sub>0(<em>d</em>, <em>b</em>)</sub> = <em>α̂</em><sub>0(<em>b</em>)</sub> + (1 − <em>α̂</em><sub>0(<em>b</em>)</sub>) ⋅ 0.4(1 − cos <em>ϕ</em><sub><em>i</em><em>n</em>(<em>d</em>)</sub>)<sup>5</sup></span></p>
<p>where <span class="math inline"><em>b</em> = 1, 2</span> are wavelengths, <span class="math inline"><em>d</em> = 1, 2</span> are direct and scattered, respectively, and <span class="math inline"><em>α̂</em><sub>0(<em>b</em>)</sub></span> is an albedo value for a direct angle of incidence of <span class="math inline">0</span> (from directly above). <span class="math inline">cos <em>ψ</em><sub><em>i</em><em>n</em>(<em>d</em>)</sub></span> is the cosine of the incident angle of incidence for direct and scattered light, respectively,</p>
<p><span class="math display">cos <em>ψ</em><sub><em>i</em><em>n</em>(1)</sub> = cos <em>ζ</em>,   cos <em>ψ</em><sub><em>i</em><em>n</em>(2)</sub> = cos 50<sup>∘</sup></span></p>
<p>We give the <span class="math inline"><em>ζ</em></span> is the solar zenith angle.</p>
<p>Except for the ice and snow cover surfaces, the albedo of the ground (forest floor) gives the same values for direct and diffuse light, without considering the dependence on the zenith angle. In other words, the results are as follows.</p>
<p><span class="math display"><em>α</em><sub>0(<em>d</em>, <em>b</em>)</sub> = <em>α</em><sub>0(<em>b</em>)</sub>   (<em>d</em> = 1, 2; <em>b</em> = 1, 2)</span></p>
<p>For infrared wavelengths, we only need to consider the scattered light. The infrared albedo gives a value that is independent of the zenith angle for all surfaces.</p>
<p><span class="math display"><em>α</em><sub>0(2, 3)</sub> = <em>α</em><sub>0(3)</sub></span></p>
<h3 id="canopy-albedo-and-transmittance-calculations">Canopy albedo and transmittance calculations</h3>
<p>The calculation of albedo and transmittance of the canopy is based on the radiation calculation in the canopy layer by Watanabe and Otani (1995).</p>
<p>Considering a vertically uniform canopy and making some simplifying assumptions, the transfer equation and boundary conditions for the insolation within the canopy are expressed as follows</p>
<p><span class="math display">$$
 \frac{dS^{\downarrow}_d}{dL} = -F \sec\zeta S^{\downarrow}_d \\
 \frac{dS^{\downarrow}_r}{dL} = -F (1-t_{f(b)})d_f S^{\downarrow}_r
                                  +F t_{f(b)} \sec\zeta S^{\downarrow}_d
                                  +F r_{f(b)} d_f S^{\uparrow}_r \\
 \frac{dS^{\uparrow}_r}{dL}   =  F (1-t_{f(b)})d_f S^{\uparrow}_r
                                  -F r_{f(b)} ( d_f S^{\downarrow}_r
                                         + \sec\zeta S^{\downarrow}_d ) \\
 S^{\downarrow}_d(0) = S^{top}_d \\
 S^{\downarrow}_r(0) = S^{top}_r \\
 S^{\uparrow}_r(LAI) = \alpha_{0(1,b)}S^{\downarrow}_d(LAI)
                       + \alpha_{0(2,b)}S^{\downarrow}_r(LAI)
$$</span></p>
<p>where <span class="math inline"><em>S</em><sub><em>d</em></sub><sup>↓</sup></span> is direct downward light, <span class="math inline"><em>S</em><sub><em>r</em></sub><sup>↑</sup></span> and <span class="math inline"><em>S</em><sub><em>r</em></sub><sup>↓</sup></span> are upward and downward scattered light, respectively, <span class="math inline"><em>L</em></span> is the leaf area accumulated from the top of the canopy downward, <span class="math inline"><em>d</em><sub><em>f</em></sub></span> is the scatter factor (<span class="math inline"> = sec 53<sup>∘</sup></span>), <span class="math inline"><em>r</em><sub><em>f</em>(<em>b</em>)</sub></span> and <span class="math inline"><em>t</em><sub><em>f</em>(<em>b</em>)</sub></span> is the reflection coefficient and transmission coefficient of the leaf surface (the same values are used for scattered light and direct light), respectively, and <span class="math inline"><em>F</em></span> is a factor indicating the orientation of the leaf relative to radiation. For simplicity, we assume that the distribution of leaf orientation is random (<span class="math inline"><em>F</em> = 0.5</span>).</p>
<p>These can be solved analytically and the solution is as follows.</p>
<p><span class="math display">$$
 S^{\downarrow}_d(L) = S^{top}_d \exp(-F\cdot L\cdot \sec\zeta) \\
 S^{\downarrow}_r(L) = C_1 e^{a L} + C_2 e^{-a L} + C_3 S^{\downarrow}_d(L) \\
 S^{\uparrow}_r(L)   = A_1 C_1 e^{a L} + A_2 C_2 e^{-a L} + C_4 S^{\downarrow}_d(L)
$$</span></p>
<p>Here,</p>
<p><span class="math display">$$
   a = F d_f [(1-t_{f(b)})^2 - r_{f(b)}^2]^{1/2}  \\
 A_1 = \{ 1 - t_{f(b)} + [(1-t_{f(b)})^2 - r_{f(b)}^2]^{1/2}\} / r_{f(b)} \\
 A_2 = \{ 1 - t_{f(b)} - [(1-t_{f(b)})^2 - r_{f(b)}^2]^{1/2}\} / r_{f(b)} \\
 A_3 = (A_1 - \alpha_{0(2,b)}) e^{ a LAI }
        -(A_2 - \alpha_{0(2,b)}) e^{-a LAI } \\
 C_1 = \{ -(A_2 - \alpha_{0(2,b)}) e^{-a LAI} (S^{top}_r - C_3 S^{top}_d)
            +[C_3\alpha_{0(2,b)}+\alpha_{0(1,b)}-C_4]S^{\downarrow}_d(LAI)\} / A_3 \\
 C_2 = \{  (A_1 - \alpha_{0(2,b)}) e^{ a LAI} (S^{top}_r - C_3 S^{top}_d)
            -[C_3\alpha_{0(2,b)}+\alpha_{0(1,b)}-C_4]S^{\downarrow}_d(LAI)\} / A_3 \\
 C_3 = \frac{\sec\zeta[t_{f(b)}\sec\zeta + d_f t_{f(b)}(1-t_{f(b)}) + d_f r_{f(b)}^2]}
              {d_f^2[(1-t_{f(b)})^2-r_{f(b)}^2]-\sec^2\zeta} \\
 C_4 = \frac{r_{f(b)}(d_f - \sec\zeta)\sec\zeta}
              {d_f^2[(1-t_{f(b)})^2-r_{f(b)}^2]-\sec^2\zeta}
$$</span></p>
<p>It is.</p>
<p>The Albedo <span class="math inline"><em>α</em><sub><em>s</em></sub></span> seen at the top of the canopy,</p>
<p><span class="math display"><em>S</em><sub><em>r</em></sub><sup>↑</sup>(0) = <em>α</em><sub><em>s</em>(1, <em>b</em>)</sub><em>S</em><sub><em>d</em></sub><sup>↓</sup>(0) + <em>α</em><sub><em>s</em>(2, <em>b</em>)</sub><em>S</em><sub><em>r</em></sub><sup>↓</sup>(0)</span></p>
<p>So,</p>
<p><span class="math display">$$
 \alpha_{s(2,b)} = \{ A_2 ( A_1 - \alpha_{0(2,b)}) e^{ a LAI }
                      - A_1 ( A_2 - \alpha_{0(2,b)}) e^{-a LAI }
                   \} / A_3 \\
 \alpha_{s(1,b)} = - C_3 \alpha_{s(2,b)} + C_4
                  + ( A_1 - A_2 ) ( C_3 \alpha_{0(2,b)} + \alpha_{0(1,b)} -C_4)
                  e^{- F\cdot LAI\cdot \sec\zeta} / A_3
$$</span></p>
<p>Get.</p>
<p>The transmission coefficient of the canopy (<span class="math inline">𝒯<sub><em>c</em></sub></span>), or more precisely, the percentage of the incident light absorbed by the forest floor at the top of the canopy, is</p>
<p><span class="math display"><em>S</em><sub><em>d</em></sub><sup>↓</sup>(<em>L</em><em>A</em><em>I</em>) + <em>S</em><sub><em>r</em></sub><sup>↓</sup>(<em>L</em><em>A</em><em>I</em>) − <em>S</em><sub><em>r</em></sub><sup>↑</sup>(<em>L</em><em>A</em><em>I</em>) = 𝒯<sub><em>c</em>(1, <em>b</em>)</sub><em>S</em><sub><em>d</em></sub><sup>↓</sup>(0) + 𝒯<sub><em>c</em>(2, <em>b</em>)</sub><em>S</em><sub><em>r</em></sub><sup>↓</sup>(0)</span></p>
<p>Defined by ,</p>
<p><span class="math display">$$
  {\mathcal{T}}_{c(2,b)}= \{ ( 1 - A_2 )( A_1 - \alpha_{0(2,b)} )
                      - ( 1 - A_1 )( A_2 - \alpha_{0(2,b)} ) \} / A_3 \\
 {\mathcal{T}}_{c(1,b)}= - C_3 {\mathcal{T}}_{c(2,b)}  \\
 +               \{ ( C_3 \alpha_{0(2,b)} + \alpha_{0(1,b)} -C_4 )
                   ( ( 1 - A_1 ) e^{ a LAI }
                   - ( 1 - A_2 ) e^{-a LAI } )  / A_3
                   + C_3 - C_4 +1 \} e^{- F\cdot LAI\cdot \sec\zeta}
 \\
$$</span></p>
<p>The above is performed for <span class="math inline"><em>b</em> = 1, 2</span> (visible and near-infrared), respectively. The above procedure is performed for <span class="math inline"><em>b</em> = 1, 2</span> (visible and near-infrared), respectively.</p>
<p>The reflectance <span class="math inline"><em>r</em><sub><em>f</em></sub></span> and transmission <span class="math inline"><em>t</em><sub><em>f</em></sub></span> are read as external parameters for each land cover type, but before they are used in the above calculations, the following two modifications are made.</p>
<ol type="1">
<li>the effect of snow (ice) on the leaves When the canopy temperature is less than 0 <span class="math inline"><sup>∘</sup></span> C, the water above the canopy is regarded as snow (ice). In this case, the snow albedo (<span class="math inline"><em>α</em><sub><em>S</em><em>n</em>(<em>b</em>)</sub></span>) and the water content in the canopy (<span class="math inline"><em>w</em><sub><em>c</em></sub></span>) are used to determine the snow (ice),</li>
</ol>
<p><span class="math display">$$
 r_{f(b)} = ( 1 - f_{cwet} ) r_{f(b)}
         + f_{cwet} \alpha_{Sn(b)} \\
  f_{cwet} = {w_c}/w_{c,cap}
$$</span></p>
<p>The following table shows the volume of water on the canopy. <span class="math inline"><em>w</em><sub><em>c</em>, <em>c</em><em>a</em><em>p</em></sub></span> is the water content in the canopy. The transmittance is given in the following formula for convenience to avoid negative absorption (<span class="math inline">1 − <em>r</em><sub><em>f</em></sub> − <em>t</em><sub><em>f</em></sub></span>), i.e.</p>
<p><span class="math display"><em>t</em><sub><em>f</em>(<em>b</em>)</sub> = (1 − <em>f</em><sub><em>c</em><em>w</em><em>e</em><em>t</em></sub>)<em>t</em><sub><em>f</em>(<em>b</em>)</sub> + <em>f</em><sub><em>c</em><em>w</em><em>e</em><em>t</em></sub><em>t</em><sub><em>S</em><em>n</em>(<em>b</em>)</sub>,   <em>t</em><sub><em>S</em><em>n</em>(<em>b</em>)</sub> = min (0.5(1 − <em>α</em><sub><em>S</em><em>n</em>(<em>b</em>)</sub>), <em>t</em><sub><em>f</em>(<em>b</em>)</sub>)</span></p>
<p>When the water on the canopy is liquid, we should ignore the change in the radiative parameters of the leaf surface. When the liquid water on the canopy is liquid, changes in the radiative parameters of the leaf surface due to the liquid water on the canopy are ignored. In the case of snowfall trapping by the canopy (snow), and in the case of freezing of the liquid water on the canopy (ice), the same albedo as that of the snow cover on the forest floor is used here, although the radiative characteristics of each case may be different.</p>
<ol start="2" type="1">
<li>the effect of considering the direction of reflection and transmission In the solution of the above equation, it is assumed that all the reflected light returns to the direction of the incident light, but considering that some of it is scattered in the same direction as the incident light, we can replace the radial parameters of the leaf surface with the following (Watanabe, in press).</li>
</ol>
<p><span class="math display">$$
  r_{f(b)} = 0.75 r_{f(b)} + 0.25 t_{f(b)} \\
  t_{f(b)} = 0.75 t_{f(b)} + 0.25 r_{f(b)}
$$</span></p>
<p>The above is done for <span class="math inline"><em>b</em> = 1, 2</span> (visible and near-infrared), respectively.</p>
<p>We also take into account cases where vegetation is unevenly distributed in parts of the grid (e.g., savannahs), prior to the calculation of albedo, etc,</p>
<p><span class="math display"><em>L</em><em>A</em><em>I</em> = <em>L</em><em>A</em><em>I</em>/<em>f</em><sub><em>V</em></sub></span></p>
<p>The LAI of the vegetation cover (the original LAI is considered to be the grid average) is calculated as the LAI of the vegetation cover, which is used in the calculation of the albedo described above. <span class="math inline"><em>f</em><sub><em>V</em></sub></span> is the vegetation coverage of the grid. After the albedo and other data are obtained, the LAI of the grid is calculated by</p>
<p><span class="math display">$$
  \alpha_{s(d,b)} = f_V \alpha_{s(d,b)}
                       + ( 1 - f_V ) \alpha_{0(d,b)} \\
  {\mathcal{T}}_{c(d,b)} = f_V {\mathcal{T}}_{c(d,b)}
                       + ( 1 - f_V ) ( 1 - \alpha_{0(d,b)} )
$$</span></p>
<p>We take the area-weighted average of the vegetation-covered and non-vegetation-covered portions, as</p>
<h3 id="calculations-such-as-surface-radiation-flux">Calculations such as surface radiation flux</h3>
<p>Using the downward radiation flux (<span class="math inline"><em>R</em><sub>(<em>d</em>, <em>b</em>)</sub><sup>↓</sup></span>) and the albedo obtained above, the following radiation fluxes are obtained.</p>
<p><span class="math display">$$
 R^{\downarrow}_S = \sum_{b=1}^2\sum_{d=1}^2 R^{\downarrow}_{(d,b)} \\
 R^{\uparrow}_S = \sum_{b=1}^2\sum_{d=1}^2 \alpha_{s(d,b)} R^{\downarrow}_{(d,b)} \\
 R^{\downarrow}_L = R^{\downarrow}_{(2,3)} \\
 R^{gnd}_S = \sum_{b=1}^2\sum_{d=1}^2 {\mathcal{T}}_{s(d,b)} R^{\downarrow}_{(d,b)} \\
 PAR = \sum_{d=1}^2 R^{\downarrow}_{(d,1)}
$$</span></p>
<p><span class="math inline"><em>R</em><sub><em>S</em></sub><sup>↓</sup></span> and <span class="math inline"><em>R</em><sub><em>S</em></sub><sup>↑</sup></span> represent the downward and upward shortwave radiation fluxes, <span class="math inline"><em>R</em><sub><em>L</em></sub><sup>↓</sup></span> represents the downward longwave radiation flux, <span class="math inline"><em>R</em><sub><em>S</em></sub><sup><em>g</em><em>n</em><em>d</em></sup></span> represents the shortwave radiation flux absorbed by the forest floor, and <span class="math inline"><em>P</em><em>A</em><em>R</em></span> represents the downward Photosynthetically Active Radiation (PAR) flux .</p>
<p>The canopy transmittance of the shortwave and longwave canopies and the longwave emission coefficient are obtained as follows.</p>
<p><span class="math display">$$
 {\mathcal{T}}_{cS} = R^{gnd}_S / ( R^{\downarrow}_S - R^{\uparrow}_S ) \\
 {\mathcal{T}}_{cL} = \exp( - F \cdot LAI \cdot d_f ) \\
 \epsilon = 1 - \alpha_{s(2,3)}
$$</span></p>
<h2 id="calculation-of-turbulent-parameters-bulk-coefficients.">Calculation of turbulent parameters (bulk coefficients).</h2>
<p>Calculate the turbulence parameters (bulk coefficient).</p>
<h3 id="roughness-calculations-for-momentum-and-heat.">roughness calculations for momentum and heat.</h3>
<p>The calculation of roughness is based on Watanabe (1994). Using the results of Kondo and Watanabe’s (1992) multi-layered canopy model, Watanabe (1994) proposed the following roughness functions for the bulk model that best fit the results.</p>
<p><span class="math display">$$
 \left(\ln \frac{h-d}{z_0}\right)^{-1} =
 \left[ 1 - \exp( -A^+) + \left(-\ln \frac{z_{0s}}{h}\right)^{-1/0.45}
  \exp(-2A^+)\right]^{0.45} \\
 \left(\ln \frac{h-d}{z_T^{\dagger}}\right)^{-1} =
 \frac{1}{-\ln(z_{Ts}/h)} \left[ \frac{P_1}{P_1 + A^+ \exp({A^+})}\right] ^{P2} \\
 \left(\ln \frac{h-d}{z_0}\right)^{-1} \left(\ln \frac{h-d}{z_T}\right)^{-1}
 = C_T^{\infty} \left[1-\exp(-P_3 A^+)
  + \left(\frac{C_T^0}{C_T^{\infty}}\right)^{1/0.9} \exp(-P_4 A^+)\right]^{0.9} \\
 h-d = h [1-\exp(-A^+)] / {A^+} \\
 A^+ = \frac{c_d LAI}{2k^2} \\
 \frac1{C_T^0} = \ln \frac{h-d}{z_0} \ln \frac{h-d}{z_T^{\dagger}} \\
 C_T^{\infty} = \frac{-1+(1+8F_T)^{1/2}}{2} \\
 P_1 = 0.0115 \left(\frac{z_{Ts}}{h}\right)^{0.1}
  \exp\left[5 \left(\frac{z_{Ts}}{h}\right)^{0.22}\right] \\
 P_2 = 0.55 \exp\left[-0.58 \left(\frac{z_{Ts}}{h}\right)^{0.35}\right] \\
 P_3 = [F_T + 0.084 \exp(-15 F_T)]^{0.15} \\
 P_4 = 2 F_T^{1.1} \\
 F_T = c_h / c_d
$$</span></p>
<p>where <span class="math inline"><em>z</em><sub>0</sub></span> and <span class="math inline"><em>z</em><sub><em>T</em></sub></span> are the roughness of the entire canopy with respect to momentum and heat, respectively, <span class="math inline"><em>z</em><sub>0</sub><em>s</em></span> and <span class="math inline"><em>z</em><sub><em>T</em></sub><em>s</em></span> are the roughness of the ground surface (forest floor) with respect to momentum and heat, respectively, <span class="math inline"><em>c</em><sub><em>d</em></sub></span> and <span class="math inline"><em>c</em><sub><em>h</em></sub></span> are the roughness of the ground surface with respect to momentum and heat, respectively <span class="math inline"><em>h</em></span> is the vegetation height, <span class="math inline"><em>d</em></span> is the zero-plane displacement, and <span class="math inline"><em>L</em><em>A</em><em>I</em></span> is the LAI for the heat transfer coefficient between the individual leaves and the atmosphere for the <span class="math inline"><em>z</em><sub><em>T</em></sub><sup>†</sup></span> is the roughness of the heat flux at the leaf surface under the assumption of no heat flux, and is used to determine the heat transport coefficient from the forest floor.</p>
<p><span class="math inline"><em>z</em><sub>0<em>s</em></sub></span> and <span class="math inline"><em>z</em><sub><em>T</em><em>s</em></sub></span> are given as external data for each land cover type, but the standard values (<span class="math inline"><em>z</em><sub>0<em>s</em></sub> = 0.05</span> m, <span class="math inline"><em>z</em><sub><em>T</em><em>s</em></sub> = 0.005</span> m) are fixed regardless of land cover type. However, for snow cover, the following modifications are made.</p>
<p><span class="math display">$$
 z_{0s} = \max( f_{Sn} z_{0s}, z_{0Sn} ) \\
 z_{Ts} = \max( f_{Sn} z_{0s}, z_{TSn} ) \\
          f_{Sn} = 1 - D_{Sn} / z_{0s}
$$</span></p>
<p>where <span class="math inline"><em>D</em><sub><em>S</em><em>n</em></sub></span>, <span class="math inline"><em>z</em><sub>0<em>S</em><em>n</em></sub></span> and <span class="math inline"><em>z</em><sub><em>T</em><em>S</em><em>n</em></sub></span> are the roughness of the snow surface with respect to momentum and heat, respectively.</p>
<p><span class="math inline"><em>c</em><sub><em>d</em></sub></span> and <span class="math inline"><em>c</em><sub><em>h</em></sub></span> are parameters determined by the shape of the leaves and are given as external data for each land cover type.</p>
<h3 id="calculating-bulk-coefficients-for-momentum-and-heat">Calculating Bulk Coefficients for Momentum and Heat</h3>
<p>The bulk coefficients are also derived following Watanabe (1994), using Monin-Obukhov’s law of similarity, as follows</p>
<p><span class="math display">$$
 C_M = k^2 \left[ \ln \frac{z_a-d}{z_0} + \Psi_m(\zeta) \right]^{-2} \\
 C_H = k^2 \left[ \ln \frac{z_a-d}{z_0} + \Psi_m(\zeta) \right]^{-1}
             \left[ \ln \frac{z_a-d}{z_T} + \Psi_h(\zeta) \right]^{-1} \\
 C_{Hs} = k^2 \left[ \ln \frac{z_a-d}{z_0} + \Psi_m(\zeta_g) \right]^{-1}
             \left[ \ln \frac{z_a-d}{z_T^{\dagger}} + \Psi_h(\zeta_g) \right]^{-1} \\
 C_{Hc} = C_H - C_{Hs}
$$</span></p>
<p>where <span class="math inline"><em>C</em><sub><em>M</em></sub></span> and <span class="math inline"><em>C</em><sub><em>H</em></sub></span> are the bulk coefficient of total canopy (foliage <span class="math inline">+</span> forest floor) for momentum and heat, respectively, <span class="math inline"><em>C</em><sub><em>H</em><em>s</em></sub></span> is the bulk coefficient of surface (forest floor) flux for heat, and <span class="math inline"><em>C</em><sub><em>H</em><em>c</em></sub></span> is the bulk coefficient of canopy (leaf surface) flux for heat. Bulk coefficients, <span class="math inline"><em>Ψ</em><sub><em>m</em></sub></span> and <span class="math inline"><em>Ψ</em><sub><em>h</em></sub></span> are Monin-Obukhov shear functions for momentum and heat, respectively, and <span class="math inline"><em>z</em><sub><em>a</em></sub></span> is the reference altitude of the atmosphere (altitude of the first layer of the atmosphere). <span class="math inline"><em>ζ</em></span> and <span class="math inline"><em>ζ</em><sub><em>g</em></sub></span> are calculated using the Monin-Obukhov length <span class="math inline"><em>L</em></span> and <span class="math inline"><em>L</em><sub><em>g</em></sub></span> for the whole canopy and ground surface (forest floor), respectively,</p>
<p><span class="math display">$$
 \zeta = \frac{z_a - d}{L} \\
 \zeta_g = \frac{z_a - d}{L_g}
$$</span></p>
<p>where the length is denoted by The Monin-Obukhov length is expressed in</p>
<p><span class="math display">$$
 L = \frac{\Theta_0 C_M^{3/2}|V_a|^2}{kg(C_{Hs}(T_s - T_a) + C_{Hc}(T_c - T_a))} \\
 L_s = \frac{\Theta_0 C_M^{3/2}|V_a|^2}{kg C_{Hs}(T_s - T_a)}
$$</span></p>
<p>is expressed in where <span class="math inline"><em>Θ</em><sub>0</sub></span> =300K, <span class="math inline">|<em>V</em><sub><em>a</em></sub>|</span> is the absolute surface wind speed, <span class="math inline"><em>k</em></span> is the Kalman constant, <span class="math inline"><em>g</em></span> is the acceleration due to gravity, <span class="math inline"><em>T</em><sub><em>a</em></sub></span>, <span class="math inline"><em>T</em><sub><em>c</em></sub></span>, and <span class="math inline"><em>T</em><sub><em>s</em></sub></span> are the first atmospheric layer, the canopy (leaf surface) and the ground (forest floor), respectively ) temperature.</p>
<p>Since the bulk coefficients are required for the calculation of the Monin-Obukhov length and the Monin-Obukhov length is required for the calculation of the bulk coefficients, the neutral bulk coefficients are used as the initial values and are repeated (twice in the standard case).</p>
<p>Prior to this calculation, the snow depth is added to the zero-plane displacements, but the zero-plane displacements should be limited to a maximum value so that they are not too large compared to the <span class="math inline"><em>z</em><sub><em>a</em></sub></span>.</p>
<p><span class="math display"><em>d</em> = min (<em>d</em> + <em>D</em><sub><em>S</em><em>n</em></sub>, <em>f</em><sub>max</sub> ⋅ <em>z</em><sub><em>a</em></sub>)</span></p>
<p>The standard is taking <span class="math inline"><em>f</em><sub>max</sub></span> to 0.5.</p>
<h3 id="calculating-bulk-coefficients-for-water-vapor">Calculating Bulk Coefficients for Water Vapor</h3>
<p>This calculation is performed after the calculation of the stomatal resistance, which is described below.</p>
<p>Once the stomatal resistance (<span class="math inline"><em>r</em><sub><em>s</em><em>t</em></sub></span>) and surface evaporation resistance (<span class="math inline"><em>r</em><sub><em>s</em><em>o</em><em>i</em><em>l</em></sub></span>) are obtained, the bulk coefficient for water vapor is calculated as follows</p>
<p><span class="math display">$$
 C_{Ec} |V_a| = \left[ (C_{Hc} |V_a|)^{-1} + r_{st} / LAI\right]^{-1} \\
 C_{Es} |V_a| = \left[ (C_{Hs} |V_a|)^{-1} + r_{soil}\right]^{-1}
$$</span></p>
<p>(Previously, the pore resistance was calculated via roughness by converting the pore resistance into a reduction in the exchange coefficient, but this method was changed to a simpler method because it seemed to be problematic.)</p>
<p>Note that the bulk coefficient of water vapor is the same as the bulk coefficient of heat when no stomatal resistance is applied (e.g., evaporation from a wet surface).</p>
<h2 id="calculation-of-stomatal-resistance.">calculation of stomatal resistance.</h2>
<p>The calculation of the stomatal resistance is based on the photosynthesis-stomatal model based on Farquhar et al. (1980), Ball (1988), Collatz et al. The code of SiB2 (Sellers et al., 1996) is used almost verbatim, except for the method to determine the resistance of the entire canopy. It is also possible to use Jarvis-type empirical equations instead, but the explanation is omitted here.</p>
<h3 id="calculating-soil-moisture-stress-factors.">Calculating Soil Moisture Stress Factors.</h3>
<p>Determine the soil water stress on transpiration. The soil water stress factor for each soil layer is determined and the overall soil stress factor is calculated by weighting the stress factor by the distribution of roots in each layer.</p>
<p>Soil water stress in each layer is assessed using SiB2 (Sellers et al., 1996) as a guide, using the following equation</p>
<p><span class="math display"><em>f</em><sub><em>w</em>(<em>k</em>)</sub> = [1 + exp (0.02(<em>ψ</em><sub><em>c</em><em>r</em></sub> − <em>ψ</em><sub><em>k</em></sub>))]<sup> − 1</sup>     (<em>k</em> = 1, …, <em>K</em><sub><em>g</em></sub>)</span></p>
<p>Overall soil stressors are ,</p>
<p><span class="math display">$$
 f_w = \sum_{k=1}^{K_g} f_{w(k)} f_{root(k)}
$$</span></p>
<p>Here, <span class="math inline"><em>f</em><sub><em>r</em><em>o</em><em>o</em><em>t</em>(<em>k</em>)</sub></span> is the ratio of the presence of roots in each layer and is an external parameter for each land cover type. This is <span class="math inline">$\sum_{k=1}^{K_g} f_{root(k)}=1$</span>.</p>
<p>In addition, the weights that distribute the transpiration to the siphoning flux in each layer are calculated as follows.</p>
<p><span class="math display"><em>f</em><sub><em>r</em><em>o</em><em>o</em><em>t</em><em>u</em><em>p</em>(<em>k</em>)</sub> = <em>f</em><sub><em>w</em>(<em>k</em>)</sub><em>f</em><sub><em>r</em><em>o</em><em>o</em><em>t</em>(<em>k</em>)</sub>/<em>f</em><sub><em>w</em></sub>     (<em>k</em> = 1, …, <em>K</em><sub><em>g</em></sub>)</span></p>
<p>Note that it is <span class="math inline">$\sum_{k=1}^{K_g} f_{rootup(k)} = 1$</span>.</p>
<h3 id="calculating-photosynthesis">Calculating Photosynthesis</h3>
<p>Following SiB2 (Sellers et al., 1996), we calculate the amount of photosynthesis.</p>
<p>We believe that the amount of photosynthesis is determined by three upper limits.</p>
<p><span class="math display"><em>A</em> ≤ min (<em>w</em><sub><em>c</em></sub>, <em>w</em><sub><em>e</em></sub>, <em>w</em><sub><em>s</em></sub>)</span></p>
<p><span class="math inline"><em>w</em><sub><em>c</em></sub></span> is the upper limit of photosynthetic enzyme (Rubisco) efficiency, and <span class="math inline"><em>w</em><sub><em>e</em></sub></span> is the upper limit of photosynthetically available radiation. <span class="math inline"><em>w</em><sub><em>s</em></sub></span> is the upper limit of the sink of photosynthetic products in the case of plants, and C<span class="math inline"><sub>4</sub></span> is the upper limit of the concentration of CO<span class="math inline"><sub>2</sub></span> in the case of plants (Collatz et al., 1991, 1992).</p>
<p>The size of each is estimated as follows.</p>
<p><span class="math display">$$
 w_c = \left\{
\begin{array}{ll}
\displaystyle{
V_m \left[ \frac{c_i - \Gamma^*}{c_i + K_c(1+O_2/K_O)}\right]
}
  ({C$_3$ 植物の場合})\\
 V_m
  ({C$_4$ 植物の場合})
\end{array}
\right. \\
 w_e = \left\{
\begin{array}{ll}
\displaystyle{
PAR\cdot \epsilon_3 \left[ \frac{c_i-\Gamma^*}{c_i+2\Gamma^*}\right]
}
  ({C$_3$ 植物の場合})\\
PAR\cdot \epsilon_4
  ({C$_4$ 植物の場合})
\end{array}
\right. \\
 w_s = \left\{
\begin{array}{ll}
V_m / 2
  ({C$_3$ 植物の場合})\\
V_m c_i/ 5
  ({C$_4$ 植物の場合})
\end{array}
\right.
$$</span></p>
<p>where <span class="math inline"><em>V</em><sub><em>m</em></sub></span> is the Rubisco reaction capacity, <span class="math inline"><em>c</em><sub><em>i</em></sub></span> is the partial pressure of CO<span class="math inline"><sub>2</sub></span> in the stomatal chamber, <span class="math inline"><em>O</em><sub>2</sub></span> is the partial pressure of oxygen in the stomatal chamber, and <span class="math inline"><em>P</em><em>A</em><em>R</em></span> is the photosynthetically available radiation (PAR). <span class="math inline"><em>Γ</em><sup>*</sup></span> is the compensation point of CO<span class="math inline"><sub>2</sub></span> and is represented by <span class="math inline"><em>Γ</em><sup>*</sup> = 0.5<em>O</em><sub>2</sub>/<em>S</em></span> <span class="math inline"><em>K</em><sub><em>c</em></sub></span>, <span class="math inline"><em>K</em><sub><em>O</em></sub></span>, and <span class="math inline"><em>S</em></span> are functions of temperature and will be shown in functional form later. <span class="math inline"><em>ϵ</em><sub>3</sub></span> and <span class="math inline"><em>ϵ</em><sub>4</sub></span> are constants determined by vegetation type.</p>
<ol start="76" type="1">
<li>is actually solved as follows to represent a smooth transition between the different upper bounds.</li>
</ol>
<p><span class="math display">$$
 \beta_{ce} w_p^2 - w_p(w_c + w_e) + w_c w_e = 0 \\
 \beta_{ps} A^2 - A(w_p + w_s) + w_p w_s = 0
$$</span></p>
<p>Solving the two equations in sequence, choosing the smaller of the two solutions for each equation, yields <span class="math inline"><em>A</em><sub><em>n</em></sub></span>. <span class="math inline"><em>β</em><sub><em>c</em><em>e</em></sub>, <em>β</em><sub><em>p</em><em>s</em></sub></span> are constants determined by vegetation type. Note that when <span class="math inline"><em>β</em> = 1</span>, it coincides with a simple minimum value operation.</p>
<p>Once the amount of photosynthesis is determined, the net photosynthesis amount (<span class="math inline"><em>A</em><sub><em>n</em></sub></span>) is determined as follows.</p>
<p><span class="math display"><em>A</em><sub><em>n</em></sub> = <em>A</em> − <em>R</em><sub><em>d</em></sub></span></p>
<p><span class="math inline"><em>R</em><sub><em>d</em></sub></span> is the respiratory rate and is expressed as</p>
<p><span class="math display"><em>R</em><sub><em>d</em></sub> = <em>f</em><sub><em>d</em></sub><em>V</em><sub><em>m</em></sub></span></p>
<p><span class="math inline"><em>f</em><sub><em>d</em></sub></span> is a constant determined by vegetation type.</p>
<p><span class="math inline"><em>V</em><sub><em>m</em></sub></span>, for example, depends on temperature and soil moisture as follows (<span class="math inline"><em>V</em><sub><em>m</em></sub></span> depends differently on temperature depending on the term that appears, but is represented by the same <span class="math inline"><em>V</em><sub><em>m</em></sub></span>).</p>
<p><span class="math display">$$
 V_m = V_{\max} f_T(T_c) f_w \\
 K_c = 30 \times 2.1^{Q_T} \\
 K_O = 30000 \times 1.2^{Q_T} \\
 S   = 2600 \times 0.57^{Q_T} \\
 f_T(T_c) = \left\{
\begin{array}{ll}
 2.1^{Q_T}/\{1 + \exp[s_1(T_c-s_2)]\}  ({C$_3$ の $w_c$, $w_e$ のとき})\\
 1.8^{Q_T}/\{1 + \exp[s_3(s_4-T_c)]\}  ({C$_3$ の $w_s$ のとき}) \\
 2.1^{Q_T}/\{1 + \exp[s_1(T_c-s_2)]\}/\{1 + \exp[s_3(s_4-T_c)]\}
    ({C$_4$ の $w_c$, $w_e$ のとき})\\
 1.8^{Q_T}   ({C$_4$ の $w_s$ のとき}) \\
 2^{Q_T}/\{1 + \exp[s_5(T_c-s_6)]\}   ({$R_d$ のとき})
\end{array}
\right. \\
Q^T = (T_c - 298) / 10
$$</span></p>
<p>Here, <span class="math inline"><em>V</em><sub>max</sub></span>, <span class="math inline"><em>s</em><sub>1</sub>, …, <em>s</em><sub>6</sub></span> are constants determined by the vegetation type.</p>
<p>Given the above values for <span class="math inline"><em>V</em><sub>max</sub></span>, <span class="math inline"><em>P</em><em>A</em><em>R</em></span>, <span class="math inline"><em>c</em><sub><em>i</em></sub></span>, <span class="math inline"><em>T</em><sub><em>c</em></sub></span> and <span class="math inline"><em>f</em><sub><em>w</em></sub></span>, the amount of photosynthesis in each individual leaf can be calculated. In reality, these values can be considered to be distributed evenly within the same canopy, but we assumed that <span class="math inline"><em>c</em><sub><em>i</em></sub></span>, <span class="math inline"><em>T</em><sub><em>c</em></sub></span>, and <span class="math inline"><em>f</em><sub><em>w</em></sub></span> are the same for all leaves and that the vertical distributions of <span class="math inline"><em>V</em><sub>max</sub></span> and <span class="math inline"><em>P</em><em>A</em><em>R</em></span> are considered. The vertical distribution of the <span class="math inline"><em>P</em><em>A</em><em>R</em></span> is large at the top of the canopy and diminishes as it moves downward, and the distribution of the <span class="math inline"><em>V</em><sub>max</sub></span> is considered to be similar to that of the <span class="math inline"><em>P</em><em>A</em><em>R</em></span> following this distribution of the <span class="math inline"><em>P</em><em>A</em><em>R</em></span>.</p>
<p>The average vertical distribution of the <span class="math inline"><em>P</em><em>A</em><em>R</em></span> (and therefore the vertical distribution of the <span class="math inline"><em>V</em><sub>max</sub></span>) is shown in the following table.</p>
<p><span class="math display"><em>P</em><em>A</em><em>R</em>(<em>L</em>) = <em>P</em><em>A</em><em>R</em><sup><em>t</em><em>o</em><em>p</em></sup>exp ( − <em>f</em><sub><em>a</em><em>t</em><em>n</em></sub><em>a</em><em>L</em>)</span></p>
<p>Here, <span class="math inline"><em>L</em></span> is the leaf area accumulated from the top of the canopy, <span class="math inline"><em>P</em><em>A</em><em>R</em><sup><em>t</em><em>o</em><em>p</em></sup></span> is the <span class="math inline"><em>P</em><em>A</em><em>R</em></span> at the top of the canopy, <span class="math inline"><em>a</em></span> is the attenuation factor defined in (17), and <span class="math inline"><em>f</em><sub><em>a</em><em>t</em><em>n</em></sub></span> is a constant for adjustment. Using this value, the factor (<span class="math inline"><em>f</em><sub><em>a</em><em>v</em><em>r</em></sub></span>) which represents the average value of <span class="math inline"><em>P</em><em>A</em><em>R</em></span> is defined as follows.</p>
<p><span class="math display">$$
 f_{avr} = \int_0^{LAI} PAR(L) dL \Bigm / (LAI \cdot PAR^{top})
 = \frac{1 - \exp(- f_{atn} a L)}{f_{atn} a}
$$</span></p>
<p>Since each term in <span class="math inline"><em>A</em><sub><em>n</em></sub></span> (<span class="math inline"><em>w</em><sub><em>c</em></sub>, <em>w</em><sub><em>s</em></sub>, <em>w</em><sub><em>e</em></sub>, <em>R</em><sub><em>d</em></sub></span>) is proportional to <span class="math inline"><em>V</em><sub>max</sub></span> or <span class="math inline"><em>P</em><em>A</em><em>R</em></span>, on the assumption that the vertical distributions of <span class="math inline"><em>V</em><sub>max</sub></span> and <span class="math inline"><em>P</em><em>A</em><em>R</em></span> are proportional to those of <span class="math inline"><em>V</em><sub>max</sub></span> at the top end of the canopy By multiplying the <span class="math inline"><em>A</em><sub><em>n</em></sub></span> calculated using the <span class="math inline"><em>P</em><em>A</em><em>R</em></span> value by <span class="math inline"><em>f</em><sub><em>a</em><em>v</em><em>r</em></sub></span>, the average leaf photosynthetic rate (<span class="math inline">$\overline{A_n}$</span>) can be obtained.</p>
<p><span class="math display">$$
 \overline{A_n} = f_{avr} A_n
$$</span></p>
<p>Hereinafter, we will refer to it again as <span class="math inline"><em>A</em><sub><em>n</em></sub></span>.</p>
<h3 id="stomatal-resistance-calculations.">Stomatal Resistance Calculations.</h3>
<p>Net photosynthesis (<span class="math inline"><em>A</em><sub><em>n</em></sub></span>) and stomatal conductance (<span class="math inline"><em>g</em><sub><em>s</em></sub></span>) are related by the quasi-empirical formula of Ball (1988) as follows</p>
<p><span class="math display">$$
 g_s = m \frac {A_n}{c_s} h_s + b f_w
$$</span></p>
<p>where <span class="math inline"><em>c</em><sub><em>s</em></sub></span> is the CO<span class="math inline"><sub>2</sub></span> molar fraction at the leaf surface (the number of mol of CO<span class="math inline"><sub>2</sub></span> per 1mol of air), <span class="math inline"><em>f</em><sub><em>w</em></sub></span> is the soil moisture stress factor, and <span class="math inline"><em>m</em></span> and <span class="math inline"><em>b</em></span> are constants determined by vegetation type.</p>
<p><span class="math inline"><em>h</em><sub><em>s</em></sub></span> is the relative humidity at the leaf surface, defined as</p>
<p><span class="math display"><em>h</em><sub><em>s</em></sub> = <em>e</em><sub><em>s</em></sub>/<em>e</em><sub><em>i</em></sub></span></p>
<p><span class="math inline"><em>e</em><sub><em>s</em></sub></span> is the mole fraction of water vapor at the leaf surface, <span class="math inline"><em>e</em><sub><em>i</em></sub></span> is the mole fraction of water vapor in the stomata, and <span class="math inline"><em>e</em><sub><em>i</em></sub> = <em>e</em><sup>*</sup>(<em>T</em><sub><em>c</em></sub>)</span> is the mole fraction of water vapor in the stomata. <span class="math inline"><em>e</em><sup>*</sup></span> is the mole fraction of saturated water vapor.</p>
<p>Assuming that the water vapor flux from the stomatal surface to the leaf surface is equal to the water vapor flux from the leaf surface to the atmosphere (i.e., there is no convergent water vapor divergence at the leaf surface),</p>
<p><span class="math display"><em>g</em><sub><em>s</em></sub>(<em>e</em><sub><em>i</em></sub> − <em>e</em><sub><em>s</em></sub>) = <em>g</em><sub><em>l</em></sub>(<em>e</em><sub><em>s</em></sub> − <em>e</em><sub><em>a</em></sub>)</span></p>
<p>than ,</p>
<p><span class="math display"><em>e</em><sub><em>s</em></sub> = (<em>g</em><sub><em>l</em></sub><em>e</em><sub><em>a</em></sub> + <em>g</em><sub><em>s</em></sub><em>e</em><sub><em>i</em></sub>)/(<em>g</em><sub><em>l</em></sub> + <em>g</em><sub><em>s</em></sub>)</span></p>
<p>is obtained. where <span class="math inline"><em>e</em><sub><em>a</em></sub></span> is the atmospheric water vapor mole fraction and <span class="math inline"><em>g</em><sub><em>l</em></sub></span> is the conductance between the leaf surface and the atmosphere. <span class="math inline"><em>g</em><sub><em>l</em></sub></span> is represented by <span class="math inline"><em>g</em><sub><em>l</em></sub> = <em>C</em><sub><em>H</em><em>c</em></sub>|<em>V</em><sub><em>a</em></sub>|/<em>L</em><em>A</em><em>I</em></span> using the bulk coefficient.</p>
<p>Similarly, given the lack of convergent divergence of CO<span class="math inline"><sub>2</sub></span> on the leaf surface,</p>
<p><span class="math display"><em>A</em><sub><em>n</em></sub> = <em>g</em><sub><em>l</em></sub>(<em>c</em><sub><em>a</em></sub> − <em>c</em><sub><em>s</em></sub>)/1.4 = <em>g</em><sub><em>s</em></sub>(<em>c</em><sub><em>s</em></sub> − <em>c</em><sub><em>i</em></sub>)/1.6</span></p>
<p>than ,</p>
<p><span class="math display">$$
 c_s = c_a - 1.4 A_n/g_l \\
 c_i = c_s - 1.6 A_n/g_s
$$</span></p>
<p>where <span class="math inline"><em>c</em><sub><em>a</em></sub></span> and <span class="math inline"><em>c</em><sub><em>i</em></sub></span> are obtained from the atmosphere and pores, respectively. where <span class="math inline"><em>c</em><sub><em>a</em></sub></span> and <span class="math inline"><em>c</em><sub><em>i</em></sub></span> are the CO<span class="math inline"><sub>2</sub></span> mole fractions in the atmosphere and in the pores, respectively. 1.4 and 1.6 are constants that appear due to the difference in diffusion coefficients of water vapor and CO<span class="math inline"><sub>2</sub></span>.</p>
<p>Substituting (94) and (96) into (93), we obtain the following equation for <span class="math inline"><em>g</em><sub><em>s</em></sub></span>.</p>
<p><span class="math display"><em>H</em><em>g</em><sub><em>s</em></sub><sup>2</sup> + (<em>H</em><em>g</em><sub><em>l</em></sub> − <em>e</em><sub><em>i</em></sub> − <em>H</em><em>b</em><em>f</em><sub><em>w</em></sub>)<em>g</em><sub><em>s</em></sub> − <em>g</em><sub><em>l</em></sub>(<em>H</em><em>b</em><em>f</em><sub><em>w</em></sub> + <em>e</em><sub><em>a</em></sub>) = 0</span></p>
<p>However,</p>
<p><span class="math display"><em>H</em> = (<em>e</em><sub><em>i</em></sub><em>c</em><sub><em>s</em></sub>)/(<em>m</em><em>A</em><sub><em>n</em></sub>)</span></p>
<p>and use (99) for <span class="math inline"><em>c</em><sub><em>s</em></sub></span>.</p>
<p>Of the two solutions of (100), the larger of the two solutions makes more sense. From the above, assuming that <span class="math inline"><em>A</em><sub><em>n</em></sub></span> is known, we can solve for <span class="math inline"><em>g</em><sub><em>s</em></sub></span>, but we use <span class="math inline"><em>c</em><sub><em>i</em></sub></span> to solve for <span class="math inline"><em>A</em><sub><em>n</em></sub></span>. <span class="math inline"><em>c</em><sub><em>i</em></sub></span> can be obtained by (99) if <span class="math inline"><em>g</em><sub><em>s</em></sub></span> is obtained. In other words, finding <span class="math inline"><em>g</em><sub><em>s</em></sub></span> requires <span class="math inline"><em>A</em><sub><em>n</em></sub></span> and finding <span class="math inline"><em>A</em><sub><em>n</em></sub></span> requires <span class="math inline"><em>c</em><sub><em>i</em></sub></span> and thus <span class="math inline"><em>g</em><sub><em>s</em></sub></span>, so the calculation must be repeated.</p>
<p>The algorithm for iterative computation is ported from SiB2. Six iterations are performed and the next solution is estimated in the order of increasing errors to accelerate the convergence.</p>
<p>Finally, using the stomatal conductance, the stomatal resistance is expressed as</p>
<p><span class="math display"><em>r</em><sub><em>s</em><em>t</em></sub> = 1/<em>g</em><sub><em>s</em><em>t</em></sub></span></p>
<h3 id="calculation-of-surface-evaporation-resistance">Calculation of Surface Evaporation Resistance</h3>
<p>Calculate the surface evaporation resistance (<span class="math inline"><em>r</em><sub><em>s</em><em>o</em><em>i</em><em>l</em></sub></span>) and the relative humidity (<span class="math inline"><em>h</em><sub><em>s</em><em>o</em><em>i</em><em>l</em></sub></span>) of the first layer of soil as follows.</p>
<p><span class="math display">$$
 r_{soil} = a_1 ( 1 - W_{(1)} ) / ( a_2 + W_{(1)} ) \\
 h_{soil} = \exp \left(\frac{\psi_{(1)} g}{R_{air} T_{g(1)}} \right)
$$</span></p>
<p>where <span class="math inline"><em>W</em><sub>(1)</sub> = <em>w</em><sub>(1)</sub>/<em>w</em><sub><em>s</em><em>a</em><em>t</em>(1)</sub></span> is the saturation degree of the first soil layer, <span class="math inline"><em>ψ</em><sub>1</sub></span> is the moisture potential of the first soil layer, <span class="math inline"><em>g</em></span> is the gravitational acceleration, <span class="math inline"><em>R</em><sub><em>a</em><em>i</em><em>r</em></sub></span> is the gas constant of air, and <span class="math inline"><em>T</em><sub><em>g</em>(1)</sub></span> is the temperature of the first soil layer. <span class="math inline"><em>a</em><sub>1</sub></span> and <span class="math inline"><em>a</em><sub>2</sub></span> are constants and the standard uses <span class="math inline"><em>a</em><sub>1</sub> = 800</span>, <span class="math inline"><em>a</em><sub>2</sub></span>=0.2.</p>
<h1 id="earth-surface-submodel-matsfc">Earth Surface Submodel MATSFC</h1>
<h2 id="calculation-of-surface-turbulence-flux.">Calculation of surface turbulence flux.</h2>
<p>The bulk method is used to obtain the turbulent flux at the surface as follows. When the surface energy balance is solved and the surface temperature (<span class="math inline"><em>T</em><sub><em>s</em></sub></span>) and the canopy temperature (<span class="math inline"><em>T</em><sub><em>c</em></sub></span>) are updated, the surface flux is also updated with respect to these values. The value obtained here is a provisional value until then. In order to linearize the energy balance for <span class="math inline"><em>T</em><sub><em>s</em></sub></span> and <span class="math inline"><em>T</em><sub><em>c</em></sub></span>, the derivatives of each flux for <span class="math inline"><em>T</em><sub><em>s</em></sub></span> and <span class="math inline"><em>T</em><sub><em>c</em></sub></span> have been calculated.</p>
<ul>
<li>momentum flux</li>
</ul>
<p><span class="math display">$$
 \tau_x = - \rho C_{M}|V_a| u_a \\
 \tau_y = - \rho C_{M}|V_a| v_a
$$</span></p>
<p>Here, <span class="math inline"><em>τ</em><sub><em>x</em></sub></span> and <span class="math inline"><em>τ</em><sub><em>y</em></sub></span> are the momentum fluxes (surface stresses) in the east-west and north-south directions, respectively.</p>
<ul>
<li>Sensible Heat Flux</li>
</ul>
<p><span class="math display">$$
 H_s = c_p \rho C_{Hs}|V_a| (T_s - (P_s/P_a)^{\kappa}T_a)
  \\
 H_c = c_p \rho C_{Hc}|V_a| (T_c - (P_s/P_a)^{\kappa}T_a) \\
 \partial H_s/\partial T_s = c_p \rho C_{Hs}|V_a| \\
 \partial H_c/\partial T_c = c_p \rho C_{Hc}|V_a|
$$</span></p>
<p>where <span class="math inline"><em>H</em><sub><em>s</em></sub></span> and <span class="math inline"><em>H</em><sub><em>c</em></sub></span> are sensible heat fluxes from the ground surface (forest floor) and canopy (leaf surface), respectively, <span class="math inline"><em>κ</em> = <em>R</em><sub><em>a</em><em>i</em><em>r</em></sub>/<em>c</em><sub><em>p</em></sub></span> and <span class="math inline"><em>R</em><sub><em>a</em><em>i</em><em>r</em></sub></span> are the gas constant of air, and <span class="math inline"><em>c</em><sub><em>p</em></sub></span> is the specific heat of air.</p>
<ul>
<li>Bare ground (forest floor) evaporation flux</li>
</ul>
<p><span class="math display">$$
 Et_{(1,1)} = (1-A_{Sn})(1-f_{ice})\cdot
           \rho \widetilde{C_{Es}}|V_a|(h_{soil}q^*(T_s) - q_a) \\
 Et_{(2,1)} = (1-A_{Sn})f_{ice}\cdot
           \rho \widetilde{C_{Es}}|V_a|(h_{soil}q^*(T_s) - q_a) \\
 \partial Et_{(1,1)}/\partial T_s = (1-A_{Sn})(1-f_{ice})\cdot
           \rho \widetilde{C_{Es}}|V_a|h_{soil}\cdot dq^*/dT |_{T_s} \\
 \partial Et_{(2,1)}/\partial T_s = (1-A_{Sn})f_{ice}\cdot
           \rho \widetilde{C_{Es}}|V_a|h_{soil}\cdot dq^*/dT |_{T_s}
$$</span></p>
<p>where <span class="math inline"><em>E</em><em>t</em><sub>(1, 1)</sub></span> and <span class="math inline"><em>E</em><em>t</em><sub>(2, 1)</sub></span> are water evaporation and ice sublimation fluxes on bare ground, respectively, <span class="math inline"><em>q</em><sup>*</sup>(<em>T</em><sub><em>s</em></sub>)</span> is the specific humidity at the saturated surface temperature, <span class="math inline"><em>h</em><sub><em>s</em><em>o</em><em>i</em><em>l</em></sub></span> is the relative humidity at the soil surface, <span class="math inline"><em>A</em><sub><em>S</em><em>n</em></sub></span> is the snow cover area fraction, and <span class="math inline"><em>f</em><sub><em>i</em><em>c</em><em>e</em></sub></span> is the percentage of ice in the first soil layer</p>
<p><span class="math display"><em>f</em><sub><em>i</em><em>c</em><em>e</em></sub> = <em>w</em><sub><em>i</em>(1)</sub>/<em>w</em><sub>(1)</sub></span></p>
<p>in <span class="math inline"><em>A</em><sub><em>S</em><em>n</em></sub></span>. Note that the value of <span class="math inline"><em>A</em><sub><em>S</em><em>n</em></sub></span> should be either <span class="math inline">0</span> (snow-free surface) or <span class="math inline">1</span> (snow-covered surface) because snow-free and snow-covered surfaces are calculated separately. In the case of downward-facing (condensation) fluxes, no soil moisture resistance is applied, so the bulk coefficient should be calculated as follows</p>
<p><span class="math display">$$
  \widetilde{C_{Es}} = \left\{
  \begin{array}{ll}
   C_{Es} (h_{soil}q^*(T_s) - q_a &gt; 0 {のとき})\\
   C_{Hs} (h_{soil}q^*(T_s) - q_a \leq 0 {のとき})
  \end{array}
  \right.
$$</span></p>
<ul>
<li>Transpiration Flux</li>
</ul>
<p><span class="math display">$$
 Et_{(1,2)} = (1-f_{cwet}) \cdot \rho \widetilde{C_{Ec}}|V_a|(q^*(T_c) - q_a) \\
 Et_{(2,2)} = 0 \\
 \partial Et_{(1,2)}/\partial T_c =
  (1-f_{cwet}) \cdot \rho \widetilde{C_{Ec}}|V_a|\cdot dq^*/dT|_{T_c} \\
 \partial Et_{(2,2)}/\partial T_c = 0
$$</span></p>
<p>Here, <span class="math inline"><em>E</em><em>t</em><sub>(1, 2)</sub></span> and <span class="math inline"><em>E</em><em>t</em><sub>(2, 2)</sub></span> are water and ice transpiration, while <span class="math inline"><em>E</em><em>t</em><sub>(2, 2)</sub></span> is always zero. <span class="math inline"><em>f</em><sub><em>c</em><em>w</em><em>e</em><em>t</em></sub> = <em>w</em><sub><em>c</em></sub>/<em>w</em><sub><em>c</em>, <em>c</em><em>a</em><em>p</em></sub></span> is the wetting area ratio of the canopy. In the case of downward-facing fluxes, the bulk factor is considered to be condensation on dry parts of the leaves and is calculated as follows</p>
<p><span class="math display">$$
  \widetilde{C_{Ec}} = \left\{
  \begin{array}{ll}
   C_{Ec} (q^*(T_c) - q_a &gt; 0 {のとき})\\
   C_{Hc} (q^*(T_c) - q_a \leq 0 {のとき})
  \end{array}
  \right.
$$</span></p>
<ul>
<li>Evaporated flux on the canopy <span class="math inline"><em>T</em><sub><em>c</em></sub></span> <span class="math inline">≥</span> 0 <span class="math inline"><sup>∘</sup></span> C</li>
</ul>
<p><span class="math display">$$
 Et_{(1,3)} =
  f_{cwet} \cdot \rho C_{Hc}|V_a|(q^*(T_c) - q_a) \\
 Et_{(2,3)} = 0 \\
 \partial Et_{(1,3)} \partial T_c =
  f_{cwet} \cdot \rho C_{Hc}|V_a|\cdot dq^*/dT|_{T_c} \\
 \partial Et_{(2,3)} \partial T_c = 0
$$</span></p>
<pre><code> $T_c$ $&lt;$ 0 $^{\circ}$ In case of C</code></pre>
<p><span class="math display">$$
 Et_{(1,3)} = 0 \\
 Et_{(2,3)} =
  f_{cwet} \cdot \rho C_{Hc}|V_a|(q^*(T_c) - q_a) \\
 \partial Et_{(1,3)} \partial T_c = 0 \\
 \partial Et_{(2,3)} \partial T_c =
  f_{cwet} \cdot \rho C_{Hc}|V_a|\cdot dq^*/dT|_{T_c}
$$</span></p>
<p>Here, <span class="math inline"><em>E</em><em>t</em><sub>(1, 3)</sub></span> and <span class="math inline"><em>E</em><em>t</em><sub>(2, 3)</sub></span> are the evaporation of water and ice sublimation on the canopy.</p>
<ul>
<li>Snow Sublimation Flux</li>
</ul>
<p><span class="math display">$$
 E_{Sn} = A_{Sn}\cdot \rho C_{Hs}|V_a|(q^*(T_s) - q_a) \\
 \partial E_{Sn}/\partial T_s = A_{Sn}\cdot \rho C_{Hs}|V_a|
 \cdot dq^*/dT|_{T_s}
$$</span></p>
<pre><code> $E_{Sn}$ is a snow sublimation flux. Note that since snow-free and snow-covered surfaces are calculated separately, $A_{Sn}$ contains either $0$ (snow-free surface) or $1$ (snow-covered surface).</code></pre>
<h2 id="calculating-heat-transfer-flux.">Calculating heat transfer flux.</h2>
<p>Calculating the heat conduction fluxes on snow-free and snow-covered surfaces. As well as the turbulent fluxes, the heat conduction fluxes are also updated when the surface temperature is updated after the energy balance is solved.</p>
<p>Note that since snow-free and snow-covered surfaces are calculated separately, the snow coverage area ratio (<span class="math inline"><em>A</em><sub><em>S</em><em>n</em></sub></span>) should be set to either <span class="math inline">0</span> (snow-free surface) or <span class="math inline">1</span> (snow-covered surface), as shown below.</p>
<ul>
<li>Heat Transfer Flux on Snow-Free Surfaces</li>
</ul>
<p><span class="math display">$$
  F_{g(1/2)} = (1 - A_{Sn}) \cdot k_{g(1/2)} / \Delta z_{g(1/2)} (T_{g(1)} - T_s) \\
  \partial F_{g(1/2)}/\partial T_s =
  - (1 - A_{Sn}) \cdot k_{g(1/2)} / \Delta z_{g(1/2)}
$$</span></p>
<p>where <span class="math inline"><em>F</em><sub><em>g</em>(1/2)</sub></span> is the heat transfer flux, <span class="math inline"><em>k</em><sub><em>g</em>(1/2)</sub></span> is the thermal conductivity of the soil, <span class="math inline"><em>Δ</em><em>z</em><sub><em>g</em>(1/2)</sub></span> is the thickness of the first layer of soil from the temperature definition point to the ground surface, and <span class="math inline"><em>T</em><sub><em>g</em>(1)</sub></span> is the temperature of the first layer of soil.</p>
<ul>
<li>Heat Transfer Flux of Snow Surface</li>
</ul>
<p><span class="math display">$$
  F_{Sn(1/2)} = A_{Sn} \cdot k_{Sn(1/2)} / \Delta z_{Sn(1/2)} (T_{Sn(1)} - T_s)
 \\
  \partial F_{Sn(1/2)}/\partial T_s =
  - A_{Sn} \cdot k_{Sn(1/2)} / \Delta z_{Sn(1/2)}
$$</span></p>
<p>where <span class="math inline"><em>F</em><sub><em>S</em><em>n</em>(1/2)</sub></span> is the heat transfer flux, <span class="math inline"><em>k</em><sub><em>S</em><em>n</em>(1/2)</sub></span> is the thermal conductivity of the snowpack, <span class="math inline"><em>Δ</em><em>z</em><sub><em>S</em><em>n</em>(1/2)</sub></span> is the thickness of the first layer of snow from the temperature definition point to the ground surface, and <span class="math inline"><em>T</em><sub><em>S</em><em>n</em>(1)</sub></span> is the temperature of the first layer of snowpack.</p>
<h2 id="surface-solving-the-canopy-energy-balance">Surface, Solving the Canopy Energy Balance</h2>
<p>The energy balance is solved for two cases: 1: the case of no melting and 2: the case of melting at the surface. In Case 2, we fix the surface temperature (<span class="math inline"><em>T</em><sub><em>s</em></sub></span>) to <span class="math inline">0<sup>∘</sup></span> C, and diagnose the energy available for melting based on the energy balance. Since the snow melting on vegetation will be processed by correction later, we do not solve this case separately here. The case in which the snow melts completely within a time step is also processed by later corrections.</p>
<h3 id="surface-canopy-energy-balance">Surface, Canopy Energy Balance</h3>
<p>The amount of energy dissipation at the ground surface (forest floor) is ,</p>
<p><span class="math display"><em>Δ</em><em>F</em><sub><em>s</em></sub> = <em>H</em><sub><em>s</em></sub> + <em>R</em><sub><em>s</em></sub><sup><em>n</em><em>e</em><em>t</em></sup> + <em>l</em><em>E</em><em>t</em><sub>(1, 1)</sub> + <em>l</em><sub><em>s</em></sub>(<em>E</em><em>t</em><sub>(2, 1)</sub> + <em>E</em><sub><em>S</em><em>n</em></sub>) − <em>F</em><sub><em>g</em>(1/2)</sub> − <em>F</em><sub><em>S</em><em>n</em>(1/2)</sub></span></p>
<p>However, <span class="math inline"><em>l</em></span> and <span class="math inline"><em>l</em><sub><em>s</em></sub></span> are the latent heat of evaporation and sublimation, respectively, and <span class="math inline"><em>R</em><sub><em>s</em></sub><sup><em>n</em><em>e</em><em>t</em></sup></span> is the net radiative divergence at the ground surface,</p>
<p><span class="math display"><em>R</em><sub><em>s</em></sub><sup><em>n</em><em>e</em><em>t</em></sup> =  − (<em>R</em><sub><em>S</em></sub><sup>↓</sup> − <em>R</em><sub><em>S</em></sub><sup>↑</sup>)𝒯<sub><em>c</em><em>S</em></sub> − <em>ϵ</em><em>R</em><sub><em>L</em></sub><sup>↓</sup>𝒯<sub><em>c</em><em>L</em></sub> + <em>ϵ</em><em>σ</em><em>T</em><sub><em>s</em></sub><sup>4</sup> − <em>ϵ</em><em>σ</em><em>T</em><sub><em>c</em></sub><sup>4</sup>(1 − 𝒯<sub><em>c</em><em>L</em></sub>)</span></p>
<p><span class="math inline"><em>σ</em></span> is the Stefan-Boltzman constant.</p>
<p>The amount of energy dissipation in the canopy (leaf surface) is ,</p>
<p><span class="math display"><em>Δ</em><em>F</em><sub><em>c</em></sub> = <em>H</em><sub><em>c</em></sub> + <em>R</em><sub><em>c</em></sub><sup><em>n</em><em>e</em><em>t</em></sup> + <em>l</em>(<em>E</em><em>t</em><sub>(1, 2)</sub> + <em>E</em><em>t</em><sub>(1, 3)</sub>) + <em>l</em><sub><em>s</em></sub>(<em>E</em><em>t</em><sub>(2, 2)</sub> + <em>E</em><em>t</em><sub>(2, 3)</sub>)</span></p>
<p>However, <span class="math inline"><em>R</em><sub><em>c</em></sub><sup><em>n</em><em>e</em><em>t</em></sup></span> is the net radiative divergence in the canopy,</p>
<p><span class="math display"><em>R</em><sub><em>c</em></sub><sup><em>n</em><em>e</em><em>t</em></sup> =  − (<em>R</em><sub><em>S</em></sub><sup>↓</sup> − <em>R</em><sub><em>S</em></sub><sup>↑</sup>)(1 − 𝒯<sub><em>c</em><em>S</em></sub>) − <em>ϵ</em><em>R</em><sub><em>L</em></sub><sup>↓</sup>(1 − 𝒯<sub><em>c</em><em>L</em></sub>) + (2<em>ϵ</em><em>σ</em><em>T</em><sub><em>c</em></sub><sup>4</sup> − <em>ϵ</em><em>σ</em><em>T</em><sub><em>s</em></sub><sup>4</sup>)(1 − 𝒯<sub><em>c</em><em>L</em></sub>)</span></p>
<h3 id="case-1-in-the-absence-of-surface-melting">Case 1: In the absence of surface melting</h3>
<p>In the absence of melting of the ground surface, as <span class="math inline"><em>Δ</em><em>F</em><sub><em>s</em></sub> = <em>Δ</em><em>F</em><sub><em>c</em></sub> = 0</span>, we solve for <span class="math inline"><em>T</em><sub><em>s</em></sub></span> and <span class="math inline"><em>T</em><sub><em>c</em></sub></span> so that the energy balance between the ground surface and the canopy is maintained.</p>
<p>The linearized energy balance equation for each term for <span class="math inline"><em>T</em><sub><em>s</em></sub></span> and <span class="math inline"><em>T</em><sub><em>c</em></sub></span> is,</p>
<p><span class="math display">$$
 \left(
\begin{array}{l}
 \Delta F_s \\
 \Delta F_c \\
\end{array}
\right)^{current}
=
\left(
\begin{array}{l}
 \Delta F_s \\
 \Delta F_c \\
\end{array}
\right)^{past}
+
\left(
\begin{array}{ll}
 {\partial \Delta F_s}/{\partial T_s} 
 {\partial \Delta F_s}/{\partial T_c} \\
 {\partial \Delta F_c}/{\partial T_s} 
 {\partial \Delta F_c}/{\partial T_c} \\
\end{array}
\right)
\left(
\begin{array}{l}
 \Delta T_s \\
 \Delta T_c \\
\end{array}
\right)
=
\left(
\begin{array}{l}
 0 \\
 0 \\
\end{array}
\right)
$$</span></p>
<p>I could write.</p>
<p>The part marked with <span class="math inline"><em>p</em><em>a</em><em>s</em><em>t</em></span> on the right-hand side is the flux calculated from (107) to (134) using the values of <span class="math inline"><em>T</em><sub><em>s</em></sub></span> and <span class="math inline"><em>T</em><sub><em>c</em></sub></span> in the previous step and substituted into (136) to (139).</p>
<p>The differential term is ,</p>
<p><span class="math display">$$
 \frac{\partial \Delta F_s}{\partial T_s} =
 \frac{\partial H_s}{\partial T_s}
+\frac{\partial R^{net}_s}{\partial T_s}
+l\frac{\partial Et_{(1,1)}}{\partial T_s}
+l_s\left(\frac{\partial Et_{(2,1)}}{\partial T_s}
+    \frac{\partial E_{Sn}}{\partial T_s}\right)
-\frac{\partial F_{g(1/2)}}{\partial T_s}
-\frac{\partial F_{Sn(1/2)}}{\partial T_s} \\
 \frac{\partial \Delta F_s}{\partial T_c} =
 \frac{\partial R^{net}_s}{\partial T_c} \\
 \frac{\partial \Delta F_c}{\partial T_s} =
 \frac{\partial R^{net}_c}{\partial T_s} \\
 \frac{\partial \Delta F_c}{\partial T_c} =
 \frac{\partial H_c}{\partial T_c}
+\frac{\partial R^{net}_c}{\partial T_c}
+l  \left(\frac{\partial Et_{(1,2)}}{\partial T_c}
+         \frac{\partial Et_{(1,3)}}{\partial T_c}\right)
+l_s\left(\frac{\partial Et_{(2,2)}}{\partial T_c}
+         \frac{\partial Et_{(2,3)}}{\partial T_c}\right)
$$</span></p>
<p>However,</p>
<p><span class="math display">$$
 \frac{\partial R^{net}_s}{\partial T_s} =
 \epsilon 4 \sigma T_s^3 \\
 \frac{\partial R^{net}_s}{\partial T_c} =
 - ( 1 - {\mathcal{T}}_{cL} ) \epsilon 4 \sigma T_c^3 \\
 \frac{\partial R^{net}_c}{\partial T_s} =
 - ( 1 - {\mathcal{T}}_{cL} ) \epsilon 4 \sigma T_s^3 \\
 \frac{\partial R^{net}_c}{\partial T_c} =
  2( 1 - {\mathcal{T}}_{cL} ) \epsilon 4 \sigma T_c^3
$$</span></p>
<p>Using the above, solve (140) for <span class="math inline"><em>T</em><sub><em>s</em></sub></span> and <span class="math inline"><em>T</em><sub><em>c</em></sub></span>.</p>
<h3 id="case-2-when-there-is-ground-surface-melting">Case 2: When there is ground surface melting</h3>
<p>Melting of the ground surface occurs when there is snow or ice cover on the ground surface and the temperature of the ground surface (<span class="math inline"><em>T</em><sub><em>s</em></sub><sup><em>c</em><em>u</em><em>r</em><em>r</em><em>e</em><em>n</em><em>t</em></sup> = <em>T</em><sub><em>s</em></sub><sup><em>p</em><em>a</em><em>s</em><em>t</em></sup> + <em>Δ</em><em>T</em><sub><em>s</em></sub></span>) is higher than 0 <span class="math inline"><sup>∘</sup></span> C after the solution in Case 1. If there is ground surface melting, the surface temperature is fixed at 0 <span class="math inline"><sup>∘</sup></span> C. In other words, the surface temperature is fixed at 0 <span class="math inline"><sup>∘</sup></span> C,</p>
<p><span class="math display"><em>Δ</em><em>T</em><sub><em>s</em></sub> = <em>Δ</em><em>T</em><sub><em>s</em></sub><sup><em>m</em><em>e</em><em>l</em><em>t</em></sup> = <em>T</em><sub><em>m</em><em>e</em><em>l</em><em>t</em></sub> − <em>T</em><sub><em>s</em></sub><sup><em>p</em><em>a</em><em>s</em><em>t</em></sup></span></p>
<p>is the melting point of ice (0 <span class="math inline"><sup>∘</sup></span> C). <span class="math inline"><em>T</em><sub><em>m</em><em>e</em><em>l</em><em>t</em></sub></span> is the melting point of ice (0 <span class="math inline"><sup>∘</sup></span> C).</p>
<p>Assuming that <span class="math inline"><em>T</em><sub><em>c</em></sub></span> is known, <span class="math inline"><em>Δ</em><em>T</em><sub><em>s</em></sub></span> is obtained by the following equation as well as (140).</p>
<p><span class="math display">$$
 \Delta T_c = \left( - \Delta F_c^{past}
            - \frac{\partial \Delta F_c}{\partial T_s} \Delta T_s^{melt}
              \right) \Bigm/ \frac{\partial \Delta F_c}{\partial T_c}
$$</span></p>
<p>If the <span class="math inline"><em>Δ</em><em>T</em><sub><em>s</em></sub></span> and <span class="math inline"><em>Δ</em><em>T</em><sub><em>c</em></sub></span> are thus known, the energy convergence at the surface used for melting will be</p>
<p><span class="math display">$$
 \Delta F_{conv} =
 - \Delta F_s^{current} = - \Delta F_s^{past}
 - \frac{\partial \Delta F_s}{\partial T_s} \Delta T_s^{melt}
 - \frac{\partial \Delta F_s}{\partial T_c} \Delta T_c
$$</span></p>
<p>It is obtained by.</p>
<h3 id="constraints-on-solutions.">Constraints on solutions.</h3>
<p>We set some constraints on the solution of the surface energy balance. If the condition is violated, the energy balance is re-solved by fixing the violated flux at the limit of the condition to be met.</p>
<ol type="1">
<li>don’t take too much water vapor from the first layer of the atmosphere A large downward latent heat may be generated due to temporary computational instability. Even in such a case, the condition is set so that all the water vapor from the surface to the first layer of the atmosphere is not lost.</li>
</ol>
<p><span class="math display">$$
  Et_{(i,j)}^{current} &gt; - q_a ( P_s - P_a ) / (g \Delta t)
   \ \ \ \ \ (i=1,2 ; j=1,2,3) \\
  E_{Sn}^{current} &gt; - q_a ( P_s - P_a ) / (g \Delta t)
$$</span></p>
<p>Here, <span class="math inline"><em>g</em></span> and <span class="math inline"><em>Δ</em><em>t</em></span> are the acceleration due to gravity and the time step of the atmospheric model. For the values such as <span class="math inline"><em>E</em><em>t</em></span> used in the judgment, an updated flux value (<span class="math inline"><em>c</em><em>u</em><em>r</em><em>r</em><em>e</em><em>n</em><em>t</em></span>) is used with respect to the value of <span class="math inline"><em>T</em><sub><em>s</em></sub></span> and <span class="math inline"><em>T</em><sub><em>c</em></sub></span>, which have been updated to satisfy the energy balance. This is the same for all other cases below. Updating the flux value will be described later.</p>
<ol start="2" type="1">
<li>soil moisture is not negative. Prevent soil moisture from becoming negative through transpiration.</li>
</ol>
<p><span class="math display"><em>E</em><em>t</em><sub>(1, 2)</sub><sup><em>c</em><em>u</em><em>r</em><em>r</em><em>e</em><em>n</em><em>t</em></sup> &lt; ∑<sub><em>k</em> ∈ <em>r</em><em>o</em><em>o</em><em>t</em><em>z</em><em>o</em><em>n</em><em>e</em></sub><em>ρ</em><sub><em>w</em></sub><em>w</em><sub><em>k</em></sub><em>Δ</em><em>z</em><sub><em>g</em>(<em>k</em>)</sub>/<em>Δ</em><em>t</em><sub><em>L</em></sub></span></p>
<p>where <span class="math inline"><em>ρ</em><sub><em>w</em></sub></span> is the density of water and <span class="math inline"><em>Δ</em><em>t</em><sub><em>L</em></sub></span> is the time step of the land surface model.</p>
<ol start="3" type="1">
<li>no negative water content on the canopy Ensure that water on the canopy does not become negative by evaporation.</li>
</ol>
<p><span class="math display"><em>E</em><em>t</em><sub>(<em>i</em>, 3)</sub><sup><em>c</em><em>u</em><em>r</em><em>r</em><em>e</em><em>n</em><em>t</em></sup> &lt; <em>ρ</em><sub><em>w</em></sub><em>w</em><sub><em>c</em></sub>/<em>Δ</em><em>t</em><sub><em>L</em></sub>     (<em>i</em> = 1, 2)</span></p>
<ol start="4" type="1">
<li>the snowpack is not negative Ensure that the snowpack does not become negative due to sublimation of the snowpack.</li>
</ol>
<p><span class="math display"><em>E</em><sub><em>S</em><em>n</em></sub><sup><em>c</em><em>u</em><em>r</em><em>r</em><em>e</em><em>n</em><em>t</em></sup> &lt; <em>S</em><em>n</em>/<em>Δ</em><em>t</em><sub><em>L</em></sub></span></p>
<h3 id="ground-surface-canopy-temperature-update">Ground Surface, Canopy Temperature Update</h3>
<p>Update surface and canopy temperatures.</p>
<p><span class="math display">$$
 T_s^{current} = T_s^{past} + \Delta T_s \\
 T_c^{current} = T_c^{past} + \Delta T_c
$$</span></p>
<p>Based on the updated canopy temperature, it is necessary to diagnose whether the water in the canopy is liquid or solid. This information will be used in the future when dealing with the freeze and thaw of the water on the canopy.</p>
<p><span class="math display">$$
 A_{Snc} = \left\{
\begin{array}{ll}
 0 (T_c \geq T_{melt})\\
 1 (T_c &lt;    T_{melt})
\end{array}
\right.
$$</span></p>
<p>The <span class="math inline"><em>A</em><sub><em>S</em><em>n</em><em>c</em></sub></span> is the freezing area fraction of water on the canopy.</p>
<h3 id="update-the-value-of-the-flux">Update the value of the flux</h3>
<p>Update the flux value with respect to the updated <span class="math inline"><em>T</em><sub><em>s</em></sub></span> and <span class="math inline"><em>T</em><sub><em>c</em></sub></span> values. If you set the <span class="math inline"><em>F</em></span> to an arbitrary flux, updating the value is done as follows</p>
<p><span class="math display">$$
 F^{current} = F^{past} + \frac{\partial F}{\partial T_s} \Delta T_s
                        + \frac{\partial F}{\partial T_c} \Delta T_c
$$</span></p>
<p>The updated flux value is used to calculate the flux output to the atmosphere.</p>
<p><span class="math display">$$
 H = H_s + H_c \\
 E = \sum_{j=1}^3 \sum_{i=1}^2 Et_{(i,j)} + E_{Sn} \\
 R^{\uparrow}_L = {\mathcal{T}}_{cL} \epsilon \sigma T_s^4
 + (1 - {\mathcal{T}}_{cL}) \epsilon \sigma T_c^4
 + (1 - \epsilon) R^{\downarrow}_L \\
 T_{sR} = ( R^{\uparrow}_L / \sigma )^{1/4}
$$</span></p>
<p><span class="math inline"><em>T</em><sub><em>s</em><em>R</em></sub></span> is the radiant temperature of the ground surface.</p>
<p>The root uptake flux of each soil layer is calculated.</p>
<p><span class="math display"><em>F</em><sub><em>r</em><em>o</em><em>o</em><em>t</em>(<em>k</em>)</sub> = <em>f</em><sub><em>r</em><em>o</em><em>o</em><em>t</em><em>u</em><em>p</em>(<em>k</em>)</sub><em>E</em><em>t</em><sub>(1, 2)</sub>    (<em>k</em> = 1, …, <em>K</em><sub><em>g</em></sub>)</span></p>
<p><span class="math inline"><em>F</em><sub><em>r</em><em>o</em><em>o</em><em>t</em>(<em>k</em>)</sub></span> is the weight of the uptake flux of the roots, and <span class="math inline"><em>f</em><sub><em>r</em><em>o</em><em>o</em><em>t</em><em>u</em><em>p</em>(<em>k</em>)</sub></span> is the weight that distributes the transpiration rate to the uptake flux of the roots in each layer.</p>
</body>
</html>
