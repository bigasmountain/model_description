\documentstyle[a4j,fleqn]{jarticle}
\begin{document}
\begin{center}
{\LARGE \bf 
陸面過程パラメタリゼーション\\
``Minimal Advanced Treatments of Surface Interaction and RunOff
(MATSIRO)''\\
の記述
}
\bigskip \\
{\Large \bf
2001年 11月 10日 \medskip\\
江守 正多\footnote{独立行政法人国立環境研究所より出向中}
\\
(地球フロンティア研究システム)
\bigskip \\
}
\end{center}
\section{はじめに}
Minimal Advanced Treatments of Surface Interaction and RunOff
(MATSIRO) は, 全球気候モデル CCSR/NIES AGCM, その他のモデルに導入すること
を目的に開発された陸面過程パラメタリゼーションである. 
MATSIRO は, 主としてグリッドスケール数10km 以上の大気モデルと結合して, 1ヵ
月から数100年の長期間積分を行うような気候計算に用いられることを目的とし
て設計されている. 
大気陸面系の水・エネルギー循環過程の中で, このような時空間スケールにおい
て考慮されるべき過程ができる限り適切に表現でき, しかも結果の解釈が容易で
あるようにそれらができる限り簡潔にモデル化されることを開発の上での留意点
とした. 
MATSIRO の開発は, CCSR/NIES AGCM5.4g の陸面サブモデルをベースに,
Watanabe(1994)の植生キャノピーパラメタリゼーションを結合し, 同時に積雪, 
流出などの過程を改良することにより行われた. 
その後, AGCM の構成の変更に伴い, フラックスカプラーへの対応, 並列化対応
を経て, 現在の AGCM5.6 に対応したものになっている. 
植生の生理過程としては, 初期には気孔抵抗に Jarvis 型の関数を用いていたが,
近年の気候−生態系相互作用研究の進展により世界中で準標準的に用いられるよ
うになった Farquhar 型の光合成スキームを SiB2 のコードから移植した. 

\section{MATSIRO の構成}

\subsection{MATSIRO 全体}

\subsubsection{全体の構成}

MATSIRO の構成は, 
\begin{itemize}
\item フラックス計算部 (LNDFLX)
\item 陸面積分部 (LNDSTP)
\end{itemize}
の二つに分かれる. 
これは, AGCM5.6 の標準陸面過程ルーチンと同様である. 

フラックス計算部は, 大気モデルの物理過程の一部として, 大気モデルの時間ス
テップで呼ばれる. 
これに対して, 陸面積分部は, 大気モデルや海洋モデルと対等な陸面モデルとし
て, 結合モデルメインルーチンから呼ばれる. 時間ステップは大気モデルとは独
立に設定される. 

フラックス計算部と陸面積分部の間のデータのやり取りは, フラックスカプラー
を通して行われる. 
フラックス計算部では, グリッド内の積雪面と無雪面を別々に取扱い, それぞれ
についての地表フラックスを求める. これを積雪面と無雪面の面積比で重み付け
平均したものが, フラックスカプラーを通じて陸面積分部に渡される. 
この際, 時間的な平均操作も同時に行われる. 

プログラム上は, ドライバープログラム (matdrv.F) の中にフラックス計算部の
エントリ LNDFLX と陸面積分部のエントリ LNDSTP があり, それぞれから必要な
諸過程のサブルーチンが呼ばれる. LNDFLX と LNDSTP は MATSIRO の内部変数を
共有する. 

\subsubsection{MATSIRO の内部変数}

MATSIRO は内部変数として以下を持つ. 

\begin{tabular}{llll}
$T_{s(l)}$      & $(l=1,2)$           & 地表温度 & [K]\\
$T_{c(l)}$      & $(l=1,2)$           & キャノピー温度 & [K]\\
\\
$T_{g(k)}$      & $(k=1,\ldots,K_g)$  & 土壌温度 & [K]\\
$w_{(k)} $      & $(k=1,\ldots,K_g)$  & 土壌水分量 & [m$^3$/m$^3$]\\
$w_{i(k)}$      & $(k=1,\ldots,K_g)$  & 凍結土壌水分量 & [m$^3$/m$^3$]\\
\\
$w_c$         &                     & キャノピー上水分量 & [m]\\
$Sn$          &                     & 積雪量 & [kg/m$^2$]\\      
$T_{Sn(k)}$      & $(k=1,\ldots,K_{Sn})$  & 積雪温度 & [K]\\
$\alpha_{Sn(b)}$ & $(b=1,2,3)$         & 積雪アルベド & [$-$]
\end{tabular}
\medskip

ここで, $l=1,2$ はそれぞれ無雪域と積雪域, $k$ は土壌や積雪の鉛直層番号
(最上層が 1 で, 下に向かって増える), $K_g$ は土壌層数, $K_{Sn}$ は積雪層数,
$b=1,2,3$ はそれぞれ可視, 近赤外, 赤外の波長帯を表す. 

標準では土壌は５層であり, 各層の厚さは上から 5cm, 20cm, 75cm, 1m, 2m に
とる. 土壌温度, 土壌水分量および凍結土壌水分量の定義点は同じである. 

積雪は可変層数で, 積雪量の増加に伴い層数を増やす. 標準では最大３層である. 

地表温度とキャノピー温度は熱容量を持たない, いわゆる skin 温度であるが,
形式的に予報変数である (今の計算方法では前のステップの値で評価した安定度
などを使うため, 前のステップの値に依存する. もしも更新した値で安定度など
を評価して収束するまで繰り返し計算を行うとすれば, 前のステップの値に依存
しない完全な診断変数になる). その他の変数はいずれも前のステップの値を必
ず必要とする予報変数である. 

地表温度とキャノピー温度はフラックス計算部において更新される. 
それ以外の変数(本来の予報変数)は, 全て陸面積分部において更新される. 

\subsection{フラックス計算部}

\subsubsection{フラックス計算部の構成}

フラックス計算部は以下の手順で進む. 
\begin{enumerate}
 \item 入力変数をカプラーから受け取る. 
 \item サブグリッドの積雪面積率を診断する. 
 \item 無雪域($l=1$)と積雪域($l=2$)のそれぞれについて, 諸過程のサブルー
       チンを呼び出し, フラックスの計算を行うとともに地表温度とキャノピー
       温度を更新する. 具体的には, 以下のサブルーチンが順に呼ばれる. 
   \begin{enumerate}
    \item MATLAI\ \ 植生形状パラメタ(LAI, 植生高)のセット
    \item MATRAD\ \ 放射パラメタ(アルベド, 植生透過率など)の計算
    \item MATBLK\ \ 乱流パラメタ(バルク係数)の計算 (運動量および熱)
    \item MATRST\ \ 気孔抵抗, 裸地面蒸発抵抗などの計算
    \item MATBLQ\ \ 乱流パラメタ(バルク係数)の計算 (水蒸気)
    \item MATFLX\ \ 地表フラックスの計算
    \item MATGHC\ \ 地中熱伝導の計算
    \item MATSHB\ \ 地表面・キャノピーのエネルギーバランスを解く
   \end{enumerate}
 \item 出力変数をカプラ−へ渡す. 
 \item ヒストリ出力変数の登録と足しこみを行う. 
\end{enumerate}

(a)〜(e) は境界値サブモデルに分類され, プログラムは matbnd.F にまとめら
れている. 

(f)〜(h) は地表サブモデルに分類され, プログラムは matsfc.F にまとめられ
ている. 

(d)から光合成スキーム MATPHT が呼ばれる. 光合成スキームは matpht.F にま
とめられている. 

\subsubsection{フラックス計算部の入力変数}

フラックス計算部へは以下の変数が入力される. 

\begin{tabular}{llll}
$u_a$          &                     & 大気第1層東西風 & [m/s] \\
$v_a$          &                     & 大気第1層南北風 & [m/s] \\
$T_a$          &                     & 大気第1層気温   & [K]   \\
$q_a$          &                     & 大気第1層比湿   & [kg/kg]\\
$P_a$          &                     & 大気第1層気圧   & [Pa]  \\
$P_s$          &                     & 地表気圧        & [Pa]  \\
\\
$R^{\downarrow}_{(d,b)}$ & $(d=1,2;b=1,2,3)$ & 地表下向き放射フラックス & [W/m$^2$]\\
$\cos\zeta$    &                     & 太陽天頂角の余弦 & [$-$]\\
\end{tabular}
\medskip

ここで, $d=1,2$ はそれぞれ直達と散乱, $b=1,2,3$ はそれぞれ可視, 近赤外, 赤外の波長帯を表す. 

\subsubsection{フラックス計算部の出力変数}

フラックス計算部からは以下の変数が出力される. 

\begin{tabular}{llll}
$\tau_x$       &                     & 地表東西風ストレス & [N/m$^2$] \\
$\tau_y$       &                     & 地表南北風ストレス & [N/m$^2$] \\
$H$            &                     & 地表顕熱フラックス & [W/m$^2$] \\
$E$            &                     & 地表水蒸気フラックス & [kg/m$^2$/s] \\
$R^{\uparrow}_S$ &                  & 地表上向き短波放射フラックス & [W/m$^2$]\\
$R^{\uparrow}_L$ &                  & 地表上向き長波放射フラックス & [W/m$^2$]\\
$\alpha_{s(b)}$ & $(b=1,2,3)$         & 地表アルベド   & [$-$] \\
$T_{sR}$      &                     & 地表放射温度   & [K]   \\
$F_{g(1/2)}$      &                     & 地表熱伝導フラックス & [W/m$^2$] \\
$F_{Sn(1/2)}$     &                     & 積雪面熱伝導フラックス & [W/m$^2$] \\
$Et_{(i,j)}$   & $(i=1,2;j=1,2,3)$   & 蒸発散各成分   & [kg/m$^2$/s] \\
$\Delta F_{conv}$&                     & 地表面エネルギー収束 & [W/m$^2$] \\
$F_{root(k)}$      & $(k=1,\ldots,K_g)$  & 根の吸い上げフラックス & [kg/m$^2$/s] \\
$LAI$          &                     & 葉面積指数 & [m$^2$/m$^2$] \\
$A_{Snc}$     &                     & キャノピー凍結面積率 & [$-$] \\
\end{tabular}
\medskip

ここで, 蒸発散の $i=1,2$ はそれぞれ液体および固体を, $j=1,2,3$ はそれぞ
れ裸地面(林床)蒸発, 蒸散, キャノピー上水分の蒸発を表す. それ以外の添え字
については前出と同じである. 

\subsection{陸面積分部}

\subsubsection{陸面積分部の構成}

陸面積分部は以下の手順で進む. 
\begin{enumerate}
 \item 入力変数をカプラーから受け取る. 
 \item 諸過程のサブルーチンを呼び出し, 陸面予報変数を更新する. 具体的に
       は, 以下のサブルーチンが順に呼ばれる. 
   \begin{enumerate}
    \item MATCNW\ \ キャノピーの水収支の計算
    \item MATSNW\ \ 積雪量, 積雪温度, 積雪アルベドの計算
    \item MATROF\ \ 流出量の計算
    \item MATGND\ \ 土壌温度, 土壌水分, 凍土の計算
   \end{enumerate}
 \item 出力変数をカプラ−へ渡す. 
 \item ヒストリ出力変数の登録と足しこみを行う. 
\end{enumerate}

陸面積分部のメインから呼ばれる各サブルーチンは, それぞれが一つのサブモデ
ルを構成する. 各サブモデルのプログラムは, それぞれが１つのファイルにまと
められている. 具体的には以下のようである. 

\begin{itemize}
 \item MATCNW (matcnw.F) キャノピー水収支サブモデル
 \item MATSNW (matsnw.F) 積雪サブモデル
 \item MATROF (matrof.F) 流出サブモデル
 \item MATGND (matgnd.F) 土壌サブモデル
\end{itemize}

サブモデルは基本的にこの順に実行されるが, 必要に応じて, 他のサブモデルの
管理するパラメータの値を参照するために, サブモデル間でサブルーチンを呼び
合うことがある. 
また, フラックス計算部から, 同様の目的で上記サブモデル内のサブルーチンが
呼ばれることがある. 

\subsubsection{陸面積分部の入力変数}

陸面積分部へは以下の変数が入力される. 

\begin{tabular}{llll}
$Pr_{c}$       &                     & 対流性降雨フラックス & [kg/m$^2$/s] \\
$Pr_{l}$       &                     & 層状性降雨フラックス & [kg/m$^2$/s] \\
$P_{Snc}$      &                     & 対流性降雪フラックス & [kg/m$^2$/s] \\
$P_{Snl}$      &                     & 層状性降雪フラックス & [kg/m$^2$/s] \\
$F_{g(1/2)}$      &                     & 地表熱伝導フラックス & [W/m$^2$] \\
$F_{Sn(1/2)}$     &                     & 積雪面熱伝導フラックス & [W/m$^2$] \\
$Et_{(i,j)}$   & $(i=1,2;j=1,2,3)$   & 蒸発散各成分   & [kg/m$^2$/s] \\
$\Delta F_{conv}$&                     & 地表面エネルギー収束 & [W/m$^2$] \\
$F_{root(k)}$      & $(k=1,\ldots,K_g)$  & 根の吸い上げフラックス & [kg/m$^2$/s] \\
$LAI$          &                     & 葉面積指数 & [m$^2$/m$^2$] \\
$A_{Snc}$     &                     & キャノピー凍結面積率 & [$-$] \\
\end{tabular}
\medskip

\subsubsection{陸面積分部の出力変数}

陸面積分部からは以下の変数が出力される. 

\begin{tabular}{llll}
$Ro$           &                     & 流出量             & [kg/m$^2$/s] \\
\end{tabular}
\medskip

流出量は, 河道網モデルの入力変数として使われる. 

\subsection{外部パラメタ}

MATSIRO の実行に必要な外部パラメタは, 各グリッドのパラメタ値を水平分布
(マップ)によって与えるものと, 土地被覆タイプごともしくは土壌タイプごとの
パラメタ値をテーブルによって与えるものの２種類に大別される. 土地被覆タイ
プと土壌タイプはマップにより与えられるパラメタの一つであり, これを通じて,
テーブルにより与えられる各パラメタが各グリッドに割り当てられる. すなわち, 
\begin{quote}
 マップにより与えられるパラメタ
 \[
 \phi(i,j)
 \]
 テーブルにより与えられるパラメタ
 \[
 \psi(I), \ \ I = I_L(i,j)
 \]
もしくは
 \[
 \psi(I), \ \ I = I_S(i,j)
 \]
\end{quote}
のようである. ここで, $(i,j)$ はグリッドの水平位置のインデックス, $I_L$
は土地利用タイプ, $I_S$ は土壌タイプである. 

\subsubsection{マップにより与えられる外部パラメタ}

マップにより与えられる外部パラメタの種類は以下のとおりである. 

\begin{tabular}{lllll}
 $I_L$ & & 土地被覆タイプ   & 定数 & [-] \\
 $I_S$ & & 土壌タイプ       & 定数 & [-] \\
 $LAI_0$ & & 葉面積指数 (LAI) & 月毎 & [m$^2$/m$^2$] \\
 $\alpha_{0(b)}$ & $(b=1,2,3)$ & 地表面(林床)アルベド & 定数 & [-] \\
 $\tan\beta_{s}$ & & 地表平均傾斜の正接 & 定数 & [-] \\
 $\sigma_z$ & & 標高標準偏差 & 定数 & [m]
\end{tabular}

\subsubsection{土地被覆タイプごとのテーブルにより与えられる外部パラメタ}

土地被覆タイプごとのテーブルにより与えられる外部パラメタは以下のとおりで
ある. 

\begin{tabular}{llll}
$h_0$ & & 植生高 & [m] \\
$h_{B0}$ & & キャノピー底面の高さ & [m] \\
$r_{f(b)}$ & ($b$=1,2) & 個葉の反射率 & [-] \\
$t_{f(b)}$ & ($b$=1,2) & 個葉の透過率 & [-] \\
$f_{root(k)}$ & ($k=1,\ldots,K_g$) & 根の存在比率 & [-] \\
$c_d$ & & 個葉と大気との運動量交換係数 & [-] \\
$c_h$ & & 個葉と大気との熱交換係数 & [-] \\
$f_V$ & & 植生被覆率 & [-] \\
$V_{\max}$ & & Rubisco 反応容量 & [m/s] \\
$m$ & & $A_n$--$g_s$ 関係の傾き & [-] \\
$b$ & & $A_n$--$g_s$ 関係の切片 & [m/s] \\
$\epsilon_3$, $\epsilon_4$ & & 光子あたりの光合成効率 & [m/s/mol] \\
$\theta_{ce}$ & & $w_c$ と $w_e$ の結合係数 & [-] \\
$\theta_{ps}$ & & $w_p$ と $w_s$ の結合係数 & [-] \\
$f_d$ & & 呼吸係数 & [-] \\
$s_2$ & & 高温抑制の臨界温度 & [K] \\
$s_4$ & & 低温抑制の臨界温度 & [K]
\end{tabular}

\subsubsection{土壌タイプごとのテーブルにより与えられる外部パラメタ}

土地被覆ごとのテーブルにより与えられる外部パラメタは以下のとおりである. 

\begin{tabular}{llll}
$c_{g(k)}$ & ($k=1,\ldots,K_g$) & 土壌の比熱 & [J/m$^3$] \\
$k_{g(k)}$ & ($k=1,\ldots,K_g$) & 土壌の熱伝導率 & [W/m/K] \\
$w_{sat(k)}$ & ($k=1,\ldots,K_g$) & 土壌の空隙率 & [m$^3$/m$^3$] \\
$K_{s(k)}$ & ($k=1,\ldots,K_g$) & 土壌の飽和透水係数 & [m/s] \\
$\psi_{s(k)}$ & ($k=1,\ldots,K_g$) & 土壌の飽和水分ポテンシャル & [m] \\
$b_{(k)}$ & ($k=1,\ldots,K_g$) & 土壌の水分ポテンシャル曲線の指数 & [-]
\end{tabular}

\section{境界値サブモデル MATBND}

\subsection{植生形状パラメタのセット}

植生形状パラメタとして, 葉面積指数(LAI), 植生高などのセットを行う. 

LAI は季節変化する水平分布を, キャノピー上端及び下端の高さは土地利用タイ
プごとの値を外部パラメタとして読み込む. 
積雪がある場合には, 積雪深よりも上に出ている部分の植生のみを考え, 形状パ
ラメータを補正する. 
\begin{eqnarray}
 h &=& \max( h_0 - D_{Sn}, 0 ) \\
 h_B &=& \max( h_{B0} - D_{Sn}, 0 ) \\
 LAI &=& LAI_0 \frac{h-h_B}{h_0-h_{B0}}
\end{eqnarray}
ここで, $h$ はキャノピー上端の高さ(植生高), $h_B$ はキャノピー下端
の高さ(枯れ上がり高さ), $LAI$ は葉面積指数であり, $h_0$, $h_{B0}$,
$LAI_0$ はそれぞれの雪の無いときの値である. $D_{Sn}$ は積雪深である. キャ
ノピー上端と下端の間で LAI が鉛直一様に分布していると近似したことになっ
ている. 

コーディング上は, この後, 積雪面積率 $A_{Sn}$ で重み付けした無雪面と積雪
面の平均値
\[
 h = A_{Sn} h + ( 1 - A_{Sn} ) h_0
\]
などを求めるようになっているが, 無雪面と積雪面は別々に計算するため,
$A_{Sn}$ には $0$ (無雪面) か $1$ (積雪面) のどちらかの値が入っており,
値の混合はここでは起こらないことに注意されたい (後に同様の個所が複数あ
る). 

\subsection{放射パラメタの計算}

放射パラメタ(アルベド, 植生透過率など)の計算を行う. 

\subsubsection{地表面(林床)アルベドの計算}

地表面(林床)アルベド $\alpha_{0(b)}\ \ (b=1,2)$ の水平分布を外部パラメタ
として読み込む. $b=1, 2$ はそれぞれ可視, 近赤外の波長帯を表す. 
また, 赤外の地表面アルベド $\alpha_{0(3)}$ を一定値にセットする(水平分布
を用意してもよい). 

氷床面と積雪面については, アルベドの入射角依存性を以下の関数形により考慮
する. 
\begin{eqnarray}
 \alpha_{0(d,b)} = \hat{\alpha}_{0(b)} + ( 1 - \hat{\alpha}_{0(b)} ) 
                         \cdot 0.4 ( 1 - \cos \phi_{in(d)} )^5
\end{eqnarray}
ここで, $b=1,2$ は波長帯, $d=1,2$ はそれぞれ直達, 散乱,
$\hat{\alpha}_{0(b)}$ は, 入射角が$0$ (真上から) のときのアルベドの値であ
る. $\cos \psi_{in(d)}$ は入射角の余弦であり, 直達光と散乱光のそれぞれに
対して, 
\begin{eqnarray}
 \cos\psi_{in(1)} = \cos\zeta, \ \ \ 
 \cos\psi_{in(2)} = \cos 50^{\circ}
\end{eqnarray}
を与える. $\zeta$ は太陽天頂角である. 

氷床面, 積雪面以外については, 地表面(林床)のアルベドは天頂角依存性を考え
ず, 直達光と散乱光に対して同じ値を与える. すなわち以下のようである. 
\begin{eqnarray}
 \alpha_{0(d,b)} = \alpha_{0(b)}\ \ \ (d=1,2;\ b=1,2)
\end{eqnarray}
また, 赤外の波長に対しては散乱光のみを考えればよい. 赤外のアルベドは全て
の地表面において天頂角に依存しない値を与える. 
\begin{eqnarray}
 \alpha_{0(2,3)} = \alpha_{0(3)}
\end{eqnarray}

\subsubsection{キャノピーのアルベドと透過率の計算}

キャノピーのアルベドと透過率の計算は, 渡辺・大谷(1995) のキャノピー層内
の放射計算に基づく. 

鉛直に一様なキャノピーを考え, さらにいくつかの簡略化の仮定を置くと, キャ
ノピー内の日射の伝達方程式と境界条件は以下で表される. 
\begin{eqnarray}
 \frac{dS^{\downarrow}_d}{dL} &=& -F \sec\zeta S^{\downarrow}_d \\
 \frac{dS^{\downarrow}_r}{dL} &=& -F (1-t_{f(b)})d_f S^{\downarrow}_r
                                  +F t_{f(b)} \sec\zeta S^{\downarrow}_d 
                                  +F r_{f(b)} d_f S^{\uparrow}_r \\
 \frac{dS^{\uparrow}_r}{dL}   &=&  F (1-t_{f(b)})d_f S^{\uparrow}_r
                                  -F r_{f(b)} ( d_f S^{\downarrow}_r 
                                         + \sec\zeta S^{\downarrow}_d ) \\
 S^{\downarrow}_d(0) &=& S^{top}_d \\
 S^{\downarrow}_r(0) &=& S^{top}_r \\
 S^{\uparrow}_r(LAI) &=& \alpha_{0(1,b)}S^{\downarrow}_d(LAI)
                       + \alpha_{0(2,b)}S^{\downarrow}_r(LAI)
\end{eqnarray}
ここで, $S^{\downarrow}_d$ は下向き直達光, $S^{\uparrow}_r$ と
$S^{\downarrow}_r$ はそれぞれ上向きと下向きの散乱光, $L$ はキャノピー上
端から下向きに積算した葉面積, $d_f$ は散光因子($=\sec 53^{\circ}$),
$r_{f(b)}$ と $t_{f(b)}$ はそれぞれ葉面の反射率と透過率(散乱光と直達光に対して同じ
値を用いる), $F$ は放射に対する葉の向きを表すファクターである. ここでは簡
略化のため葉の向きの分布はランダム($F=0.5$)とする. 

これらは解析的に解くことができ, 解は以下のようになる. 
\begin{eqnarray}
 S^{\downarrow}_d(L) &=& S^{top}_d \exp(-F\cdot L\cdot \sec\zeta) \\
 S^{\downarrow}_r(L) &=& C_1 e^{a L} + C_2 e^{-a L} + C_3 S^{\downarrow}_d(L) \\
 S^{\uparrow}_r(L)   &=& A_1 C_1 e^{a L} + A_2 C_2 e^{-a L} + C_4 S^{\downarrow}_d(L) 
\end{eqnarray}
ここで, 
\begin{eqnarray}
   a &=& F d_f [(1-t_{f(b)})^2 - r_{f(b)}^2]^{1/2} \label{atn} \\
 A_1 &=& \{ 1 - t_{f(b)} + [(1-t_{f(b)})^2 - r_{f(b)}^2]^{1/2}\} / r_{f(b)} \\
 A_2 &=& \{ 1 - t_{f(b)} - [(1-t_{f(b)})^2 - r_{f(b)}^2]^{1/2}\} / r_{f(b)} \\
 A_3 &=& (A_1 - \alpha_{0(2,b)}) e^{ a LAI }  
        -(A_2 - \alpha_{0(2,b)}) e^{-a LAI } \\
 C_1 &=& \{ -(A_2 - \alpha_{0(2,b)}) e^{-a LAI} (S^{top}_r - C_3 S^{top}_d)
            +[C_3\alpha_{0(2,b)}+\alpha_{0(1,b)}-C_4]S^{\downarrow}_d(LAI)\} / A_3 \\
 C_2 &=& \{  (A_1 - \alpha_{0(2,b)}) e^{ a LAI} (S^{top}_r - C_3 S^{top}_d)
            -[C_3\alpha_{0(2,b)}+\alpha_{0(1,b)}-C_4]S^{\downarrow}_d(LAI)\} / A_3 \\
 C_3 &=& \frac{\sec\zeta[t_{f(b)}\sec\zeta + d_f t_{f(b)}(1-t_{f(b)}) + d_f r_{f(b)}^2]}
              {d_f^2[(1-t_{f(b)})^2-r_{f(b)}^2]-\sec^2\zeta} \\
 C_4 &=& \frac{r_{f(b)}(d_f - \sec\zeta)\sec\zeta}
              {d_f^2[(1-t_{f(b)})^2-r_{f(b)}^2]-\sec^2\zeta}
\end{eqnarray}
である. 

キャノピー上端で見たアルベド $\alpha_s$ は, 
\begin{eqnarray}
 S^{\uparrow}_r(0) = \alpha_{s(1,b)} S^{\downarrow}_d(0)
                   + \alpha_{s(2,b)} S^{\downarrow}_r(0)
\end{eqnarray}
であるから, 
\begin{eqnarray}
 \alpha_{s(2,b)} &=& \{ A_2 ( A_1 - \alpha_{0(2,b)}) e^{ a LAI } 
                      - A_1 ( A_2 - \alpha_{0(2,b)}) e^{-a LAI } 
                   \} / A_3 \\
 \alpha_{s(1,b)} &=& - C_3 \alpha_{s(2,b)} + C_4
                  + ( A_1 - A_2 ) ( C_3 \alpha_{0(2,b)} + \alpha_{0(1,b)} -C_4)
                  e^{- F\cdot LAI\cdot \sec\zeta} / A_3
\end{eqnarray}
を得る. 

また, キャノピーの透過率 ${\cal{T}}_c$ (正確には, キャノピー上端の入射光
のうち林床が吸収する割合)を
\begin{eqnarray}
 S^{\downarrow}_d(LAI) + S^{\downarrow}_r(LAI) - S^{\uparrow}_r(LAI) 
= {\cal{T}}_{c(1,b)} S^{\downarrow}_d(0) 
+ {\cal{T}}_{c(2,b)} S^{\downarrow}_r(0) 
\end{eqnarray}
で定義すると, 
\begin{eqnarray}
  {\cal{T}}_{c(2,b)}&=& \{ ( 1 - A_2 )( A_1 - \alpha_{0(2,b)} )
                      - ( 1 - A_1 )( A_2 - \alpha_{0(2,b)} ) \} / A_3 \\
 {\cal{T}}_{c(1,b)}&=& - C_3 {\cal{T}}_{c(2,b)} \nonumber \\
& + &              \{ ( C_3 \alpha_{0(2,b)} + \alpha_{0(1,b)} -C_4 )
                   ( ( 1 - A_1 ) e^{ a LAI } 
                   - ( 1 - A_2 ) e^{-a LAI } )  / A_3
                   + C_3 - C_4 +1 \} e^{- F\cdot LAI\cdot \sec\zeta}
\nonumber \\
\end{eqnarray}                   
を得る. 
以上を $b=1, 2$ (可視と近赤外) についてそれぞれ行う. 

葉面の反射率$r_f$と透過率$t_f$ は, 土地被覆タイプごとの外部パラメタとし
て読み込むが, 上記の計算に用いる前に以下の２つの修正を行う. 
\begin{enumerate}
 \item 葉面上の雪(氷)の効果 \\
 キャノピー温度が 0$^{\circ}$C 以下の場合, キャノピー上水分を雪(氷)と見な
 す. このとき, 雪のアルベド $\alpha_{Sn(b)}$ とキャノピー上水分量 $w_c$
 を用いて, 
\begin{eqnarray}
 r_{f(b)} &=& ( 1 - f_{cwet} ) r_{f(b)} 
         + f_{cwet} \alpha_{Sn(b)} \\
 && f_{cwet} = {w_c}/w_{c,cap}
\end{eqnarray}
 とする. $w_{c,cap}$ はキャノピー上水分容量である. 
 透過率については, 吸収率 ($1-r_f-t_f$) が負にならないように, 便宜的に
\begin{equation}
 t_{f(b)} = ( 1 - f_{cwet} ) t_{f(b)} 
         + f_{cwet} t_{Sn(b)}, \ \ \ 
 t_{Sn(b)} = \min( 0.5(1 - \alpha_{Sn(b)}), t_{f(b)} )
\end{equation}
 とする. 
 キャノピー上水分が液体のときには, それによる葉面の放射パラメタの変化は
 無視する. 
 また, キャノピーが降雪を捕捉した場合(雪)と, キャノピー上の液体水が凍っ
 た場合(氷)が考えられ, それぞれの放射特性は異なるであろうが, ここでは全
 て林床の積雪と同じアルベドを用いる. 
 \item 反射・透過の向きを考慮する効果 \\
 上述の方程式の解では, 反射光は全て入射して来た向きに戻ることが仮定され
 ているが, 例えばその一部が入射光と同じ向きに散乱されることを考慮すると, 
 葉面の放射パラメタを以下のように置き換えればよい (渡辺, 私信). 
\begin{eqnarray}
  r_{f(b)} &=& 0.75 r_{f(b)} + 0.25 t_{f(b)} \\
  t_{f(b)} &=& 0.75 t_{f(b)} + 0.25 r_{f(b)}
\end{eqnarray}
\end{enumerate}
以上は $b=1, 2$ (可視と近赤外) についてそれぞれ行う. 

また, 植生がグリッドの一部に偏在している場合(サバンナなど)を考慮して, ア
ルベドなどの計算に先立って, 
\begin{equation}
  LAI = LAI / f_V 
\end{equation}
として, 植生被覆部分の LAI (もとの LAI はグリッド平均値と考えて) を求め,
これを前述のアルベドなどの計算に用いる. 
$f_V$ はグリッド中の植生被覆率である. 
アルベドなどが求まった後に, 
\begin{eqnarray}
  \alpha_{s(d,b)} &=& f_V \alpha_{s(d,b)} 
                       + ( 1 - f_V ) \alpha_{0(d,b)} \\
  {\cal{T}}_{c(d,b)} &=& f_V {\cal{T}}_{c(d,b)} 
                       + ( 1 - f_V ) ( 1 - \alpha_{0(d,b)} )
\end{eqnarray}
のように, 植生被覆部分と非植生被覆部分の面積重み付け平均を取る. 

\subsubsection{地表面放射フラックスなどの計算}

地表下向き放射フラックス $R^{\downarrow}_{(d,b)}$ と上で求めたアルベドな
どを用いて, 以下の放射フラックスを求める. 
\begin{eqnarray}
 R^{\downarrow}_S &=& \sum_{b=1}^2\sum_{d=1}^2 R^{\downarrow}_{(d,b)} \\
 R^{\uparrow}_S &=& \sum_{b=1}^2\sum_{d=1}^2 \alpha_{s(d,b)} R^{\downarrow}_{(d,b)} \\
 R^{\downarrow}_L &=& R^{\downarrow}_{(2,3)} \\
 R^{gnd}_S &=& \sum_{b=1}^2\sum_{d=1}^2 {\cal{T}}_{s(d,b)} R^{\downarrow}_{(d,b)} \\
 PAR &=& \sum_{d=1}^2 R^{\downarrow}_{(d,1)}
\end{eqnarray}
ここで, $R^{\downarrow}_S$, $R^{\uparrow}_S$ はそれぞれ下向き及び上向き
の短波放射フラックス, $R^{\downarrow}_L$ は下向き長波放射フラックス, 
$R^{gnd}_S$ は林床が吸収する短波放射フラックス, $PAR$ は下向き光合成有効
放射(PAR)フラックスである. 

また, 短波と長波のキャノピー透過率および長波の射出率を以下のように求める. 
\begin{eqnarray}
 {\cal{T}}_{cS} &=& R^{gnd}_S / ( R^{\downarrow}_S - R^{\uparrow}_S ) \\
 {\cal{T}}_{cL} &=& \exp( - F \cdot LAI \cdot d_f ) \\
 \epsilon &=& 1 - \alpha_{s(2,3)}
\end{eqnarray}

\subsection{乱流パラメタ(バルク係数)の計算}

乱流パラメタ(バルク係数)の計算を行う. 

\subsubsection{運動量と熱に対する粗度の計算}

粗度の計算は, Watanabe(1994)に基づく. Watanabe(1994) では, Kondo and
Watanabe(1992) の多層キャノピーモデルの結果を用いて, それにベストフィッ
トするバルクモデルの粗度の関数形として以下を提案している. 

\begin{eqnarray}
 \left(\ln \frac{h-d}{z_0}\right)^{-1} &=&
 \left[ 1 - \exp( -A^+) + \left(-\ln \frac{z_{0s}}{h}\right)^{-1/0.45}
  \exp(-2A^+)\right]^{0.45} \\
 \left(\ln \frac{h-d}{z_T^{\dagger}}\right)^{-1} &=&
 \frac{1}{-\ln(z_{Ts}/h)} \left[ \frac{P_1}{P_1 + A^+ \exp({A^+})}\right] ^{P2} \\
 \left(\ln \frac{h-d}{z_0}\right)^{-1} \left(\ln \frac{h-d}{z_T}\right)^{-1}
 &=& C_T^{\infty} \left[1-\exp(-P_3 A^+) 
  + \left(\frac{C_T^0}{C_T^{\infty}}\right)^{1/0.9} \exp(-P_4 A^+)\right]^{0.9} \\
 h-d &=& h [1-\exp(-A^+)] / {A^+} \\
 A^+ &=& \frac{c_d LAI}{2k^2} \\
 \frac1{C_T^0} &=& \ln \frac{h-d}{z_0} \ln \frac{h-d}{z_T^{\dagger}} \\
 C_T^{\infty} &=& \frac{-1+(1+8F_T)^{1/2}}{2} \\
 P_1 &=& 0.0115 \left(\frac{z_{Ts}}{h}\right)^{0.1} 
  \exp\left[5 \left(\frac{z_{Ts}}{h}\right)^{0.22}\right] \\
 P_2 &=& 0.55 \exp\left[-0.58 \left(\frac{z_{Ts}}{h}\right)^{0.35}\right] \\
 P_3 &=& [F_T + 0.084 \exp(-15 F_T)]^{0.15} \\
 P_4 &=& 2 F_T^{1.1} \\
 F_T &=& c_h / c_d
\end{eqnarray}
ここで, $z_0$, $z_T$ はそれぞれ運動量および熱に対するキャノピー全体の粗
度, $z_0s$, $z_Ts$ はそれぞれ運動量および熱に対する地表面(林床)の粗度, 
$c_d$, $c_h$ はそれぞれ運動量および熱に対する個葉と大気の間の交換係数, 
$h$ は植生高, $d$ はゼロ面変位, $LAI$ は LAI である. 
$z_T^{\dagger}$ は葉面における熱の出入りが無いとした場合の熱に対する粗度
であり, 林床からの熱の輸送係数を求める際に用いられる. 

$z_{0s}$ および $z_{Ts}$ は, 土地被覆タイプごとの外部データとして与えられる
が, 標準では土地被覆タイプによらず一定値 ($z_{0s}=0.05$m,
$z_{Ts}=0.005$m ) を与えている. 
ただし, 積雪面については以下の修正を施す. 
\begin{eqnarray}
 z_{0s} &=& \max( f_{Sn} z_{0s}, z_{0Sn} ) \\
 z_{Ts} &=& \max( f_{Sn} z_{0s}, z_{TSn} ) \\
        &&  f_{Sn} = 1 - D_{Sn} / z_{0s}
\end{eqnarray}
ここで, $D_{Sn}$ は積雪深, $z_{0Sn}$, $z_{TSn}$ は, それぞれ運動量と熱に
対する積雪面の粗度である. 

$c_d$ および $c_h$ は葉の形状により決まるパラメタであり, 土地被覆タイプ
ごとの外部データとして与える. 

\subsubsection{運動量と熱に対するバルク係数の計算}

バルク係数も Watanabe(1994)にならい, Monin-Obukhov の相似則を用いて, 以
下のように求める. 
\begin{eqnarray}
 C_M &=& k^2 \left[ \ln \frac{z_a-d}{z_0} + \Psi_m(\zeta) \right]^{-2} \\
 C_H &=& k^2 \left[ \ln \frac{z_a-d}{z_0} + \Psi_m(\zeta) \right]^{-1}
             \left[ \ln \frac{z_a-d}{z_T} + \Psi_h(\zeta) \right]^{-1} \\
 C_{Hs} &=& k^2 \left[ \ln \frac{z_a-d}{z_0} + \Psi_m(\zeta_g) \right]^{-1}
             \left[ \ln \frac{z_a-d}{z_T^{\dagger}} + \Psi_h(\zeta_g) \right]^{-1} \\
 C_{Hc} &=& C_H - C_{Hs}
\end{eqnarray}
ここで, $C_M$, $C_H$ はそれぞれ運動量と熱に対するキャノピー全体(葉面$+$
林床)のバルク係数, $C_{Hs}$ は熱に対する地表面(林床)フラックスのバルク係
数, $C_{Hc}$ は熱に対するキャノピー(葉面)フラックスのバルク係数, 
$\Psi_m$, $\Psi_h$ はそれぞれ運動量と熱に対する Monin-Obukhov のシア関数,
$z_a$ は大気の参照高度(大気第１層の高度)である. 
$\zeta$, $\zeta_g$ は, それぞれキャノピー全体および地表面(林床)に関する
Monin-Obukhov 長 $L$, $L_g$ を用いて, 
\begin{eqnarray}
 \zeta &=& \frac{z_a - d}{L} \\
 \zeta_g &=& \frac{z_a - d}{L_g}
\end{eqnarray}
で表される. 
また, Monin-Obukhov 長は, 
\begin{eqnarray}
 L &=& \frac{\Theta_0 C_M^{3/2}|V_a|^2}{kg(C_{Hs}(T_s - T_a) + C_{Hc}(T_c - T_a))} \\
 L_s &=& \frac{\Theta_0 C_M^{3/2}|V_a|^2}{kg C_{Hs}(T_s - T_a)}
\end{eqnarray}
で表される. 
ここで, $\Theta_0$ =300K, $|V_a|$ は地表面風速の絶対値, $k$ はカルマン
定数, $g$ は重力加速度, $T_a$, $T_c$, $T_s$ はそれぞれ大気第１層, キャノ
ピー(葉面)および地表面(林床)の温度である. 

Monin-Obukhov 長の計算にはバルク係数が必要であり, バルク係数の計算には
Monin-Obukhov 長が必要であるため, 中立のバルク係数を初期値として, 繰り返
し計算(標準では2回)を行う. 

また, 積雪面においては, この計算に先立って, ゼロ面変位には積雪深を加えて
おく, ただし, ゼロ面変位が$z_a$に比べて大きくなり過ぎないように, 上限を
設ける. 
\begin{eqnarray}
 d = \min( d + D_{Sn} ,\  f_{\max} \cdot z_a )
\end{eqnarray}
標準では $f_{\max}$ を 0.5 に取っている. 

\subsubsection{水蒸気に対するバルク係数の計算}

この計算は, 後に述べる気孔抵抗の計算を行った後に行う. 

気孔抵抗 $r_{st}$, 地表面蒸発抵抗 $r_{soil}$ が求まったら, 水蒸気に対す
るバルク係数を以下のように求める. 
\begin{eqnarray}
 C_{Ec} |V_a| &=& \left[ (C_{Hc} |V_a|)^{-1} + r_{st} / LAI\right]^{-1} \\
 C_{Es} |V_a| &=& \left[ (C_{Hs} |V_a|)^{-1} + r_{soil}\right]^{-1}
\end{eqnarray}
(以前は, 気孔抵抗などを交換係数の減少に換算して, 粗度を経由して求めてい
たが, 問題がありそうなので簡便な方法に改めた)

なお, 気孔抵抗などのかからない場合(濡れた面からの蒸発など)は, 水蒸気のバ
ルク係数は熱のバルク係数と同じものを使う. 

\subsection{気孔抵抗の計算}

気孔抵抗の計算は, Farquhar et al.(1980), Ball(1988), Collatz et
al.(1990, 1991, 1992) などに基づく光合成-気孔モデルを用いている. 
キャノピー全体の抵抗を求める方法を除いて, SiB2 (Sellers et al., 1996) の
コードをほぼそのまま使っている. 
Jarvis 型の経験式をこれの代わりに用いることもできるが, ここではその説明
は略す. 

\subsubsection{土壌水分ストレスファクターの計算}

蒸散に対する土壌水分ストレスを求める. 
土壌各層の土壌水分ストレスファクターを求め, 各層の根の分布で重み付けして
土壌全体のストレスファクターを計算する. 

各層の土壌水分ストレスは, SiB2 (Sellers et al., 1996) を参考に, 以下の式
により評価する. 
\begin{equation}
 f_{w(k)} = [ 1 + \exp( 0.02 (\psi_{cr} - \psi_{k}) ) ]^{-1}
\ \ \ \ \ (k=1,\ldots,K_g)
\end{equation}
土壌全体のストレスファクターは, 
\begin{equation}
 f_w = \sum_{k=1}^{K_g} f_{w(k)} f_{root(k)}
\end{equation}
ここで, $f_{root(k)}$ は各層の根の存在比率で, 土地被覆タイプごとの外部パ
ラメタである. $\sum_{k=1}^{K_g} f_{root(k)}=1$ である. 

さらに, 蒸散量を各層の根の吸い上げフラックスに分配する重みを以下のように
おく. 
\begin{equation}
 f_{rootup(k)} = f_{w(k)} f_{root(k)} / f_w 
\ \ \ \ \ (k=1,\ldots,K_g)
\end{equation}
ここで, $\sum_{k=1}^{K_g} f_{rootup(k)} = 1$ であることに注意されたい. 

\subsubsection{光合成量の計算}

SiB2 (Sellers et al., 1996) にならって, 光合成量の計算を行う. 

光合成量は, ３つの上限によって規定されていると考える. 
\begin{equation}
 A \leq \min( w_c, w_e, w_s) \label{photo_a}
\end{equation}
$w_c$ は光合成酵素(Rubisco)の効率による上限, 
$w_e$ は光合成有効放射量による上限である. 
$w_s$ は C$_3$ 植物の場合は光合成生成物の利用効率(シンク)による上限, 
C$_4$ 植物の場合は CO$_2$濃度による上限である
(Collatz et al., 1991, 1992). 

それぞれの大きさは以下のように見積もられる. 
\begin{eqnarray}
 w_c &=& \left\{
\begin{array}{ll}
\displaystyle{ 
V_m \left[ \frac{c_i - \Gamma^*}{c_i + K_c(1+O_2/K_O)}\right]
}
 & (\mbox{C$_3$植物の場合})\\
 V_m 
 & (\mbox{C$_4$植物の場合})
\end{array}
\right. \\
 w_e &=& \left\{
\begin{array}{ll}
\displaystyle{ 
PAR\cdot \epsilon_3 \left[ \frac{c_i-\Gamma^*}{c_i+2\Gamma^*}\right]
}
 & (\mbox{C$_3$植物の場合})\\
PAR\cdot \epsilon_4 
 & (\mbox{C$_4$植物の場合})
\end{array}
\right. \\
 w_s &=& \left\{
\begin{array}{ll}
V_m / 2
 & (\mbox{C$_3$植物の場合})\\
V_m c_i/ 5
 & (\mbox{C$_4$植物の場合})
\end{array}
\right.
\end{eqnarray}
ここで, $V_m$ は Rubisco 反応容量, $c_i$ は気孔内における CO$_2$ の分圧,
$O_2$ は気孔内における酸素の分圧, $PAR$ は光合成有効放射量(PAR)である. 
$\Gamma^*$ は CO$_2$ 補償点で, $\Gamma^* = 0.5 O_2 / S$ で表される. 
$K_c$, $K_O$, $S$ は温度の関数であり, 後で関数形を示す. 
$\epsilon_3$, $\epsilon_4$ は, 植生タイプによって決まる定数である. 

(\ref{photo_a}) は, 実際には, 異なる上限の間の滑らかな遷移を表すために,
以下のように解かれる. 
\begin{eqnarray}
 \beta_{ce} w_p^2 - w_p(w_c + w_e) + w_c w_e &=& 0 \\
 \beta_{ps} A^2 - A(w_p + w_s) + w_p w_s &=& 0
\end{eqnarray}
それぞれの方程式について２つの解のうち小さいほうを選びながら, ２つの方程
式を順に解くと, $A_n$ が得られる. 
$\beta_{ce}, \beta_{ps}$ は植生タイプによって決まる定数である. $\beta=1$
のときに単純な最小値操作と一致することに注意されたい. 

光合成量が求まったら, 純光合成量 $A_n$ を以下のように求める. 
\begin{equation}
 A_n = A - R_d
\end{equation}
$R_d$ は呼吸量であり, 以下で表される. 
\begin{equation}
 R_d = f_d V_m
\end{equation}
$f_d$ は植生タイプによって決まる定数である. 

$V_m$ などは温度と土壌水分に以下のように依存する ($V_m$ は, 現れる項
によって温度依存性が異なるが, 同じ $V_m$ で表した). 
\begin{eqnarray}
 V_m &=& V_{\max} f_T(T_c) f_w \\
 K_c &=& 30 \times 2.1^{Q_T} \\
 K_O &=& 30000 \times 1.2^{Q_T} \\
 S   &=& 2600 \times 0.57^{Q_T} \\
 f_T(T_c) &=& \left\{
\begin{array}{ll}
 2.1^{Q_T}/\{1 + \exp[s_1(T_c-s_2)]\}&  (\mbox{C$_3$ の $w_c$, $w_e$のとき})\\
 1.8^{Q_T}/\{1 + \exp[s_3(s_4-T_c)]\}&  (\mbox{C$_3$ の $w_s$のとき}) \\
 2.1^{Q_T}/\{1 + \exp[s_1(T_c-s_2)]\}/\{1 + \exp[s_3(s_4-T_c)]\}
  &  (\mbox{C$_4$ の $w_c$, $w_e$のとき})\\
 1.8^{Q_T} &  (\mbox{C$_4$ の $w_s$のとき}) \\
 2^{Q_T}/\{1 + \exp[s_5(T_c-s_6)]\} &  (\mbox{$R_d$のとき})
\end{array}
\right. \\
Q^T &=& (T_c - 298) / 10
\end{eqnarray}
ここで, $V_{\max}$, $s_1, \ldots, s_6$ は, 植生タイプによって決まる定数で
ある. 

以上で, $V_{\max}$, $PAR$, $c_i$, $T_c$, $f_w$ が与えられれば, 個葉におけ
る光合成量が計算できる. 
現実には, これらの値は同じキャノピー内でもばらつきを持って分布していると
考えられるが, ここでは, $c_i$, $T_c$, $f_w$ は全ての葉について同じと近似
し, $V_{\max}$ と $PAR$ については鉛直の分布を考慮する. 
$PAR$ はキャノピー上端で大きく, 下に行くほど減衰するが, $V_{\max}$ につい
ても, この $PAR$ の分布に順応して, $PAR$ と類似の分布をとると考えられる. 

平均的な $PAR$ の鉛直分布(したがって $V_{\max}$ の鉛直分布)を以下のように
表す. 
\begin{equation}
 PAR(L) = PAR^{top} \exp(- f_{atn} a L)
\end{equation}
ここで, $L$ はキャノピー上端から積算した葉面積, $PAR^{top}$ はキャノピー
上端での $PAR$, $a$ は(\ref{atn})で定義した減衰係数, $f_{atn}$ は調節の
ための定数である. 
これを用いて, 平均的な $PAR$ の値を表すファクター $f_{avr}$ を以下で定義
する. 
\begin{equation}
 f_{avr} = \int_0^{LAI} PAR(L) dL \Bigm / (LAI \cdot PAR^{top})
 = \frac{1 - \exp(- f_{atn} a L)}{f_{atn} a}
\end{equation}
$A_n$ を構成する各項($w_c, w_s, w_e, R_d$) は, いずれも $V_{\max}$ もしくは
$PAR$ に比例するため, $V_{\max}$ と $PAR$ の鉛直分布が比例するとの前提に立
てば, キャノピー上端の $V_{\max}$ と $PAR$ の値を使って求めた $A_n$ に,
$f_{avr}$ を掛けることによって, 平均的な葉の光合成量$\overline{A_n}$を求
めることができる. 
\begin{equation}
 \overline{A_n} = f_{avr} A_n
\end{equation}
以下では, これを改めて $A_n$ と呼ぶ. 

\subsubsection{気孔抵抗の計算}

純光合成量 $A_n$と 気孔コンダクタンス $g_s$ は, Ball (1988) の準経験的な
式により以下のように関係付ける. 
\begin{equation}
 g_s = m \frac {A_n}{c_s} h_s + b f_w 
\label{photo_gs}
\end{equation}
ここで, $c_s$ は葉面における CO$_2$ モル分率(空気 1mol あたりの CO$_2$の
mol 数), $f_w$ は土壌水分ストレスファクター, $m$ と $b$ は植生タイプによっ
て決まる定数である. 

$h_s$ は葉面における相対湿度で, 以下で定義される. 
\begin{equation}
 h_s = e_s / e_i
\label{photo_h}
\end{equation}
$e_s$ は葉面における水蒸気モル分率, 
$e_i$ は気孔内の水蒸気モル分率であり, $e_i = e^*(T_c)$ である. $e^*$ は
飽和水蒸気量のモル分率を表す. 

気孔内から葉面への水蒸気フラックスと, 葉面から大気中への水蒸気フラックス
が等しい(葉面で水蒸気の収束発散が無い)とおけば, 
\begin{equation}
 g_s(e_i - e_s) = g_l(e_s - e_a)
\label{photo_esei}
\end{equation}
より, 
\begin{equation}
 e_s = ( g_l e_a + g_s e_i ) / ( g_l + g_s )
\label{photo_es}
\end{equation}
を得る. ここで, $e_a$ は大気中水蒸気モル分率, $g_l$ は葉面から大気の間の
コンダクタンスである. $g_l$ は, バルク係数を用いて $g_l = C_{Hc}|V_a| /
LAI$ で表す. 

同様に, 葉面で CO$_2$ の収束発散が無いと考えれば, 
\begin{equation}
 A_n = g_l(c_a - c_s)/1.4
     = g_s(c_s - c_i)/1.6 
\label{photo_csci}
\end{equation}
より, 
\begin{eqnarray}
 c_s &=& c_a - 1.4 A_n/g_l \\
\label{photo_cs}
 c_i &=& c_s - 1.6 A_n/g_s
\label{photo_ci}
\end{eqnarray}
を得る. ここで, $c_a$, $c_i$ はそれぞれ大気中および気孔内の CO$_2$ モル
分率である. 1.4 と 1.6 は, 水蒸気と CO$_2$ の拡散係数の違いにより現れる
定数である. 

(\ref{photo_gs})に (\ref{photo_h}), (\ref{photo_es})
を代入して整理すると, 以下の $g_s$ の方程式を得る. 
\begin{equation}
 H g_s^2 + ( H g_l - e_i - H b f_w ) g_s - g_l ( H b f_w + e_a ) = 0
\label{photo_gs2}
\end{equation}
ただし, 
\begin{equation}
 H = (e_i c_s)/(m A_n)
\end{equation}
であり, $c_s$ には (\ref{photo_cs}) を用いる. 

(\ref{photo_gs2}) の２つの解のうち, 大きいほうが意味のある解である. 
以上から, $A_n$ を既知とすれば $g_s$ を解くことができたが, $A_n$ を求め
る際に $c_i$ を用いている. $c_i$ は, $g_s$ が求まれば (\ref{photo_ci})
により求まる. 
つまり, $g_s$ を求めるには $A_n$ が必要, $A_n$ を求めるには $c_i$, すな
わち $g_s$ が必要であるので, 繰り返し計算を行う必要がある. 

繰り返し計算のアルゴリズムは SiB2 から移植したもので, ６回の繰り返しを行
い, 誤差を大きい順に並べて次の解を推定することにより収束を早める手法を用
いている. 

最後に, 気孔コンダクタンスを用いて, 気孔抵抗は以下で表される. 
\begin{equation}
 r_{st} = 1/g_{st}
\end{equation}

\subsubsection{地表面蒸発抵抗の計算}

地表面蒸発抵抗$r_{soil}$と土壌第１層の相対湿度$h_{soil}$を以下のように計
算する. 
\begin{eqnarray}
 r_{soil} &=& a_1 ( 1 - W_{(1)} ) / ( a_2 + W_{(1)} ) \\
 h_{soil} &=& \exp \left(\frac{\psi_{(1)} g}{R_{air} T_{g(1)}} \right) 
\end{eqnarray}
ここで, $W_{(1)} = w_{(1)}/w_{sat(1)}$ は土壌第１層の飽和度, $\psi_{1}$
は土壌第１層の水分ポテンシャル, $g$ は重力加速度, $R_{air}$ は空気の気体
定数, $T_{g(1)}$ は土壌第１層の温度である. 
$a_1$, $a_2$ は定数で, 標準では $a_1=800$, $a_2$=0.2 を用いている. 

\section{地表サブモデル MATSFC}

\subsection{地表乱流フラックスの計算}

バルク法により地表面での乱流フラックスを以下のように求める. 
後に地表のエネルギーバランスを解いて, 地表面温度 $T_s$, キャノピー温度
$T_c$が更新されると, その値に対して地表面フラックスの値も更新される. 
ここで求めるのはそれまでの暫定的な値である. 
また, エネルギーバランスを$T_s$と$T_c$について線形化して解くために, 各フ
ラックスの$T_s$と$T_c$についての微分を計算しておく. 

\begin{itemize}

\item 運動量フラックス
 \begin{eqnarray}
 \tau_x &=& - \rho C_{M}|V_a| u_a \\
 \tau_y &=& - \rho C_{M}|V_a| v_a
 \end{eqnarray}
ここで, $\tau_x$, $\tau_y$ は, それぞれ東西, 南北方向の運動量フラックス
(地表面ストレス)である. 

\item 顕熱フラックス
 \begin{eqnarray}
 H_s &=& c_p \rho C_{Hs}|V_a| (T_s - (P_s/P_a)^{\kappa}T_a)   
 \label{flux_start} \\
 H_c &=& c_p \rho C_{Hc}|V_a| (T_c - (P_s/P_a)^{\kappa}T_a) \\
 \partial H_s/\partial T_s &=& c_p \rho C_{Hs}|V_a| \\
 \partial H_c/\partial T_c &=& c_p \rho C_{Hc}|V_a|
 \end{eqnarray}
ここで, $H_s$, $H_c$ はそれぞれ地表面(林床)およびキャノピー(葉面)からの
顕熱フラックス, $\kappa = R_{air} / c_p$, $R_{air}$ は空気の気体定数,
$c_p$ は空気の比熱である. 

\item 裸地面(林床)蒸発フラックス
 \begin{eqnarray}
 Et_{(1,1)} &=& (1-A_{Sn})(1-f_{ice})\cdot
           \rho \widetilde{C_{Es}}|V_a|(h_{soil}q^*(T_s) - q_a) \\
 Et_{(2,1)} &=& (1-A_{Sn})f_{ice}\cdot
           \rho \widetilde{C_{Es}}|V_a|(h_{soil}q^*(T_s) - q_a) \\
 \partial Et_{(1,1)}/\partial T_s &=& (1-A_{Sn})(1-f_{ice})\cdot
           \rho \widetilde{C_{Es}}|V_a|h_{soil}\cdot dq^*/dT |_{T_s} \\
 \partial Et_{(2,1)}/\partial T_s &=& (1-A_{Sn})f_{ice}\cdot
           \rho \widetilde{C_{Es}}|V_a|h_{soil}\cdot dq^*/dT |_{T_s}
 \end{eqnarray}
ここで, $Et_{(1,1)}$, $Et_{(2,1)}$ はそれぞれ裸地面での水の蒸発および氷
の昇華フラックス, $q^*(T_s)$ は地表面温度における飽和比湿, $h_{soil}$ は
土壌表層の相対湿度, $A_{Sn}$ は積雪面積率, $f_{ice}$ は土壌第１層の氷の
割合
 \begin{equation}
  f_{ice} = w_{i(1)}/w_{(1)}
 \end{equation}
である. 
無雪面と積雪面は別々に計算するため, $A_{Sn}$ には $0$ (無雪面) か $1$
(積雪面) のどちらかの値が入っていることに注意. 
また, フラックスが下向き(結露)の場合には土壌水分の抵抗はかからないので, バ
ルク係数は以下のように取る. 
 \begin{equation}
  \widetilde{C_{Es}} = \left\{
  \begin{array}{ll}
   C_{Es}& (h_{soil}q^*(T_s) - q_a > 0 \mbox{のとき})\\
   C_{Hs}& (h_{soil}q^*(T_s) - q_a \leq 0 \mbox{のとき})
  \end{array}
  \right.
 \end{equation}

\item 蒸散フラックス
 \begin{eqnarray}
 Et_{(1,2)} &=& (1-f_{cwet}) \cdot \rho \widetilde{C_{Ec}}|V_a|(q^*(T_c) - q_a) \\
 Et_{(2,2)} &=& 0 \\
 \partial Et_{(1,2)}/\partial T_c &=& 
  (1-f_{cwet}) \cdot \rho \widetilde{C_{Ec}}|V_a|\cdot dq^*/dT|_{T_c} \\
 \partial Et_{(2,2)}/\partial T_c &=& 0
 \end{eqnarray}
ここで, $Et_{(1,2)}$, $Et_{(2,2)}$ は水および氷の蒸散であるが,
$Et_{(2,2)}$ は常にゼロである. 
$f_{cwet} = w_c / w_{c,cap}$ はキャノピーの濡れ面積率である. 
フラックスが下向きの場合には, 葉の乾いた部分への結露と考えて, バルク係数
を以下のように取る. 
 \begin{equation}
  \widetilde{C_{Ec}} = \left\{
  \begin{array}{ll}
   C_{Ec}& (q^*(T_c) - q_a > 0 \mbox{のとき})\\
   C_{Hc}& (q^*(T_c) - q_a \leq 0 \mbox{のとき})
  \end{array}
  \right.
 \end{equation}

\item キャノピー上蒸発フラックス \\
%
$T_c$ $\geq$ 0$^{\circ}$C のとき
 \begin{eqnarray}
 Et_{(1,3)} &=& 
  f_{cwet} \cdot \rho C_{Hc}|V_a|(q^*(T_c) - q_a) \\
 Et_{(2,3)} &=& 0 \\
 \partial Et_{(1,3)} \partial T_c &=& 
  f_{cwet} \cdot \rho C_{Hc}|V_a|\cdot dq^*/dT|_{T_c} \\
 \partial Et_{(2,3)} \partial T_c &=& 0 
 \end{eqnarray}
$T_c$ $<$ 0$^{\circ}$C のとき
 \begin{eqnarray}
 Et_{(1,3)} &=& 0 \\
 Et_{(2,3)} &=& 
  f_{cwet} \cdot \rho C_{Hc}|V_a|(q^*(T_c) - q_a) \\
 \partial Et_{(1,3)} \partial T_c &=& 0 \\
 \partial Et_{(2,3)} \partial T_c &=& 
  f_{cwet} \cdot \rho C_{Hc}|V_a|\cdot dq^*/dT|_{T_c}
 \end{eqnarray}
ここで, $Et_{(1,3)}$, $Et_{(2,3)}$ はキャノピー上の水の蒸発および氷の昇
華である. 

\item 積雪昇華フラックス
 \begin{eqnarray}
 E_{Sn} &=& A_{Sn}\cdot \rho C_{Hs}|V_a|(q^*(T_s) - q_a) \\
 \partial E_{Sn}/\partial T_s &=& A_{Sn}\cdot \rho C_{Hs}|V_a|
 \cdot dq^*/dT|_{T_s}
 \end{eqnarray}
$E_{Sn}$ は積雪昇華フラックスである. 
無雪面と積雪面は別々に計算するため, $A_{Sn}$ には $0$ (無雪面) か $1$
(積雪面) のどちらかの値が入っていることに注意. 
\end{itemize}

\subsection{熱伝導フラックスの計算}

無雪面および積雪面上の熱伝導フラックスを計算する. 乱流フラックスと同様,
後にエネルギーバランスを解いて地表温度が更新されると, その値に対して熱伝
導フラックスの値も更新される. 

なお, 無雪面と積雪面は別々に計算するため, 以下で積雪面積率 $A_{Sn}$ には
$0$ (無雪面) か $1$ (積雪面) のどちらかの値が入っていることに注意. 

\begin{itemize}
 \item 無雪面の熱伝導フラックス
\begin{eqnarray}
  F_{g(1/2)} &=& (1 - A_{Sn}) \cdot k_{g(1/2)} / \Delta z_{g(1/2)} (T_{g(1)} - T_s) \\
  \partial F_{g(1/2)}/\partial T_s &=& 
  - (1 - A_{Sn}) \cdot k_{g(1/2)} / \Delta z_{g(1/2)}
\end{eqnarray}
ここで, $F_{g(1/2)}$ は熱伝導フラックス, $k_{g(1/2)}$ は土壌の熱伝導率,
$\Delta z_{g(1/2)}$ は土壌第１層の温度の定義点から地表面までの厚さ,
$T_{g(1)}$ は土壌第１層の温度である. 
 \item 積雪面の熱伝導フラックス
\begin{eqnarray}
  F_{Sn(1/2)} &=& A_{Sn} \cdot k_{Sn(1/2)} / \Delta z_{Sn(1/2)} (T_{Sn(1)} - T_s)
\label{flux_end} \\
  \partial F_{Sn(1/2)}/\partial T_s &=& 
  - A_{Sn} \cdot k_{Sn(1/2)} / \Delta z_{Sn(1/2)}
\end{eqnarray}
ここで, $F_{Sn(1/2)}$ は熱伝導フラックス, $k_{Sn(1/2)}$ は積雪の熱伝導率,
$\Delta z_{Sn(1/2)}$ は積雪第１層の温度の定義点から地表面までの厚さ,
$T_{Sn(1)}$ は積雪第１層の温度である. 
\end{itemize}

\subsection{地表面, キャノピーエネルギーバランスの求解}

エネルギーバランスは, 1:地表面の融解が無い場合, 2:地表面の融解がある場合, 
の 2ケースについて解く. ケース 2では, 地表温度 $T_s$を $0^{\circ}$Cに
固定して解き, エネルギーバランスから融解に利用できるエネルギーを診断する. 
植生上の融雪は後で補正により処理するため, ここでそのケースを別に解くことは
しない. 
また, 積雪が時間ステップ内に融けきってしまう場合についても後で
補正により処理する. 

\subsubsection{地表, キャノピーエネルギーバランス}

 地表面(林床)におけるエネルギーの発散量は, 
 \begin{equation}
 \Delta F_s =
  H_s + R^{net}_s + l Et_{(1,1)} + l_s ( Et_{(2,1)} + E_{Sn} )
  - F_{g(1/2)} - F_{Sn(1/2)} 
  \label{eb_start}
 \end{equation}
 ただし, $l$, $l_s$ はそれぞれ蒸発と昇華の潜熱, 
 $R^{net}_s$ は地表面における正味の放射発散量で, 
 \begin{equation}
  R^{net}_s = -(R^{\downarrow}_S - R^{\uparrow}_S) {\cal{T}}_{cS}
              - \epsilon R^{\downarrow}_L {\cal{T}}_{cL}
              + \epsilon \sigma T_s^4 
              - \epsilon \sigma T_c^4 (1 - {\cal{T}}_{cL})
 \end{equation}
 $\sigma$ は Stefan-Boltzman 定数である. 

 キャノピー(葉面)におけるエネルギーの発散量は, 
 \begin{equation}
  \Delta F_c =
  H_c + R^{net}_c + l ( Et_{(1,2)} + Et_{(1,3)} ) 
  + l_s ( Et_{(2,2)} + Et_{(2,3)} )
 \end{equation}
 ただし, $R^{net}_c$ はキャノピーにおける正味の放射発散量で, 
 \begin{equation}
  R^{net}_c = -(R^{\downarrow}_S - R^{\uparrow}_S) (1-{\cal{T}}_{cS})
              - \epsilon R^{\downarrow}_L (1-{\cal{T}}_{cL})
              + ( 2 \epsilon \sigma T_c^4 
              - \epsilon \sigma T_s^4 ) (1 - {\cal{T}}_{cL})
  \label{eb_end}
 \end{equation}

\subsubsection{ケース１: 地表面の融解が無い場合}

地表面の融解が無い場合, $\Delta F_s=\Delta F_c=0$ として, 地表
面とキャノピーのエネルギーバランスが成り立つように, $T_s$, $T_c$ を解く. 

$T_s$, $T_c$ について各項を線形化したエネルギーバランスの式は, 

\begin{equation}
 \left(
\begin{array}{l}
 \Delta F_s \\
 \Delta F_c \\
\end{array}
\right)^{current}
=
\left(
\begin{array}{l}
 \Delta F_s \\
 \Delta F_c \\
\end{array}
\right)^{past}
+
\left(
\begin{array}{ll}
 {\partial \Delta F_s}/{\partial T_s} & 
 {\partial \Delta F_s}/{\partial T_c} \\
 {\partial \Delta F_c}/{\partial T_s} & 
 {\partial \Delta F_c}/{\partial T_c} \\
\end{array}
\right)
\left(
\begin{array}{l}
 \Delta T_s \\
 \Delta T_c \\
\end{array}
\right)
= 
\left(
\begin{array}{l}
 0 \\
 0 \\
\end{array}
\right)
\label{eb1}
\end{equation}
と書ける. 

右辺の $past$ の付いた部分が, 
前のステップの $T_s$, $T_c$ の値を用いて (\ref{flux_start})から
(\ref{flux_end}) で計算したフラックスを
(\ref{eb_start})から(\ref{eb_end})に代入したものである. 

微分項は, 
\begin{eqnarray}
 \frac{\partial \Delta F_s}{\partial T_s} &=&
 \frac{\partial H_s}{\partial T_s} 
+\frac{\partial R^{net}_s}{\partial T_s}
+l\frac{\partial Et_{(1,1)}}{\partial T_s}
+l_s\left(\frac{\partial Et_{(2,1)}}{\partial T_s}
+    \frac{\partial E_{Sn}}{\partial T_s}\right)
-\frac{\partial F_{g(1/2)}}{\partial T_s}
-\frac{\partial F_{Sn(1/2)}}{\partial T_s} \\
 \frac{\partial \Delta F_s}{\partial T_c} &=&
 \frac{\partial R^{net}_s}{\partial T_c} \\
 \frac{\partial \Delta F_c}{\partial T_s} &=&
 \frac{\partial R^{net}_c}{\partial T_s} \\
 \frac{\partial \Delta F_c}{\partial T_c} &=&
 \frac{\partial H_c}{\partial T_c} 
+\frac{\partial R^{net}_c}{\partial T_c}
+l  \left(\frac{\partial Et_{(1,2)}}{\partial T_c}
+         \frac{\partial Et_{(1,3)}}{\partial T_c}\right)
+l_s\left(\frac{\partial Et_{(2,2)}}{\partial T_c}
+         \frac{\partial Et_{(2,3)}}{\partial T_c}\right)
\end{eqnarray}
ただし, 
\begin{eqnarray}
 \frac{\partial R^{net}_s}{\partial T_s} &=&
 \epsilon 4 \sigma T_s^3 \\
 \frac{\partial R^{net}_s}{\partial T_c} &=&
 - ( 1 - {\cal{T}}_{cL} ) \epsilon 4 \sigma T_c^3 \\
 \frac{\partial R^{net}_c}{\partial T_s} &=&
 - ( 1 - {\cal{T}}_{cL} ) \epsilon 4 \sigma T_s^3 \\
 \frac{\partial R^{net}_c}{\partial T_c} &=&
  2( 1 - {\cal{T}}_{cL} ) \epsilon 4 \sigma T_c^3 
\end{eqnarray}

以上を用いて, (\ref{eb1}) を $T_s$, $T_c$ について解けばよい. 

\subsubsection{ケース２: 地表面の融解がある場合}

地表面に積雪があるか土地被覆タイプが氷床であり, かつケース１で解いてみた
地表面温度 $T_s^{current} = T_s^{past}+\Delta T_s$ が0$^{\circ}$C よりも
高い場合, 地表面の融解が生じる. 
地表面の融解がある場合には, 地表温度は 0$^{\circ}$C に固定される. 
すなわち, 
\begin{equation}
 \Delta T_s = \Delta T_s^{melt} = T_{melt} - T_s^{past}
\end{equation}
である. $T_{melt}$ は氷の融点 (0$^{\circ}$C) である. 

$T_c$ は, $\Delta T_s$ を既知として, (\ref{eb1}) と同様に以下の式で求め
る. 
\begin{equation}
 \Delta T_c = \left( - \Delta F_c^{past} 
            - \frac{\partial \Delta F_c}{\partial T_s} \Delta T_s^{melt}
              \right) \Bigm/ \frac{\partial \Delta F_c}{\partial T_c}
\end{equation}

こうして $\Delta T_s$ と $\Delta T_c$ が既知になれば, 融解に使われる地表
面のエネルギー収束量は, 
\begin{equation}
 \Delta F_{conv} =
 - \Delta F_s^{current} = - \Delta F_s^{past} 
 - \frac{\partial \Delta F_s}{\partial T_s} \Delta T_s^{melt}
 - \frac{\partial \Delta F_s}{\partial T_c} \Delta T_c
\end{equation}
により求まる. 

\subsubsection{解の制約条件}

地表面エネルギーバランスの解にいくつかの制約条件を設ける. 
解いてみて, もしも条件を破っていれば, 条件を破ったフラックスを条件を満た
す限界の値に固定して, エネルギーバランスを解きなおす. 

\begin{enumerate}
 \item 大気第１層の水蒸気を取り過ぎない \\
 一時的な計算不安定により, 大きな下向きの潜熱が生じてしまうことがありう
 る. 
 そのような場合でも地表面から大気第１層までの水蒸気をすべて奪わないよう
 に条件を付ける. 
 \begin{eqnarray}
  Et_{(i,j)}^{current} &>& - q_a ( P_s - P_a ) / (g \Delta t)
   \ \ \ \ \ (i=1,2 ; j=1,2,3) \\
  E_{Sn}^{current} &>& - q_a ( P_s - P_a ) / (g \Delta t)
 \end{eqnarray}
  ここで, $g$ は重力加速度, $\Delta t$ は大気モデルの時間ステップである. 
  判定に用いる $Et$ などの値には, エネルギーバランスを満たすように更新し
  た $T_s$, $T_c$ の値に対して更新したフラックスの値($current$)を用いる. 
  これは以下の他の条件の場合でも全て同じである. 
  フラックスの値の更新については後に述べる. 
 \item 土壌水分が負にならない \\
  蒸散によって土壌水分が負にならないようにする. 
  \begin{equation}
   Et_{(1,2)}^{current} < 
     \sum_{k\in rootzone} \rho_w w_{k}\Delta z_{g(k)} /\Delta t_L   
  \end{equation}
  ここで, $\rho_w$ は水の密度, $\Delta t_L$ は陸面モデルの時間ステップで
  ある. 
 \item キャノピー上水分が負にならない \\
  キャノピー上水分が蒸発によって負にならないようにする. 
  \begin{equation}
   Et_{(i,3)}^{current} < \rho_w w_c /\Delta t_L
   \ \ \ \ \ (i=1,2)
  \end{equation}
 \item 積雪量が負にならない \\
  積雪の昇華によって積雪量が負にならないようにする. 
  \begin{equation}
   E_{Sn}^{current} < Sn /\Delta t_L
  \end{equation}
\end{enumerate}

\subsubsection{地表面, キャノピー温度の更新}

  地表面温度とキャノピー温度を更新する. 
\begin{eqnarray}
 T_s^{current} &=& T_s^{past} + \Delta T_s \\
 T_c^{current} &=& T_c^{past} + \Delta T_c
\end{eqnarray}

  更新されたキャノピー温度をもとに, キャノピー上水分が液体か固体かを診断
  しておく. この情報は後にキャノピー上水分の凍結融解を扱うときに使う. 

\begin{equation}
 A_{Snc} = \left\{
\begin{array}{ll}
 0& (T_c \geq T_{melt})\\
 1& (T_c <    T_{melt})
\end{array}
\right.
\end{equation}
$A_{Snc}$ は, キャノピー上水分の凍結面積率である. 

\subsubsection{フラックスの値の更新}

更新した $T_s$, $T_c$ の値に対してフラックスの値を更新する. 
$F$ を任意のフラックスとすれば, 値の更新は以下のように行う. 
\begin{equation}
 F^{current} = F^{past} + \frac{\partial F}{\partial T_s} \Delta T_s
                        + \frac{\partial F}{\partial T_c} \Delta T_c
\end{equation}

更新したフラックスの値を用いて, 大気に出力するフラックスなどを計算する. 
\begin{eqnarray}
 H &=& H_s + H_c \\
 E &=& \sum_{j=1}^3 \sum_{i=1}^2 Et_{(i,j)} + E_{Sn} \\
 R^{\uparrow}_L &=& {\cal{T}}_{cL} \epsilon \sigma T_s^4  
 + (1 - {\cal{T}}_{cL}) \epsilon \sigma T_c^4 
 + (1 - \epsilon) R^{\downarrow}_L \\
 T_{sR} &=& ( R^{\uparrow}_L / \sigma )^{1/4}
\end{eqnarray}
$T_{sR}$ は地表面の放射温度である. 

また, 土壌各層の根の吸い上げフラックスを計算する. 
\begin{equation}
 F_{root(k)} = f_{rootup(k)} Et_{(1,2)} \ \ \ \ (k=1,\ldots,K_g)
\end{equation}
$F_{root(k)}$ は根の吸い上げフラックス, $f_{rootup(k)}$ は蒸散量を各層の
根の吸い上げフラックスに分配する重みである. 

\section{キャノピー水収支サブモデル MATCNW}

キャノピー上水分の水収支の計算を行う. 

\subsection{キャノピー上水分の相の診断}

キャノピー上水分は液体(遮断した降水, 結露, または固体水分がが融けたもの)
と固体(遮断した雪, 着氷, または液体水分が凍ったもの)を別に考え, その混在
を許す. 
予報変数は, 液体と固体を合わせた水分量 $w_c$ のみであり, キャノピー温度
$T_c$ が $T_{melt} = 0^{\circ}$C よりも高いか低いかにより, それぞれ液体
か固体と診断する. 液体と固体が混在し得るのは, 積雪域と無雪域の $T_c$ を
別に計算しているからである. 
すなわち, キャノピー上水分の凍結面積率$A_{Snc}$を以下のように定義し(実際
にはカプラーによって空間平均された結果, 以下のようになる), 
\begin{equation}
 A_{Snc} = \left\{
\begin{array}{ll}
 0 & (T_{c(1)} \geq T_{melt}, \ T_{c(2)} \geq T_{melt} \mbox{のとき})\\
 (1-A_{Sn}) & (T_{c(1)} < T_{melt}, \ T_{c(2)} \geq T_{melt} \mbox{のとき})\\
 A_{Sn} & (T_{c(1)} \geq T_{melt}, \ T_{c(2)} < T_{melt} \mbox{のとき})\\
 1 & (T_{c(1)} < T_{melt}, \ T_{c(2)} < T_{melt} \mbox{のとき})
\end{array}
\right.
\end{equation}
\begin{eqnarray}
 w_{cl} &=& w_c ( 1 - A_{Snc}) \\
 w_{ci} &=& w_c A_{Snc}
\end{eqnarray}
のようにする. $w_{cl}$, $w_{ci}$ はそれぞれキャノピー上の液体と固体の水分
である. 

$A_{Snc}$ は, フラックス計算部で更新された値 $A_{Snc}^{\tau+1}$がカプラー
から与えられるが, 前のステップの値$A_{Snc}^{\tau}$ を MATCNW の中で記憶
しておく. $\tau$ は時間ステップを表す. 
これは, 計算開始時には $T_c$ と $Sn$ の初期値から求められるので, 新たな
予報変数にはならない. 

\subsection{キャノピー上水分の予報}

キャノピー上水分の予報方程式は, 液体と固体のそれぞれについて, 以下で与え
られる. 
\begin{eqnarray}
 \rho_w \frac{w_{cl}^{\tau+1} - w_{cl}^{\tau}}{\Delta t_L} 
  &=& P_{Il} - E_l - D_l + M_c \\
 \rho_w \frac{w_{ci}^{\tau+1} - w_{ci}^{\tau}}{\Delta t_L}
  &=& P_{Ii} - E_i - D_i - M_c
\end{eqnarray}
$P_{Il}$, $P_{Ii}$ は, それぞれ液体と固体の降水遮断量, 
$E_l$, $E_i$ は蒸発(昇華)量, 
$D_l$, $D_i$ は滴下量, 
$M_c$ は融解量である. 
ここで, 更新前の値 $w_{cl}^{\tau}$, $w_{ci}^{\tau}$ は, 更新前の
$A_{Snc}^{\tau}$ を用いて, 以下により定義されることに注意されたい. 
\begin{eqnarray}
 w_{cl}^{\tau} &=& w_c^{\tau} ( 1 - A_{Snc}^{\tau}) \\
 w_{ci}^{\tau} &=& w_c^{\tau} A_{Snc}^{\tau}
\end{eqnarray}

\subsubsection{キャノピー上水分の蒸発(昇華)}

まず, 蒸発(昇華)量を差し引いて, キャノピー上水分量を部分的に更新する. 
蒸発(昇華)量は, フラックス計算部において求まっている. 
\begin{eqnarray}
 w_{cl}^* &=& w_{cl}^{\tau} - E_l \Delta t_L / \rho_w \\
 w_{ci}^* &=& w_{ci}^{\tau} - E_i \Delta t_L / \rho_w 
\end{eqnarray}
\begin{eqnarray}
 E_l &=& Et_{(1,3)} \\
 E_i &=& Et_{(2,3)} 
\end{eqnarray}
もしもこのときに $w_{cl}$ もしくは $w_{ci}$ の一方が負になった場合, 値が
0 に戻るまでもう一方から補填し, このとき生じたことになる融解量(凍結の場
合は負の値)を $M_c$ に入れておく. 

\subsubsection{キャノピーによる降水の遮断}

降水の遮断と滴下は, 対流性降水の降水域とそうでない場所を分けて考える. 対
流性降水域の面積率 $A_c$ は一律に仮定する (標準では 0.1). 層状性降水は一
様と仮定する. 
\begin{eqnarray}
 P_{Il}^{c}  &=& f_{int} ( Pr_c / A_c + Pr_l ) \\
 P_{Il}^{nc} &=& f_{int} Pr_l \\
 P_{Ii}^{c}  &=& f_{int} ( P_{Snc} / A_c + P_{Snl} ) \\
 P_{Ii}^{nc} &=& f_{int} P_{Snl}
\end{eqnarray}

$P_{Il}^{c}$, $P_{Ii}^{c}$ は対流性降水域の遮断量, $P_{Il}^{nc}$,
$P_{Ii}^{nc}$ はそうでない場所の遮断量を表す. 
$f_{int}$ は遮断効率で, 簡単に
\begin{equation}
 f_{int} = \left\{
\begin{array}{ll}
 LAI & (LAI < 1 \mbox{のとき})\\
 1   & (LAI \geq 1 \mbox{のとき})
\end{array}
\right.
\end{equation}
で与える. 

遮断降水量を加えて, キャノピー上水分量をさらに部分的に更新する. 
\begin{eqnarray}
 w_{cl}^{c*} &=& w_{cl}^*  + P_{Il}^c    \Delta t_L / \rho_w \\
 w_{cl}^{nc*}&=& w_{cl}^*  + P_{Il}^{nc} \Delta t_L / \rho_w \\
 w_{ci}^{c*} &=& w_{ci}^*  + P_{Ii}^c    \Delta t_L / \rho_w \\
 w_{ci}^{nc*}&=& w_{ci}^*  + P_{Ii}^{nc} \Delta t_L / \rho_w 
\end{eqnarray}

\subsubsection{キャノピー上水分の滴下}

滴下量は, キャノピー上水分が容量を越えることによる滴下と, 重力による自然
滴下を考慮する. 
\begin{eqnarray}
 D_l^c    & = & \max( w_{cl}^{c*} - w_{c,cap}, 0 ) + D_{g}(w_{cl}^{c*}) \\
 D_l^{nc} & = & \max( w_{cl}^{nc*}- w_{c,cap}, 0 ) + D_{g}(w_{cl}^{nc*}) \\
 D_i^c    & = & \max( w_{ci}^{c*} - w_{c,cap}, 0 ) + D_{g}(w_{ci}^{c*}) \\
 D_i^{nc} & = & \max( w_{ci}^{nc*}- w_{c,cap}, 0 ) + D_{g}(w_{ci}^{nc*})
\end{eqnarray}
キャノピー上水分容量 $w_{c,cap}$ は, 単位葉面積あたりの水分容量
$w_{c\max}$ と LAI から, 
\begin{eqnarray}
 W_{c,cap} = W_{c\max} LAI 
\end{eqnarray}
とする. 
$W_{c\max}$ は, 標準では 0.2mm であり, 液体と固体に対して同じ値を用いる. 

重力による自然滴下 $D_g$ は, Rutter et al.(1975) にならい, 
\begin{eqnarray}
 D_g(w_c) = D_1 \exp(D_2 w_c)
\end{eqnarray}
とする. 標準では, $D_1$=1.14$\times$10$^{-11}$,
$D_2$=3.7$\times$10$^{3}$ であり, 液体と固体に対して同じ値を用いる. 

滴下量を差し引いて値を更新する. 
\begin{eqnarray}
 w_{cl}^{c**} &=& w_{cl}^{c*}  - D_{Il}^c    \Delta t_L / \rho_w \\
 w_{cl}^{nc**}&=& w_{cl}^{nc*} - D_{Il}^{nc} \Delta t_L / \rho_w \\
 w_{ci}^{c**} &=& w_{ci}^{c*}  - D_{Ii}^c    \Delta t_L / \rho_w \\
 w_{ci}^{nc**}&=& w_{ci}^{nc*} - D_{Ii}^{nc} \Delta t_L / \rho_w 
\end{eqnarray}

\subsubsection{キャノピー上水分量の更新と融解}

さらに対流性降水域とそうでない場所の平均を取れば, 更新されたキャノピー上
水分量が得られる. 
\begin{eqnarray}
 w_{cl}^{**} &=& A_c w_{cl}^{c**} + (1-A_c) w_{cl}^{nc**} \\
 w_{ci}^{**} &=& A_c w_{ci}^{c**} + (1-A_c) w_{ci}^{nc**} \\
 w_c^{\tau+1} &=& w_{cl}^{**} + w_{ci}^{**}
\end{eqnarray}

ただし, 凍結面積率 $A_{Snc}$ の更新を考慮すると, 
\begin{eqnarray}
 w_{cl}^{\tau+1} &=& w_{c}^{\tau+1} (1-A_{Snc}^{\tau+1}) \\
 w_{ci}^{\tau+1} &=& w_{c}^{\tau+1} A_{Snc}^{\tau+1} 
\end{eqnarray}
であるから, 融解量 $M_c$ は以下のように診断される. 
\begin{eqnarray}
 M_c = - \rho_w ( w_{ci}^{\tau+1} - w_{ci}^{**} ) / \Delta t_L
\end{eqnarray}
ただし, 蒸発の際に生じた分がある場合にはそれを加える. 

ここで, 融解の潜熱によりキャノピーの温度を変化させるべきであるが, キャノ
ピーの熱容量を無視しているため, それは不可能である. それではまわりの大気
の温度を変化させるのがよいが, 陸面積分部の計算で閉じたいと思えばそれも不
可能である. 都合, 系のエネルギーを保存するために, 融解の潜熱は土壌(また
は積雪)への熱フラックスとして与える. 

\subsection{土壌, 積雪, 流出過程へ与えられるフラックス}

キャノピーによる遮断を経て積雪もしくは流出過程に与えられる水フラックス
$F_w$は, 対流性降水域とそれ以外の場所, また液体と固体のそれぞれについて, 
\begin{eqnarray}
 F_{wl}^{c} &=& (1-f_{int})( Pr_c / A_c + Pr_l ) + D_{l}^{c} \\
 F_{wl}^{nc} &=&(1-f_{int}) Pr_l + D_{l}^{nc} \\
 F_{wi}^{c} &=& (1-f_{int})( P_{Snc} / A_c + P_{Snl} ) + D_{i}^{c} \\
 F_{wi}^{nc} &=&(1-f_{int}) P_{Snl} + D_{i}^{nc}
\end{eqnarray}

流出の計算に使うために対流性降雨と層状性降雨は分けて, 降雪に関してはその
必要が無いので一つにまとめて与える. 
\begin{eqnarray}
 Pr_c^* &=& Ac ( F_{wl}^{c} - F_{wl}^{nc} ) \\
 Pr_l^* &=& F_{wl}^{nc} \\
 P_{Sn}^* &=& A_c F_{wl}^{c} + (1-A_c) F_{wl}^{nc}
\end{eqnarray}
$Pr_c^*$, $Pr_l^*$, $P_{Sn}^*$ は, それぞれキャノピーによる遮断を経た対
流性降水量, 層状性降水量, 降雪量である. 

また, 土壌または積雪へ与えられるエネルギーフラックス補正分は, 
\begin{equation}
 \Delta F_{c,conv} = - l_m M_c
\end{equation}
である. $l_m$ は融解の潜熱である. 

\section{積雪サブモデル MATSNW}

積雪量, 積雪温度, 積雪アルベドの計算を行う. 

\subsection{積雪面積率の診断}

積雪が少量の場合には, サブグリッドの積雪を考慮する. 
積雪面積率 $A_{Sn}$は, 積雪量$Sn$の一意な関数として, 
\begin{equation}
 A_{Sn} = \min(Sn/Sn_{c}, 1)^{1/2} 
\label{snow_asn}
\end{equation}
で与える. 標準では $Sn_c$=100 [kg/m$^2$] である. 

実際には, 地形や降雪時/融雪時の違いなど, 様々な要因が積雪面積率に影響を
与えると考えられる. 
これについては Liston (私信) によるサブグリッド積雪分布モデル(SSNOWD) の
導入を検討中である. 

$A_{Sn}$ は, フラックス計算部の冒頭で参照され, そこで計算された種々のフ
ラックスを以下のように面積重み付け平均するのに用いられる. 
\begin{equation}
 \overline{F} = (1-A_{Sn}) F_{(1)} + A_{Sn} F_{(2)}
\end{equation}
ここで, $F_{(1)}$, $F_{(2)}$ はそれぞれ無雪面, 積雪面でのフラックスであ
る. 実際にはこの操作はフラックスカプラーを通して行われる. 

\subsection{積雪層の鉛直分割}

積雪温度の鉛直分布を表現するため, 積雪量が多い場合には積雪を多層に分割し
て各層で温度を定義する. 
積雪層数は可変とし, 積雪量が増えるに従って層数を増やす. 標準では最少１層,
最大３層である. 

層数および各層の質量は, 積雪量により一意に決まるようにする. これにより,
各層の質量は新たな予報変数にならない. 

標準では, 各層の質量$\Delta \widetilde{Sn}_{(k)} (k=1,2,3)$は以下のように決める
($k=1$ が最上層である). 
\begin{eqnarray}
 \Delta \widetilde{Sn}_{(1)} &=& \left\{
\begin{array}{ll}
 \widetilde{Sn} & (\widetilde{Sn} < 20) \\
 0.5\widetilde{Sn} & (20 \leq \widetilde{Sn} < 40)\\
 20 & (\widetilde{Sn} \geq 40)
\end{array}
\right. \label{snow_cut1}\\
 \Delta \widetilde{Sn}_{(2)} &=& \left\{
\begin{array}{ll}
 0 & (\widetilde{Sn} < 20) \\
 \widetilde{Sn} - \Delta Sn_{(1)} & (20 \leq \widetilde{Sn} < 60)\\
 0.5(\widetilde{Sn}-20) & (60 \leq \widetilde{Sn} < 100)\\
 40 & (\widetilde{Sn} \geq 100)
\end{array}
\right. \label{snow_cut2}\\
 \Delta \widetilde{Sn}_{(3)} &=& \left\{
\begin{array}{ll}
 0 & (\widetilde{Sn} < 60) \\
 \widetilde{Sn} - (\Delta Sn_{(1)} + \Delta Sn_{(2)})& (\widetilde{Sn} \geq 60)
\end{array}
\right. \label{snow_cut3}
\end{eqnarray}
ここで, 
\begin{equation}
 \widetilde{Sn} =  Sn / A_{Sn}
\end{equation}
であり, $Sn$ がグリッド平均の積雪量であるのに対して, $\widetilde{Sn}$ は
積雪域の積雪量である. 
各層の質量$\Delta \widetilde{Sn}_{(k)}$ も積雪域の値であり, グリッド平均
値では無いことに注意されたい. 
また, 単位は kg/m$^2$ である. 

上記から明らかであるが, 積雪層数 $K_{Sn}$は標準では以下のようになる. 
\begin{equation}
 K_{Sn} = \left\{
\begin{array}{ll}
 0 & (\widetilde{Sn} = 0)\\
 1 & (0< \widetilde{Sn} < 20)\\
 2 & (20 \leq \widetilde{Sn} < 60)\\
 3 & (\widetilde{Sn} \geq 60)
\end{array}
\right.
\end{equation}

\subsection{積雪量の計算}

積雪量の予報方程式は以下で与えられる. 
\begin{equation}
 \frac{Sn^{\tau+1}-Sn^{\tau}}{\Delta t_L} = P_{Sn}^* - E_{Sn} - M_{Sn} + Fr_{Sn}
\end{equation}
$P_{Sn}^*$ は, キャノピーによる遮断を経た降雪フラックス, $E_{Sn}$ は昇華
フラックス, $M_{Sn}$ は融雪, $Fr_{Sn}$ は融雪水の再凍結または降雨の凍結で
ある. 

\subsubsection{積雪の昇華}

まず, 昇華量を差し引いて, 積雪量を部分的に更新する. 
\begin{eqnarray}
 Sn^* &=& Sn^{\tau} - E_{Sn} \Delta t_L \\
 \Delta \widetilde{Sn}_{(1)}^* &=& \Delta \widetilde{Sn}_{(1)}^{\tau} - E_{Sn}/A_{Sn} \Delta t_L
\end{eqnarray}
万が一, 昇華量が第１層目の積雪量よりも大きい場合には, 残りを一つ下の層から
差し引く. これにより第２層目が足りなくなった場合も同様である. 

\subsubsection{積雪の融解}

次に積雪中の熱伝導を計算し, 融雪量を求める. 
積雪中の熱伝導の計算方法は後で述べる. 
熱伝導により更新された積雪温度を $T_{Sn(k)}^*$ とする. 
温度を計算して, 積雪第１層の温度が
$T_{melt} = 0^{\circ}$Cよりも高くなった場合には, 第１層の温度を
$T_{melt}$ に固定して計算をやり直す. その場合, 第１層目にはエネルギー収
束 $\Delta \widetilde{F}_{conv}$ が計算されている. これはグリッド平均値
ではなく, 積雪域の値である. 
第１層の融雪量は, 
\begin{equation}
 \widetilde{M}_{Sn(1)} = \min(\Delta \widetilde{F}_{conv} / l_m, \Delta \widetilde{Sn}_{(1)}^*/\Delta t_L ) \label{snow_melt1}
\end{equation}
である. 

第２層目以下に関しては, 温度が $T_{melt}$ よりも高ければ, $T_{melt}$ に戻し, 
その温度変化分の内部エネルギーを融雪に使う. 
すなわち, 
\begin{equation}
 T_{Sn(k)}^{**} = T_{melt} 
\end{equation}
とし, $\Delta \widetilde{F}_{conv}$ を新たに
\begin{equation}
 \Delta \widetilde{F}_{conv} = ( T_{Sn(k)}^* - T_{melt} ) c_{pi}\Delta \widetilde{Sn}_{(k)}^*/\Delta t_L
\end{equation}
で定義し, (\ref{snow_melt1}) と同様に融雪量を求める. 

融雪量を差し引いて各層の質量を更新する. 
\begin{equation}
 \Delta \widetilde{Sn}_{(k)}^{**} = \Delta \widetilde{Sn}_{(k)}^{*} 
 - \widetilde{M}_{Sn(k)}
\end{equation}

これらの計算の途中で, ある層が全て融解した場合には, 
$\Delta \widetilde{F}_{conv}$ の残りは一つ下の層に与えられ, 
一つ下の層の温度を上昇させる. すなわち, 
\begin{equation}
 \Delta \widetilde{F}_{conv}^* = \Delta \widetilde{F}_{conv} - l_m \widetilde{M}_{Sn(k)}
\end{equation}
\begin{equation}
 T_{Sn(k+1)}^{**} = T_{Sn(k+1)}^{*} + \Delta \widetilde{F}_{conv}^* / (c_{pi} \Delta \widetilde{Sn}_{(k+1)}^*) \Delta t_L
\end{equation}
ここで, $c_{pi}$ は雪(氷)の比熱である. 
また, 積雪が全て融解した場合には, 
 $\Delta \widetilde{F}_{conv}^*$ は土壌に与えられる. 

積雪全体の融雪量は, 各層の融雪量の和である(ただし, グリッド平均値である
ことに注意). 
\begin{equation}
 M_{Sn} = \sum_{k=1}^{K_{Sn}} \widetilde{M}_{Sn(k)} A_{Sn}
\end{equation}
融雪量を差し引いて, 積雪量を部分的に更新する. 
\begin{equation}
 Sn^{**} = Sn^{*} - M_{Sn} \Delta t_L
\end{equation}

\subsubsection{積雪中での融雪水と降雨の凍結}

融雪水と降雨の積雪中での凍結を計算する. 
融雪水については, 上の層の融雪で生じた液体水が下の層で再凍結する効果を考
慮するものである. 
積雪中に保持されている液体水分量は考慮せず, 全て積雪中で凍結するか積雪の
下に流れ落ちるかのどちらかとして扱う. 

積雪域における, 積雪上端での液体水フラックスは, 
\begin{equation}
 \widetilde{F}_{wSn(1)} = Pr_c^* + Pr_l^* + M_{Sn} / A_{Sn}
\end{equation}
ここで, 積雪の第２層目以下で融解した分も, 積雪上端から流すことにする. 
(実際問題としては, 第２層目以下で融雪が起こることは少ない)

融雪水の温度は 0$^{\circ}$C と考えて妥当と思われるが, 積雪上への降雨の温
度も便器的に 0$^{\circ}$C と仮定する. 
水の凍結の潜熱によって積雪の温度は上昇するが, ある層の積雪の温度が
0$^{\circ}$C まで上昇したら, それ以上の水は凍結できず, 一つ下の層に流れ
るとする. また, それ以外にも, その層の積雪の質量に比べてある割合しか凍結
できないとする上限を設ける. すなわち, ある層での凍結量$\widetilde{Fr}_{Sn(k)}$は, 
\begin{equation}
 \widetilde{Fr}_{Sn(k)} = \min\left( \widetilde{F}_{wSn(k)}, \ 
\frac{c_{pi}(T_{melt}-T_{Sn(k)}^{**})}{l_m}
\frac{\Delta \widetilde{Sn}_{(k)}^{**}}{\Delta t_L} , \ 
f_{Fmax}\frac{\Delta \widetilde{Sn}_{(k)}^{**}}{\Delta t_L} \right)
\end{equation}
により求める. 
$\widetilde{F}_{wSn(k)}$ は積雪の第 $k$層目の上端から流れ込む液体水フラックスである. 
$f_{Fmax}$ は標準では 0.1 とする. 

積雪の温度変化は, 
\begin{equation}
 T_{Sn(k)}^{***} = \frac{l_m \widetilde{Fr}_{Sn(k)}\Delta t_L 
   +c_{pi}(T_{Sn(k)}^{**}\Delta \widetilde{Sn}_{(k)}^{**} + T_{melt} \widetilde{Fr}_{Sn(k)}\Delta t_L ) }
  {c_{pi} (\Delta \widetilde{Sn}_{(k)}^{**} + \widetilde{Fr}_{Sn(k)}\Delta t_L)}
\end{equation}
と更新し, また, 質量を
\begin{equation}
 \Delta \widetilde{Sn}_{(k)}^{***} = \Delta \widetilde{Sn}_{(k)}^{**} + \widetilde{Fr}_{Sn(k)}\Delta t_L
\end{equation}
と更新する. 

積雪全体の凍結量は, 各層の凍結量の和である(ただし, グリッド平均値である). 
\begin{equation}
 Fr_{Sn} = \sum_{k=1}^{K_{Sn}} \widetilde{Fr}_{Sn(k)} A_{Sn}
\end{equation}
凍結量を加えて, 積雪量を部分的に更新する. 
\begin{equation}
 Sn^{***} = Sn^{**} + Fr_{Sn} \Delta t_L
\end{equation}

積雪を下まで通過した液体水は, 土壌に与えられる. 

\subsubsection{降雪}

最後に, キャノピーによる遮断を経た降雪量を加えて, 最終的に更新された積雪
量を得る. 
\begin{eqnarray}
 Sn^{\tau+1} &=& Sn^{***} + P_{Sn}^* \Delta t_L
\end{eqnarray}

ただし, 土壌第１層の温度が $0^{\circ}$C 以上の場合には, 降雪は地面で融け
るとする. この場合, 融解の潜熱の分のエネルギーは土壌から奪う. 

今まで積雪が存在しなかったグリッドに降雪により積雪が生じた場合, ここで新
たに(\ref{snow_asn})により, 積雪面積率 $A_{Sn}$ を診断するとともに, 積雪
温度 $T_{Sn(1)}$ は土壌第１層の温度と等しいと仮定する. 

また, 第１層の質量に降雪量を加える. 
\begin{equation}
 \Delta \widetilde{Sn}_{(k)}^{\tau+1} = \Delta \widetilde{Sn}_{(k)}^{***} + P_{Sn}^* \Delta t_L /A_{Sn}
\end{equation}

\subsubsection{積雪層の再分割と温度の再診断}

積雪量が更新された時点で, 積雪面積率を(\ref{snow_asn})により再診断し, 各
層の質量を (\ref{snow_cut1})$\sim$(\ref{snow_cut3}) により再分割する.  
再分割された各層の温度は, エネルギーが保存するように診断しなおす. 
\begin{equation}
 T_{Sn(k)}^{new} = \left(\sum_{l=1}^{K_{Sn}^{old}} f_{(l^{old}\in k^{new})} T_{Sn(l)}^{old} \Delta \widetilde{Sn}_{(l)}^{old} A_{Sn}^{old} \right)
\Bigm/ (\Delta \widetilde{Sn}_{(k)}^{new} A_{Sn}^{new})
\end{equation}
ただし, $old$ の添え字の付いたものは再分割前, $new$ の添え字の付いたもの
は再分割後の変数である. 
$f_{(l^{old}\in k^{new})}$ は, 再分割前の $l$ 層目の質量のうち, 再分割後
の $k$ 層目に含まれている割合である. 

\subsection{積雪中の熱伝導の計算}

\subsubsection{積雪中の熱伝導方程式}

積雪中の熱伝導による積雪温度の予報方程式は以下のようである. 
\begin{equation}
c_{pi}\Delta \widetilde{Sn}_{(k)} \frac{T_{Sn(k)}^* - T_{Sn(k)}^{\tau}}{\Delta t_L} = \widetilde{F}_{Sn(k+1/2)} - \widetilde{F}_{Sn(k-1/2)}
\qquad (k=1,\ldots,K_{Sn})
\label{snow_diff}
\end{equation}

ここで, 熱伝導フラックス$\widetilde{F}_{Sn}$は以下で与えられる. 
\begin{equation}
 \widetilde{F}_{Sn(k+1/2)} =
\left\{
\begin{array}{ll}
( F_{Sn(1/2)} - \Delta F_{conv})/A_{Sn} - \Delta F_{c,conv} 
& (k=0)\\
\displaystyle{
k_{Sn(k+1/2)} \frac{T_{Sn(k+1)} - T_{Sn(k)}}{\Delta z_{Sn(k+1/2)}}
}
& (k=1,\ldots,K_{Sn}-1) \\
\displaystyle{
k_{Sn(k+1/2)} \frac{T_{Sn(B)} - T_{Sn(k)}}{\Delta z_{Sn(k+1/2)}}
}
& (k=K_{Sn})
\end{array}
\right. \label{snow_dflux}
\end{equation}
$k_{Sn(k+1/2)}$ は積雪の熱伝導率であり, 標準では 0.3 W/m/K の一定値を
与えている. $\Delta z_{Sn(k+1/2)}$ は積雪各層の厚さであり, 
\begin{equation}
 \Delta z_{Sn(k+1/2)} =
\left\{
\begin{array}{ll}
 0.5 \Delta \widetilde{Sn}_{(1)} / \rho_{Sn} & (k=1)\\
 0.5 (\Delta \widetilde{Sn}_{(k)}+\Delta \widetilde{Sn}_{(k+1)}) / \rho_{Sn} 
& (k=2,\ldots,K_{Sn}-1)\\
 0.5 \Delta \widetilde{Sn}_{(K_{Sn})} / \rho_{Sn} & (k=K_{Sn})
\end{array}
\right.
\end{equation}
で定義される. $\rho_{Sn}$ は積雪の密度であり, 標準では 300 kg/m$^3$ の一
定値を与えている. 
積雪の密度や熱伝導率は, 時間が経つにつれて圧密や変質により変化する
(aging) と考えられるが, ここではその効果は考慮していない. 

(\ref{snow_dflux})において,
積雪上端のフラックス$ \widetilde{F}_{Sn(1/2)}$は, 地表面エネルギーバラン
スのところで求めた積雪から地表面への熱伝導フラックス $F_{Sn(1/2)}$, 地表
面温度を融雪条件で解いた場合に生じた地表エネルギー収束 $\Delta
F_{conv}$, およびキャノピー上水分の相変化があった場合に生じたエネルギー
補正 $\Delta F_{c,conv}$ を用いて与えられている. 
$\Delta F_{conv}$ は積雪面上のみに, $\Delta F_{c,conv}$ はグリッドに一様
に与えられるとした. フラックスの符号を上向き正に取るので, 収束量に負号が
付く. 

また, 積雪下端のフラックス $\widetilde{F}_{Sn(K_{Sn}+1/2)}$ の式にお
いて, $T_{Sn(B)}$ は, 積雪下端(積雪と土壌の境界面)の温度である. 
ところが, 土壌第１層から積雪下端へのフラックスは
\begin{equation}
\widetilde{F}_{g(1/2)} = k_{g(1/2)} \frac{T_{g(1)}-T_{Sn(B)}}{\Delta z_{g(1/2)}}
\end{equation}
であるから, 積雪下端でフラックスの収束が無いと仮定し, 
\begin{equation}
\widetilde{F}_{Sn(K_{Sn}+1/2)} =  \widetilde{F}_{g(1/2)}
\end{equation}
と置くことにより, $T_{Sn(B)}$ が求まり, これを(\ref{snow_btm}) に代入
して以下を得る. 
\begin{equation}
\widetilde{F}_{Sn(K_{Sn}+1/2)} = 
\left[\frac{\Delta z_{g(1/2)}}{k_{g(1/2)}}
+\frac{\Delta z_{Sn(K_{Sn}+1/2)}}{k_{Sn(K_{Sn}+1/2)}}
\right]^{-1}
(T_{g(1)} - T_{Sn(K_{Sn})})
\label{snow_btm}
\end{equation}

\subsubsection{ケース1:第１層目で融雪が起こらない場合}

積雪第１層から最下層の温度に関して, 陰解法を用いる. 
すなわち, 
\begin{equation}
 \widetilde{F}_{Sn(k+1/2)}^* = \widetilde{F}_{Sn(k+1/2)}^{\tau}  
+\frac{\partial \widetilde{F}_{Sn(k+1/2)}}{\partial T_{Sn(k)}} 
 \Delta T_{Sn(k)}
+\frac{\partial \widetilde{F}_{Sn(k+1/2)}}{\partial T_{Sn(k+1)}} 
 \Delta T_{Sn(k+1)}
\end{equation}
\begin{equation}
 \widetilde{F}_{Sn(k+1/2)}^{\tau} =
\left\{
\begin{array}{ll}
( F_{Sn(1/2)} - \Delta F_{conv})/A_{Sn} - \Delta F_{c,conv} 
& (k=0)\\
\displaystyle{
\frac{k_{Sn(k+1/2)}}{\Delta z_{Sn(k+1/2)}} (T_{Sn(k+1)}^{\tau} - T_{Sn(k)}^{\tau})
}
& (k=1,\ldots,K_{Sn}-1) \\
\displaystyle{
\left[\frac{\Delta z_{g(1/2)}}{k_{g(1/2)}}
+\frac{\Delta z_{Sn(K_{Sn}+1/2)}}{k_{Sn(K_{Sn}+1/2)}}
\right]^{-1}
(T_{g(1)} - T_{Sn(K_{Sn})}^{\tau})
}
& (k=K_{Sn})
\end{array}
\right. 
\end{equation}
\begin{equation}
 \frac{\partial \widetilde{F}_{Sn(k+1/2)}}{\partial T_{Sn(k)}} =
\left\{
\begin{array}{ll}
\displaystyle{
- \frac{k_{Sn(k+1/2)}}{\Delta z_{Sn(k+1/2)}} 
}
& (k=1,\ldots,K_{Sn}-1) \\
\displaystyle{
- \left[\frac{\Delta z_{g(1/2)}}{k_{g(1/2)}}
+\frac{\Delta z_{Sn(K_{Sn}+1/2)}}{k_{Sn(K_{Sn}+1/2)}}
\right]^{-1}
}
& (k=K_{Sn})
\end{array}
\right. 
\end{equation}
\begin{equation}
 \frac{\partial \widetilde{F}_{Sn(k+1/2)}}{\partial T_{Sn(k+1)}} =
\left\{
\begin{array}{ll}
0 & \ \quad \qquad \qquad \qquad \qquad (k=0) \\
\displaystyle{
\frac{k_{Sn(k+1/2)}}{\Delta z_{Sn(k+1/2)}} 
}
  & \ \quad \qquad \qquad \qquad \qquad (k=1,\ldots,K_{Sn}-1) 
\end{array}
\right. 
\end{equation}
と置いて, (\ref{snow_diff}) を
\begin{eqnarray}
c_{pi}\Delta \widetilde{Sn}_{(k)} \frac{\Delta T_{Sn(k)}}{\Delta t_L} 
&=& \widetilde{F}_{Sn(k+1/2)}^* - \widetilde{F}_{Sn(k-1/2)}^* \nonumber \\
&=& \widetilde{F}_{Sn(k+1/2)}^{\tau} 
+\frac{\partial \widetilde{F}_{Sn(k+1/2)}}{\partial T_{Sn(k)}} 
 \Delta T_{Sn(k)}
+\frac{\partial \widetilde{F}_{Sn(k+1/2)}}{\partial T_{Sn(k+1)}} 
 \Delta T_{Sn(k+1)} \nonumber \\
&-& \widetilde{F}_{Sn(k-1/2)}^{\tau}
-\frac{\partial \widetilde{F}_{Sn(k-1/2)}}{\partial T_{Sn(k-1)}} 
 \Delta T_{Sn(k-1)}
-\frac{\partial \widetilde{F}_{Sn(k-1/2)}}{\partial T_{Sn(k-1)}} 
 \Delta T_{Sn(k)}
\end{eqnarray}
のように扱い, $\Delta T_{Sn(k)}\ (k=1,\ldots,K_{Sn})$ についての
$K_{Sn}$ 本の連立方程式として LU 分解法により解く. 
この際, 積雪上端のフラックスは境界条件として固定していること, 積雪下端の
境界条件は土壌第１層温度であり, 積雪下端フラックスは土壌第１層温度に関し
ては陽解法的に扱うことに注意されたい. 
\begin{equation}
 T_{Sn(k)}^* = T_{Sn(k)}^{\tau} + \Delta T_{Sn(k)}
\end{equation}
により積雪温度を部分的に更新する. 

\subsubsection{ケース2:第１層目で融雪が起こる場合}

ケース1で解いてみた積雪第１層の温度が $T_{melt} = 0^{\circ}$C よりも高い場
合, 積雪第１層で融雪が生じる. この場合, 積雪第１層温度は $0^{\circ}$Cに
固定される. すなわち, 積雪第２層目から第１層目へのフラックスを
\begin{equation}
 \widetilde{F}_{3/2}^{*} =
\frac{k_{Sn(3/2)}}{\Delta z_{Sn(3/2)}} (T_{Sn(2)}^{\tau} - T_{melt})
+\frac{\partial \widetilde{F}_{Sn(3/2)}}{\partial T_{Sn(2)}} 
 \Delta T_{Sn(2)}
\end{equation}
のように置いて, ケース1と同様に解く
(積雪が１層しか無い場合には, 土壌から積雪へのフラックスにおいて, 同様に
積雪温度を固定する). 

積雪第１層の融解に使われるエネルギー収束は以下で与えられる. 
\begin{equation}
 \Delta \widetilde{F}_{conv} = (\widetilde{F}_{3/2}^{*} - \widetilde{F}_{1/2})
  - c_{pi}\Delta \widetilde{Sn}_{(1)} \frac{T_{melt}-T_{Sn(1)}^*}{\Delta t_L} 
\end{equation}

積雪第２層目以下の温度が $T_{melt}$ よりも高くなっても解き直しは行わず,
補正的に融雪を処理する. 

\subsection{氷河の生成}

積雪量に最大値を設け, 最大値を越えた分は氷河となって流出すると考える. 
\begin{equation}
 Ro_{gl} = \max( Sn - Sn_{\max} ) / \Delta t_L
\end{equation}
\begin{eqnarray}
 Sn &=& Sn - Ro_{gl} \Delta t_L \\
 \Delta \widetilde{Sn}_{(K_{Sn})} &=& \Delta \widetilde{Sn}_{(K_{Sn})} 
 - Ro_{gl} / A_{Sn} \Delta t_L
\end{eqnarray}
$Ro_{gl}$は氷河流出量である. この分の質量は積雪の最下層から差し引く. 
$Sn_{\max}$ は標準では一律に 1000 kg/m$^2$ で与える. 

\subsection{土壌もしくは流出過程へ与えられるフラックス}

積雪過程を経てへ土壌へ与えられる熱フラックスは以下である. 
\begin{equation}
\Delta F_{conv}^* = A_{Sn} ( \Delta \widetilde{F}_{conv}^* - \widetilde{F}_{Sn_{K_{Sn}}} ) - l_m P_{Sn,melt}^* 
\end{equation}
$\Delta \widetilde{F}_{conv}^*$ は積雪が全て融雪した場合に残ったエネルギー
収束, $\widetilde{F}_{Sn_{K_{Sn}}}$ は積雪最下層の熱伝導フラックス, 
$P_{Sn,melt}^*$ は, 地面に到達してすぐに融けた降雪量である. 

また, キャノピー上水分の相変化によるエネルギー補正項は, 無積雪面の分が土
壌にそのまま与えられるため, 以下のようになる. 
\begin{equation}
 \Delta F_{c,conv}^* = ( 1 - A_{Sn}) \Delta F_{c,conv} 
\end{equation}

積雪過程を経て流出過程へ与えられる水フラックスは以下である. 
\begin{eqnarray}
 Pr_c^{**} &=& ( 1 - A_{Sn} ) Pr_c^{*} \\
 Pr_l^{**} &=& ( 1 - A_{Sn} ) Pr_l^{*} + A_{Sn} \widetilde{F}_{wSn}^*
 + P_{Sn,melt}^* 
\end{eqnarray}
$\widetilde{F}_{wSn}^*$ は, 積雪最下層を通過した降雨もしくは融雪水のフラッ
クスである. 

\subsection{積雪アルベドの計算}

積雪のアルベドは, 新雪では大きいが, 圧密, 変質や汚れの付着によって時間が
経つにつれて小さくなる. この効果を考慮するため, 積雪のアルベドを予報変数
として取り扱う. 

積雪の「古さ」(age) の時間発展は, Wiscombe and Warren (1980) にならい,
以下の式に従うとする. 
\begin{equation}
 \frac {A_{g}^{\tau +1} - A_{g}^{\tau}}{\Delta t_L} 
 = \left\{
\exp \left[ f_{ageT} \left( \frac{1}{T_{melt}}-\frac{1}{T_{Sn(1)}}\right) \right] 
  + r_{dirt} \right\} \Bigm/ {\tau_{age}}
\end{equation}
$f_{ageT}$ = 5000, $\tau_{age}$ = 1$\times$10$^6$ である. 
$r_{dirt}$ は, 汚れの付着に関するパラメータで, 氷床上では $0.01$, その他
の場所では $0.3$ を与えている. 

これを用いて積雪のアルベドは, 
\begin{eqnarray}
 \alpha_{Sn(b)}^{\tau+1} = \alpha_{Sn(b)}^{new} + \frac{A_g^{\tau+1}}{1+A_g^{\tau+1}} (\alpha_{Sn(b)}^{old} - \alpha_{Sn(b)}^{new}) \qquad (b=1,2,3)
\end{eqnarray}
により求める. 
ここで $A_g^{\tau}$ は, 予報変数である $\alpha_{Sn(1)}^{\tau}$ から, 上
と同様の式により逆算して求めておいたものである. 

降雪があった場合には, 降雪量に応じてアルベドが新雪の値に更新される. 
\begin{eqnarray}
 \alpha_{Sn(b)}^{\tau+1} = \alpha_{Sn(b)}^{\tau+1} 
+ \min\left( \frac{P_{Sn}^* \Delta t_L}{\Delta{Sn_c}}, 1 \right) (\alpha_{Sn(b)}^{new} - \alpha_{Sn(b)}^{\tau+1}) \qquad (b=1,2,3)
\end{eqnarray}
$\Delta {Sn_c}$ は, アルベドが完全に新雪の値に戻るのに必要な積雪量である. 

\section{流出サブモデル MATROF}

簡略化した TOPMODEL (Beven and Kirkby, 1979) を用いて, 地表流出および地
下水流出を求める. 

\subsection{TOPMODEL の概要}

TOPMODEL では, 流域内の斜面に沿った地下水面の水平分布を考える. 
斜面のある点を下る地下水流は, その点より上方の斜面における地下水涵養量を
積算したものとつり合うと仮定する(準定常の仮定). 
すると, 斜面の下方ほど地下水流が大きくなければならない. 後に述べる別の仮
定により, 地下水流が大きくなるためには地下水面が浅いことが必要とされる. 
こうして, 斜面の下方ほど地下水面が浅いという分布が導出される. 
平均的な地下水面がある程度より浅い場合, 斜面のある点から下では地下水面が
地面まで上がり, 飽和域を形成する. 
このように, TOPMODEL では, 平均地下水面, 飽和域面積, 地下水流速という,
流出の見積もりにとって重要な概念が, 物理的に整合性をもって結びつく点に特
徴がある. 

TOPMODEL では, 以下の３つの主要な仮定を置く. 
\begin{enumerate}
  \item 土壌の飽和透水係数は, 土壌の深くに向かって指数関数的に減衰する. 
  \item 地下水面の勾配は, 局所的には斜面の勾配とほぼ一致する. 
  \item 斜面のある点を下る地下水流は, その点より上方の斜面における地下水
	涵養量を積算したものとつり合う. 
\end{enumerate}

以下で, 記号の使い方は通常の TOPMODEL の記述の慣例に準じる
(Sivapalan et al., 1987 ; Stieglitz et al., 1997). 

仮定1 は以下のように書ける. 
\begin{equation}
 K_s(z) = K_0 \exp (-f z)
\end{equation}
$K_s(z)$ は深さ $z$ における土壌の飽和透水係数, $K_0$ は地表面における飽
和透水係数, $f$ は減衰係数である. 

ある点 $i$ での地下水面の深さを $z_i$ とするとき, その点で斜面を下る地下
水フラックス $q_i$ は以下で表される. 
\begin{equation}
 q_i = \int_{z_i}^Z K_s(z) dz \cdot \tan\beta
   = \frac{K_0}{f}  \tan\beta [\exp(-f z_i) - \exp(-f Z)]
 \label{top_qi}
\end{equation}
$\beta$ は斜面の勾配であり, ここで仮定2を用いた. $Z$ は不透水面の深さで
あるが, 通常 $Z$ は $1/f$ に比べて十分深いと仮定して, $\exp(-f Z)$
の項は省く. また, 地下水面より上の不飽和帯の斜面方向土壌水分フラックスは
小さいので無視する. 

地下水涵養速度は水平一様に $R$ であるとすると, 仮定 3は以下のように表さ
れる. 
\begin{equation}
 a R = \frac{K_0}{f} \tan\beta \exp(-f z_i)
\end{equation}
ここで, $a$ は, 地点 $i$ に対する上流総面積(地点 $i$ での単位等高線長さ
あたり)である. 

これを $z_i$ について解くと, 以下を得る. 
\begin{equation}
 z_i = -\frac{1}{f} \ln \left( \frac{faR}{K_0 \tan \beta}\right)
 \label{top_zi}
\end{equation}

領域 $A$ において平均した地下水面深さ $\overline{z}$ は, 
\begin{equation}
   \overline{z} = \frac1{A}\int_{A} z_i dA
  = - \Lambda - \frac1{f} \ln R
 \label{top_zbar}
\end{equation}  
\begin{equation}
 \Lambda \equiv
  \frac1{A}\int_{A} \ln \left( \frac{fa}{K_0 \tan \beta}\right) dA
\end{equation}

これにより, 涵養速度 $R$ が平均地下水面深さ $\overline{z}$ の関数として
以下のように表される. 
\begin{equation}
 R = \exp (-f \overline{z} -\Lambda)
 \label{top_r}
\end{equation}
仮定 3により, これは領域 $A$ から排水される地下水流出量に他ならない. 

次に, $R$ を (\ref{top_zi}) に代入すると以下の $z_i$ と $\overline{z}$
の関係を得る. 
\begin{equation}
 z_i = \overline{z} - \frac{1}{f} \left[
\ln \left( \frac{fa}{K_0 \tan \beta}\right) - \Lambda
\right]
 \label{top_zizbar}
\end{equation}

$z_i \leq 0$ を満たす領域が地表飽和域である. 

\subsection{簡略地形を仮定した TOPMODEL の適用}

通常, TOPMODEL が用いられる場合には, 対象地域の詳細な地形データを必要と
するが, ここではグリッドの平均的な傾斜と標高標準偏差のデータから, グリッ
ド内の斜面の平均的な形状を大まかに見積もる
(この見積もり方は現時点では暫定的なものであり, さらに検討を要する). 

グリッド内の地形を, 一様な勾配$\beta_s$を持ち, 尾根から谷までの距離が
$L_s$ の斜面によって代表させる. 

$L_s$ は, 標高標準偏差 $\sigma_z$ を用いて以下のように見積もる. 
\begin{equation}
 L_s = 2\sqrt{3} \sigma_z / \tan\beta_s
\end{equation}
$2\sqrt{3}\sigma_z$ は, 標高標準偏差が $\sigma_z$ になるような鋸型の地形
における尾根と谷の標高差である. 

水平面上に, 尾根から谷に向かって $x$軸を取る. 
このとき, 地点 $x$ における上流総面積は $x$ であるから, (\ref{top_zi})
は以下のようになる. 
\begin{equation}
 z(x) = - \frac{1}{f} \ln \left( \frac{fxR}{K_0 \tan \beta_s}\right)
\end{equation}
これを用いて, 平均地下水面は, (\ref{top_zbar})より
\begin{equation}
 \overline{z} = \frac 1{L_s}\int_0^{L_s} z(x) dx 
 = - \frac1{f}\left[
 \ln \left( \frac{f L_s R}{K_0 \tan\beta_s}\right) -1
\right]
\end{equation}
地下水涵養速度は, (\ref{top_r}) より
\begin{equation}
 R = \frac{K_0 \tan\beta_s}{f L_s}\exp(1-f \overline{z})
\label{top_rb}
\end{equation}
地点 $x$ の地下水面と平均地下水面の関係は, (\ref{top_zizbar}) より
\begin{equation}
 z(x) = \overline{z} - \frac{1}{f}\left(
\ln \frac{x}{L_s} + 1
\right)
\end{equation}
となる. 
$z(x) \leq 0$ を $x$ について解くと以下のようになる. 
\begin{equation}
 x \geq x_0
\end{equation}
\begin{equation}
x_0 = L_s \exp(f\overline{z}-1)
 \end{equation}
従って, 飽和域の面積率は, 
\begin{equation}
 A_{sat} = (L_s - x_0)/ L_s = 1 - \exp(f\overline{z}-1)
\label{top_asat}
\end{equation}
と求まる. ただし, $A_{sat} \geq 0$ であり, $\overline{z} > 1/f$ のときに
は飽和域は存在しない. 

\subsection{流出量の計算}

４種類の流出メカニズムを考え, それぞれのメカニズムによる流出量の合計をグ
リッドからの総流出量とする. 
\begin{equation}
 Ro = Ro_s + Ro_i + Ro_o + Ro_b
\end{equation}
$Ro_s$ は saturation excess runoff (Dunne runoff), $Ro_i$ は
infiltration excess runoff (Horton runoff), $Ro_o$ は土壌第１層のオーバー
フローであり, 以上は地表流出に分類される. $Ro_b$ は地下水流出である. 

\subsubsection{平均地下水面深さの見積もり}

土壌水分量を土壌最下層から見ていき, 初めて不飽和になった層を $k_{WT}$ 層
目とするとき, 平均地下水面深さ $\overline{z}$を以下により見積もる. 
\begin{equation}
 \overline{z} = z_{g(k_{WT}-1/2)} - \psi_{k_{WT}}
\label{roff_table}
\end{equation}
これは, 不飽和層の上端の水分ポテンシャルを$\psi_{k_{WT}}$と仮定し, その
下で土壌水分分布が平衡状態(重力と毛管力がつり合った状態)にあると考えてい
ることに相当する. 

$\overline{z} > z_{g(k_{WT}+1/2)}$ のとき, $k_{WT}$ が最下層ならば地下水
面は存在しないとする. $k_{WT}$ が最下層でない場合には, ひとつ下の層(飽和
しているうちの最上層)を $k_{WT}$ として上式を適用する. 

土壌の途中に凍土面がある場合は, 地下水面深さの見積もりは凍土面の上から行
う. 

\subsubsection{地下水流出の計算}

地下水流出は, 準定常の仮定により (\ref{top_rb}) の地下水涵養速度と等しいので, 
\begin{equation}
 Ro_b = \frac{K_0 \tan\beta_s}{f L_s}\exp(1-f \overline{z})
\end{equation}
である. 
ただし, 地下水面の下に凍土面がある場合には, (\ref{top_qi}) の
$\exp(-fZ)$ の項を省かない場合を参考に, 
\begin{equation}
 Ro_b = \frac{K_0 \tan\beta_s}{f L_s}
  [ \exp(1-f \overline{z}) - \exp(1-f z_f) ]
\end{equation}
とする. $z_f$ は凍土面の深さである. 
このようにする場合, TOPMODEL の他の関係式も変わってくるはずであるが, 簡
略化のために他の関係式は変更しない. 

また, 凍土面の下に不凍層があり, そこに地下水面が存在した場合には, そこか
らの地下水流出も同様に計算して加える. 

地下水流出した水分は, 後で土壌第 $k_{WT}$ 層目から取り除く. 
\begin{equation}
 Ro_{(k_{WT})} = Ro_b
\end{equation}
$Ro_{(k)}$ は第 $k$ 層目の土壌からの流出フラックスを表す. 


\subsubsection{地表流出の計算}

地表飽和域に降った降水は全てそのまま流出する(saturation excess runoff). 
\begin{equation}
 Ro_s = (Pr_c^{**} + Pr_l^{**}) A_{sat}
\end{equation}
地表飽和域の面積率 $A_{sat}$ は, (\ref{top_asat}) により与えられる. 
ここで, サブグリッドの降水分布と地形との相関は無視している. 

地表不飽和域に降った降水は, 土壌の浸透能を上回った分だけ流出する
(infiltration excess runoff). 
土壌の浸透能は, 簡略化のため, 土壌第１層の飽和透水係数で与える. 
対流性の降水は局所的に降ると考え, その降水域の面積率 $A_c$は一律に
仮定する(標準では 0.1). 層状性降水は一様と仮定する. 
\begin{eqnarray}
 Ro_i^c &=& \max( Pr_c^{**}/A_c + Pr_l^{**} - K_{s(1)}, 0 ) (1 - A_{sat}) \\
 Ro_i^{nc} &=& \max( Pr_l^{**} - K_{s(1)}, 0 ) (1 - A_{sat})
\end{eqnarray}
\begin{equation}
 Ro_i = A_c Ro_i^c + ( 1 - A_c ) Ro_i^{nc}
\end{equation}
$Ro_i^c$, $Ro_i^{nc}$ は, それぞれ対流性降水域とそうでない場所の $Ro_i$
であり, $K_{s(1)}$ は土壌第１層の飽和透水係数である. 

土壌第１層のオーバーフローは, わずかな湛水$w_{str}$(標準では 1mm)を許し
て, 
\begin{equation}
 Ro_o = \max(w_{(1)} - w_{sat(1)} - w_{str}, 0) \rho_w \Delta z_{g(1)} / \Delta t_L
\end{equation}
とする. この分は後で土壌第１層から差し引くため, 第１層目からの流出量とし
て覚えておく. 
\begin{equation}
 Ro_{(1)} = Ro_{(1)} + Ro_o
\end{equation}

\subsection{土壌へ与えられる水フラックス}

流出過程を経て土壌へ与えられる水フラックスは以下である. 
\begin{equation}
 Pr^{***} = Pr^{**}_c + Pr^{**}_l - Ro_s - Ro_i
\end{equation}

\section{土壌サブモデル MATGND}

土壌温度, 土壌水分および凍土の計算を行う. 

\subsection{土壌中の熱伝導の計算}

\subsubsection{土壌中の熱伝導方程式}

土壌中の熱伝導による土壌温度の予報方程式は以下のようである. 
\begin{equation}
C_{g(k)} \frac{T_{g(k)}^* - T_{g(k)}^{\tau}}{\Delta t_L} = F_{g(k+1/2)} - F_{g(k-1/2)}
\qquad (k=1,\ldots,K_{g}) 
\label{gnd_diff}
\end{equation}
$C_{g(k)}$ は土壌の熱容量であり, 以下で定義される. 
\begin{equation}
 C_{g(k)} = ( c_{g(k)} + \rho_w c_{pw} w_{(k)} ) \Delta z_{g(k)}
\end{equation}
$c_{g(k)}$ は土壌の比熱であり, 土壌タイプごとのパラメータとして与える. 
$c_{pw}$ は水の比熱, $w_{(k)}$ は土壌水分量(体積含水率)である. 
$\Delta z_{g(k)}$ は, 土壌第$k$層の厚さである. 
このように, 土壌の熱容量に土壌水分の熱容量を含めると, 土壌水分移動に伴う
熱輸送を考慮しない限りエネルギーが保存しない. 
現在, MATGND では土壌水分移動に伴う熱輸送は考慮されていないので, その導
入を検討している. 
もっとも, 大気中の水蒸気や降水などの熱容量が考慮されない限り, 何らかの意
味ではエネルギーの保存が破れていることに注意されたい. 

熱伝導フラックス$F_{g}$は以下で与えられる. 
\begin{equation}
 F_{g(k+1/2)} =
\left\{
\begin{array}{ll}
F_{g(1/2)} - \Delta F_{conv}^* - \Delta F_{c,conv}^*
& (k=0)\\
\displaystyle{
k_{g(k+1/2)} \frac{T_{g(k+1)} - T_{g(k)}}{\Delta z_{g(k+1/2)}}
}
& (k=1,\ldots,K_{g}-1) \\
\displaystyle{
0
}
& (k=K_{g})
\end{array}
\right. 
\label{gnd_dflux}
\end{equation}
ここで, $k_{g(k+1/2)}$ は土壌の熱伝導率であり, 以下のように与える. 
\begin{equation}
 k_{g(k+1/2)} = k_{g0(k+1/2)} [ 1 + f_{kg} \tanh( w_{(k)}/ w_{kg} ) ]
\end{equation}
$k_{g0(k+1/2)}$ は土壌水分が $0$ のときの熱伝導率, $f_{kg}=6$,
$w_{kg}=0.25$ は定数である. 

$\Delta z_{g(k+1/2)}$ は, 第$k$層と第$k+1$層の土壌温度定義点の間の厚さで
ある ($k=0$ については, 第１層温度定義点と土壌上端, $k=K_g$ については,
最下層温度定義点と土壌下端の間の厚さ). 

(\ref{gnd_dflux})において, 
土壌上端の境界条件 $F_{g(1/2)}$は, 地表面エネルギーバランスを解いた際に
求めた値に, 積雪下端におけるエネルギー収束(積雪下端における熱伝導フラッ
クスを含む)およびキャノピー上水分の相変化によるエネルギー補正項の無雪面
への割り当て分を加えたものを与えている. フラックスは上向き正に取るため,
収束量を加える場合には負号が付く. 
土壌下端の境界条件 $F_{g(K_g+1/2)}$ はゼロフラックスとする. 

\subsubsection{熱伝導方程式の求解}

これらの式を, 第１層から最下層までの土壌温度に関して陰解法を用いて解く. 
すなわち, $k=1,\ldots,K_g-1$について, 熱伝導フラックスを
\begin{equation}
  F_{g(k+1/2)}^{*} = F_{g(k+1/2)}^{\tau}
+\frac{\partial {F}_{g(k+1/2)}}{\partial T_{g(k)}} 
 \Delta T_{g(k)}
+\frac{\partial {F}_{g(k+1/2)}}{\partial T_{g(k+1)}} 
 \Delta T_{g(k+1)}
\end{equation}
\begin{equation}
  F_{g(k+1/2)}^{\tau} =
\frac{k_{g(k+1/2)}}{\Delta z_{g(k+1/2)}}(T_{g(k+1)}^{\tau} - T_{g(k)}^{\tau})
\end{equation}
\begin{equation}
 \frac{\partial {F}_{g(k+1/2)}}{\partial T_{g(k)}} = 
- \frac{k_{g(k+1/2)}}{\Delta z_{g(k+1/2)}}
\end{equation}
\begin{equation}
 \frac{\partial {F}_{g(k+1/2)}}{\partial T_{g(k+1)}} = 
\frac{k_{g(k+1/2)}}{\Delta z_{g(k+1/2)}}
\end{equation}
と置いて, (\ref{gnd_diff})を
\begin{eqnarray}
C_{g(k)} \frac{\Delta T_{g(k)}}{\Delta t_L} 
&=& F_{g(k+1/2)}^* - {F}_{g(k-1/2)}^* \nonumber \\
&=& {F}_{g(k+1/2)}^{\tau} 
+\frac{\partial F_{g(k+1/2)}}{\partial T_{g(k)}} 
 \Delta T_{g(k)}
+\frac{\partial F_{g(k+1/2)}}{\partial T_{g(k+1)}} 
 \Delta T_{g(k+1)} \nonumber \\
&-& F_{g(k-1/2)}^{\tau}
-\frac{\partial F_{g(k-1/2)}}{\partial T_{g(k-1)}} 
 \Delta T_{g(k-1)}
-\frac{\partial F_{g(k-1/2)}}{\partial T_{g(k-1)}} 
 \Delta T_{g(k)}
\end{eqnarray}
のように扱い, $\Delta T_{g(k)}\ (k=1,\ldots,K_{g})$ についての
$K_{g}$ 本の連立方程式として LU 分解法により解く. 
この際, 土壌上端及び下端のフラックスは境界条件として固定して解くことに注
意されたい. 
\begin{equation}
 T_{g(k)}^* = T_{g(k)}^{\tau} + \Delta T_{g(k)}
\end{equation}
により土壌温度を部分的に更新する. 
これに, 後に述べる土壌水分の相変化による補正を経て, 土壌温度が完全に更新
される. 

\subsection{土壌水分移動の計算}

\subsubsection{土壌水分移動の方程式}

土壌水分移動の方程式(Richards の式)は以下で与えられる. 
\begin{equation}
\rho_w \frac{w_{(k)}^{\tau+1} - w_{(k)}^{\tau}}{\Delta t_L} = 
\frac{F_{w(k+1/2)} - F_{w(k-1/2)}}{\Delta z_{g(k)}} + S_{w(k)}
\qquad (k=1,\ldots,K_{g}) 
\label{wat_diff}
\end{equation}

土壌水分フラックス$F_{w}$は以下で与えられる. 
\begin{equation}
 F_{w(k+1/2)} =
\left\{
\begin{array}{ll}
Pr^{***} - Et_{(1,1)}
& (k=0)\\
\displaystyle{
K_{(k+1/2)} \left(\frac{\psi_{(k+1)} - \psi_{(k)}}{\Delta z_{g(k+1/2)}} - 1 \right)
}
& (k=1,\ldots,K_{g}-1) \\
\displaystyle{
0
}
& (k=K_{g})
\end{array}
\right. 
\label{wat_dflux}
\end{equation}
ここで, $K_{(k+1/2)}$ は土壌の透水係数であり, Clapp and Hornberger
(1978) を参考に以下のように与える. 
\begin{equation}
 K_{(k+1/2)} = K_{s(k+1/2)} (\max(W_{(k)},W_{(k+1)}))^{2b(k)+3} f_i
\end{equation}
$K_{s(k+1/2)}$ は飽和透水係数, $b_{(k)}$ は水分ポテンシャル曲線の指数で,
土壌タイプごとの外部パラメータとして与える. 
$W_{(k)}$は凍結土壌水分を除いて考えた飽和度で, 以下で与えられる. 
\begin{equation}
 W_{(k)} = \frac{w_{(k)}-w_{i(k)}}{w_{sat(k)}-w_{i(k)}} 
\end{equation}
$w_{sat(k)}$ は土壌の空隙率で, これも土壌タイプごとのパラメータとして与
える. $f_i$ は凍土の存在により土壌水分の移動が抑制されることを表すパラメー
タで, 現在のところ以下のように与えているが, さらに検討を要する. 
\begin{equation}
 f_i = \left(1- W_{i(k)}\right)
       \left(1- W_{i(k+1)}\right)
\end{equation}
$W_{i(k)} = w_{i(k)}/(w_{sat(k)}-w_{i(k)})$ である. 

$\psi$ は土壌水分ポテンシャルで, Clapp and Hornberger により以下のように
与えられる. 
\begin{eqnarray}
 \psi_{(k)} = \psi_{s(k)} W_{(k)}^{-b(k)}
\end{eqnarray}
$\psi_{s(k)}$ は土壌タイプごとの外部パラメータとして与える. 

(\ref{wat_diff})において, $S_{w(k)}$ はソース項であり, 根による吸い上げ
と流出を考慮して, 以下で与えられる. 
\begin{equation}
 S_{w(k)} = - F_{root(k)} - Ro_{(k)}
\end{equation}

(\ref{wat_dflux})において, 
土壌上端の境界条件 $F_{w(1/2)}$は, 流出過程を経た水分フラックス
$P^{***}$ と土壌からの蒸発フラックス $Et_{(1,1)}$ の差である. 
これとは別に, 昇華フラックスの分は, 土壌水分移動の計算に先立って, 第１層
の凍結土壌水分から差し引く. 
\begin{eqnarray}
 w_{i(k)}^{\tau} &=& w_{i(k)}^{\tau} - Et_{(2,1)} \Delta t_L /(\rho \Delta z_{g(1)})\\
 w_{(k)}^{\tau} &=& w_{(k)}^{\tau} - Et_{(2,1)} \Delta t_L /(\rho \Delta z_{g(1)})
\end{eqnarray}

\subsubsection{土壌水分移動方程式の求解}

これらの式を, 第１層から最下層までの土壌水分に関して陰解法を用いて解く. 
すなわち, $k=1,\ldots,K_g-1$について, 土壌水分フラックスを
\begin{equation}
  F_{w(k+1/2)}^{\tau+1} = F_{w(k+1/2)}^{\tau}
+\frac{\partial {F}_{w(k+1/2)}}{\partial w_{(k)}} 
 \Delta w_{(k)}
+\frac{\partial {F}_{w(k+1/2)}}{\partial w_{(k+1)}} 
 \Delta w_{(k+1)}
\end{equation}
\begin{equation}
  F_{w(k+1/2)}^{\tau} =
K_{(k+1/2)} \left(\frac{\psi_{(k+1)}^{\tau} - \psi_{(k)}^{\tau}}{\Delta z_{g(k+1/2)}} - 1 \right)
\end{equation}
\begin{equation}
 \frac{\partial {F}_{w(k+1/2)}}{\partial w_{(k)}} = 
- \frac{K_{(k+1/2)}}{\Delta z_{g(k+1/2)}} 
\left[
-b_{(k)} \frac{\psi_{s(k)}}{w_{sat(k)}-w_{i(k)}}W_{(k)}^{-b(k)-1}
\right]
\end{equation}
\begin{equation}
 \frac{\partial {F}_{w(k+1/2)}}{\partial w_{(k+1)}} = 
 \frac{K_{(k+1/2)}}{\Delta z_{g(k+1/2)}} 
\left[
-b_{(k)} \frac{\psi_{s(k+1)}}{w_{sat(k+1)}-w_{i(k+1)}}W_{(k+1)}^{-b(k)-1}
\right]
\end{equation}
と置いて, (\ref{wat_diff})を
\begin{eqnarray}
\rho_w \Delta z_{g(k)} \frac{\Delta w_{(k)}}{\Delta t_L} 
&=& F_{w(k+1/2)}^{\tau+1} - {F}_{w(k-1/2)}^{\tau+1} + S_{w(k)} \Delta z_{g(k)} \nonumber \\
&=& {F}_{w(k+1/2)}^{\tau} 
+\frac{\partial F_{w(k+1/2)}}{\partial w_{(k)}} 
 \Delta w_{(k)}
+\frac{\partial F_{w(k+1/2)}}{\partial w_{(k+1)}} 
 \Delta w_{(k+1)} \nonumber \\
&-& F_{w(k-1/2)}^{\tau}
-\frac{\partial F_{w(k-1/2)}}{\partial w_{(k-1)}} 
 \Delta w_{(k-1)}
-\frac{\partial F_{w(k-1/2)}}{\partial w_{(k-1)}} 
 \Delta w_{(k)} + S_{w(k)} \Delta z_{g(k)} 
\end{eqnarray}
のように扱い, $\Delta T_{g(k)}\ (k=1,\ldots,K_{g})$ についての
$K_{g}$ 本の連立方程式として LU 分解法により解く. 
この際, 土壌上端及び下端のフラックスは境界条件として固定して解くことに注
意されたい. 
\begin{equation}
 w_{(k)}^{\tau+1} = w_{(k)}^{\tau} + \Delta w_{(k)}
\end{equation}
により土壌水分量を更新する. 

この計算の結果, 土壌水分量が過飽和になる部分が生じた場合, 鉛直方向に調節
を行い, 過飽和を除去する. 
過飽和分を流出と見なさないのは, この過飽和が, 土壌水分の鉛直移動を飽和の
情報を持たずに解いたことによって生じた人工的なものだからである. 
まず, 土壌第２層から下に向かって, 過飽和分の土壌水分量を一つ下の層へ与え
る. 
次に, 土壌最下層から上へ向かって, 過飽和分の土壌水分量を一つ上の層へ与え
る. 
この操作により, 土壌水分が十分に大きい場合, 土壌最下層付近に飽和層が形成
され, (\ref{roff_table})の地下水面が定義できる. 

\subsection{土壌水分の相変化}

土壌中の熱伝導を計算した結果, 液体水分の存在する層の温度が $T_{melt} =
0^{\circ}$C を下回った場合, もしくは固体水分の存在する層の温度が
$T_{melt}$を上回った場合には土壌水分の相変化を計算する. 
すなわち, 第$k$層目の土壌水分の凍結量(調整分)を $\Delta w_{i(k)}$ とすると, 

$T_{g(k)}^*<T_{melt}$ かつ $w_{(k)}^{\tau+1}-w_{i(k)}^{\tau}>0$ のとき
(凍結)
\begin{equation}
\Delta w_{i(k)} = \min\left(
\frac{C_{g(k)}(T_{melt}-T_{g(k)}^*)}{l_m \rho_w \Delta z_{g(k)}}, \ 
w_{(k)}^{\tau+1}-w_{i(k)}^{\tau}
\right)
\end{equation}

$T_{g(k)}^*>T_{melt}$ かつ $w_{i(k)}^{\tau}>0$ のとき(融解)
\begin{equation}
\Delta w_{i(k)} = \max\left(
\frac{C_{g(k)}(T_{melt}-T_{g(k)}^*)}{l_m \rho_w \Delta z_{g(k)}}, \ 
-w_{i(k)}^{\tau}
\right)
\end{equation}

土壌凍結水分量と土壌温度を以下のように更新する. 
\begin{eqnarray}
w_{i(k)}^{\tau+1} &=& w_{i(k)}^{\tau} + \Delta w_{i(k)} \\
T_{g(k)}^{\tau+1} &=& T_{g(k)}^* + l_m \rho_w \Delta z_{g(k)} \Delta w_{i(k)} / C_{g(k)}
\end{eqnarray}

\subsubsection{氷床過程}

土地被覆タイプが氷床である場合, 土壌温度が $T_{melt}$ を越えたら
$T_{melt}$ に戻す. 
\begin{eqnarray}
 T_{g(k)}^{\tau+1} = \min( T_{g(k)}^*, \ T_{melt} )
\end{eqnarray}
このとき, 氷床量の変化率 $F_{ice}$を以下のように診断する. 
\begin{eqnarray}
 F_{ice} = - Et_{(2,1)} - \frac{C_{g(k)}\max(T_{g(k)}^* - T_{melt},\ 0)}{l_m \Delta t_L}
\end{eqnarray}

\subsection*{参考文献}

\begin{description}
 \item[] Ball, J. T., 1988: An analysis of stomatal
	    conductance. Ph.D. thesis, Stanford University, 89 pp. 
 \item[] Beven, K. J., and M. J. Kirkby, 1979: A physically based
	    variable contributing area model of basin hydrology,
	    {Hydrol. Sci. Bull.}, {\bf 24}, 43--69. 
 \item[] Clapp, R. B., and G. M. Hornberger, 1978: Empirical equations
	    for some soil hydraulic properties. {Water Resour. Res.},
	    {\bf 14}, 601--604. 
 \item[] Collatz, G. J., J. A. Berry, G. D. Farquhar, and J. Pierce,
	    1990: The relationship between the Rubisco reaction
	    mechanism and models of leaf photosynthesis. {Plant Cell
	    Environ.}, {\bf 13}, 219--225. 
 \item[] Collatz, G. J., J. T. Ball, C. Grivet, and J. A. Berry, 1991:
	    Physiological and environmental regulation of stomatal
	    conductance, photosynthesis and transpiration: A model that
	    includes a laminar boundary layer. {Agric. For. Meteor.},
	    {\bf 54}, 107--136. 
 \item[] Collatz, G. J., M. Ribas-Carbo, and J. A. Berry, 1992: Coupled
	    Photosynthesis-Stomatal Conductance Model for leaves of
	    C$_4$ plants. {Aust. J. Plant. Physiol.}, {\bf 19},
	    519--538. 
 \item[] Farquhar, G. D., S. von Caemmerer, and J. A. Berry, 1980: A
	    biochemical model of photosynthetic CO$_2$ fixation in
	    leaves of C$_3$ species. {Planta}, {\bf 149}, 78--90.
 \item[] Kondo, J., and T. Watanabe, 1992: Studies on the bulk transfer
	    coefficients over a vegetated surface with a multilayer
	    energy budget model. {J. Atmos. Sci}, {\bf 49}, 2183--2199. 
 \item[] Rutter, B., A. J. Morton, and P. C. Robins, 1975: A predictive
	    model of rainfall interception in forests. II. 
	    Generalization of the model and comparison with observations
	    in some coniferous and hardwood stands. {J. Appl. Ecol.},
	    {\bf 12}, 367--380. 
 \item[] Sellers, P. J., D. A. Randall, G. J. Collatz, J. A. Berry,
	    C. B. Field, D. A. Dazlich, C. Zhang, G. D. Collelo, and
	    L. Bounoua, 1996: A revised land surface parameterization
	    (SiB2) for atmospheric GCMs. Part I: Model formulation.
	    {J. Climate}, {\bf 9}, 676--705. 
 \item[] Sivapalan, M., K. Beven, and E. F. Wood, 1987: On hydrologic
	    similarity. 2, A scaled model of storm runoff
	    production. {Water Resour. Res}, {\bf 23}, 2266--2278. 
 \item[] Stieglitz, M., D. Rind, J. Famiglietti, and C. Rosenzweig,
	    1997: An efficient approach to modeling the topographic
	    control of surface hydrology for regional and global climate
	    modeling. {J. Climate}, {\bf 10}, 118--137. 
 \item[] Watanabe, T., 1994: Bulk parameterization for a vegetated
	    surface and its application to a simulation of nocturnal
	    drainage flow. {Boundary-Layer Met.}, {\bf 70}, 13--35.
 \item[] Wiscombe, W. J., and S. G. Warren, 1980: A model for the
	    spectral albedo of snow. I. Pure snow. {J. Atmos. Sci.},
	    {\bf 37}, 2712--2733. 
 \item[] 渡辺力・大谷義一, 1995: キャノピー層内の日射量分布の近似計算法.
	    {農業気象}, {\bf 51}, 57--60. 
\end{description}
\end{document}
